<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Bitcoin: src/Object/Network/NetworkCommunicator.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Bitcoin&#160;<span id="projectnumber">1.0</span></div>
   <div id="projectbrief">Bitcoin port</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('_network_communicator_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">src/Object/Network/NetworkCommunicator.c</div>  </div>
</div>
<div class="contents">
<a href="_network_communicator_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * NetworkCommunicator.c</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Created on: Nov 12, 2012</span>
<a name="l00005"></a>00005 <span class="comment"> * Created by: Wen Shen</span>
<a name="l00006"></a>00006 <span class="comment"> * Copyright (c) 2012 MIBitcoin Project Team</span>
<a name="l00007"></a>00007 <span class="comment"> */</span>
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="preprocessor">#include &quot;<a class="code" href="_network_communicator_8h.html" title="Used for communicating to other peers. The network communicator can send and receive bitcoin messages...">NetworkCommunicator.h</a>&quot;</span>
<a name="l00010"></a>00010 &lt;&lt;&lt;&lt;&lt;&lt;&lt; .mine
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="comment">/* Constructor */</span>
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <a class="code" href="_network_communicator_8h.html#ade3656a19e30036812203499b4812f28" title="Creates a new NetworkCommunicator object.">newNetworkCommunicator</a>(<span class="keywordtype">void</span> (*<a class="code" href="_network_communicator_8c.html#a274a1668db621d346da002d3024d30b3">onErrorReceived</a>)(<a class="code" href="_constants_8h.html#a2c3e4bb40f36b262a5214e2da2bca9c5">Error</a> error,<span class="keywordtype">char</span> *,...))
<a name="l00015"></a>00015 {
<a name="l00016"></a>00016         <a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span> = malloc(<span class="keyword">sizeof</span>(*<span class="keyword">self</span>));
<a name="l00017"></a>00017         <span class="keywordflow">if</span> (! <span class="keyword">self</span>) {
<a name="l00018"></a>00018                 <a class="code" href="_network_communicator_8c.html#a274a1668db621d346da002d3024d30b3">onErrorReceived</a>(<a class="code" href="_constants_8h.html#a2c3e4bb40f36b262a5214e2da2bca9c5ac0a554045048d2fb61387cf735676f69">ERROR_OUT_OF_MEMORY</a>,<span class="stringliteral">&quot;Cannot allocate %i bytes of memory in NewNetworkCommunicator\n&quot;</span>,<span class="keyword">sizeof</span>(*<span class="keyword">self</span>));
<a name="l00019"></a>00019                 <span class="keywordflow">return</span> NULL;
<a name="l00020"></a>00020         }
<a name="l00021"></a>00021         <a class="code" href="_object_8c.html#a8460165be167be3b0816d84f498e3733" title="Casts the pointer to the Object; use this to avoid explicitly casting.">getObject</a>(<span class="keyword">self</span>)-&gt;<a class="code" href="struct_object.html#aa353725933e843001d4feb03f8268121">destroy</a> = <a class="code" href="_network_communicator_8c.html#a0acd95f7a9f730706f52635ab7cd97e4" title="Frees a NetworkCommunicator object.">freeNetworkCommunicator</a>;
<a name="l00022"></a>00022         <span class="keywordflow">if</span> (<a class="code" href="_network_communicator_8h.html#a65f780bc52416886df200daaab88d925" title="Initialises a NetworkCommunicator object.">initNetworkCommunicator</a>(<span class="keyword">self</span>,<a class="code" href="_network_communicator_8c.html#a274a1668db621d346da002d3024d30b3">onErrorReceived</a>))
<a name="l00023"></a>00023                 <span class="keywordflow">return</span> <span class="keyword">self</span>;
<a name="l00024"></a>00024         free(<span class="keyword">self</span>);
<a name="l00025"></a>00025         <span class="keywordflow">return</span> NULL;
<a name="l00026"></a>00026 }
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="comment">/* Object Getter */</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <a class="code" href="_network_communicator_8h.html#a8f6b45a69dd016a1ce5bccb895ffb493" title="Gets a NetworkCommunicator from another object. Use this to avoid casts.">getNetworkCommunicator</a>(<span class="keywordtype">void</span> * <span class="keyword">self</span>){
<a name="l00031"></a>00031         <span class="keywordflow">return</span> <span class="keyword">self</span>;
<a name="l00032"></a>00032 }
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <span class="comment">/* Initialiser */</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="keywordtype">boolean</span> <a class="code" href="_network_communicator_8h.html#a65f780bc52416886df200daaab88d925" title="Initialises a NetworkCommunicator object.">initNetworkCommunicator</a>(<a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span>,<span class="keywordtype">void</span> (*<a class="code" href="_network_communicator_8c.html#a274a1668db621d346da002d3024d30b3">onErrorReceived</a>)(<a class="code" href="_constants_8h.html#a2c3e4bb40f36b262a5214e2da2bca9c5">Error</a> error,<span class="keywordtype">char</span> *,...)){
<a name="l00037"></a>00037         <span class="comment">/* Set fields. */</span>
<a name="l00038"></a>00038         <span class="keyword">self</span>-&gt;attemptingOrWorkingConnections = 0;
<a name="l00039"></a>00039         <span class="keyword">self</span>-&gt;numIncommingConnections = 0;
<a name="l00040"></a>00040         <span class="keyword">self</span>-&gt;eventLoop = 0;
<a name="l00041"></a>00041         <span class="keyword">self</span>-&gt;acceptEventIPv4 = 0;
<a name="l00042"></a><a class="code" href="_network_communicator_8c.html#acd9b07f4337d5cf163aba1aa3a313686">00042</a>         <span class="keyword">self</span>-&gt;acceptEventIPv6 = 0;
<a name="l00043"></a><a class="code" href="_network_communicator_8c.html#a2783970558fa86ffe994b4ac31eed7b0">00043</a>         <span class="keyword">self</span>-&gt;isListeningIPv4 = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l00044"></a><a class="code" href="_network_communicator_8c.html#a83fb590fe9a92b943b8189a8efa0135c">00044</a>         <span class="keyword">self</span>-&gt;isListeningIPv6 = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l00045"></a><a class="code" href="_network_communicator_8c.html#a7205498c8b149e4383a1abd02320d160">00045</a>         <span class="keyword">self</span>-&gt;ourIPv4 = NULL;
<a name="l00046"></a><a class="code" href="_network_communicator_8c.html#aad277806aa44c401c56f35d707fb5b16">00046</a>         <span class="keyword">self</span>-&gt;ourIPv6 = NULL;
<a name="l00047"></a><a class="code" href="_network_communicator_8c.html#a7c3c199980f55b77b5e58e00cddf229e">00047</a>         <span class="keyword">self</span>-&gt;pingTimer = 0;
<a name="l00048"></a><a class="code" href="_network_communicator_8c.html#a94e517b501423dce16ebb72944e08d72">00048</a>         <span class="keyword">self</span>-&gt;nounce = 0;
<a name="l00049"></a><a class="code" href="_network_communicator_8c.html#aa06fa27531568b80f756f8b6bc1aaf24">00049</a>         <span class="keyword">self</span>-&gt;stoppedListening = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l00050"></a><a class="code" href="_network_communicator_8c.html#a274a1668db621d346da002d3024d30b3">00050</a>         <span class="keyword">self</span>-&gt;onErrorReceived = <a class="code" href="_network_communicator_8c.html#a274a1668db621d346da002d3024d30b3">onErrorReceived</a>;
<a name="l00051"></a>00051         <span class="keywordflow">if</span> (! <a class="code" href="_object_8c.html#ac690ecc286260ebe898e15aeab89749c" title="Creates a new Object.">createNewObject</a>(<a class="code" href="_object_8c.html#a8460165be167be3b0816d84f498e3733" title="Casts the pointer to the Object; use this to avoid explicitly casting.">getObject</a>(<span class="keyword">self</span>)))
<a name="l00052"></a>00052                 <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l00053"></a><a class="code" href="_network_communicator_8c.html#a834713a9a17ec303f21e3dc4ecbe9161">00053</a>         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00054"></a>00054 }
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="comment">/*  Destructor */</span>
<a name="l00057"></a>00057 
<a name="l00058"></a><a class="code" href="_network_communicator_8h.html#a3b2f7c2930c98d80faaea453dbd41e83">00058</a> <span class="keywordtype">void</span> <a class="code" href="_network_communicator_8c.html#a0acd95f7a9f730706f52635ab7cd97e4" title="Frees a NetworkCommunicator object.">freeNetworkCommunicator</a>(<span class="keywordtype">void</span> * vself){
<a name="l00059"></a>00059         <span class="comment">/* When this is called all references to the object should be released, so no additional syncronisation is required */</span>
<a name="l00060"></a>00060         <a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span> = vself;
<a name="l00061"></a>00061         <span class="keywordflow">if</span> (self-&gt;isStarted)
<a name="l00062"></a>00062                 <a class="code" href="_network_communicator_8h.html#a41ae48cda40f96973d3aaffcdb7fc3f0" title="Closes all connections. This may be neccessary in case of failure in which case NetworkCommunicatorSt...">networkCommunicatorStop</a>(<span class="keyword">self</span>);
<a name="l00063"></a>00063         <span class="keywordflow">if</span> (self-&gt;alternativeMessages) <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(self-&gt;alternativeMessages);
<a name="l00064"></a>00064         <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(self-&gt;addresses);
<a name="l00065"></a>00065         <span class="keywordflow">if</span> (self-&gt;ourIPv4) <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(self-&gt;ourIPv4);
<a name="l00066"></a>00066         <span class="keywordflow">if</span> (self-&gt;ourIPv6) <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(self-&gt;ourIPv6);
<a name="l00067"></a>00067         free(self-&gt;altMaxSizes);
<a name="l00068"></a>00068         <a class="code" href="_object_8c.html#a9773962d80072e39e235802b57907208" title="destructor">destroyObject</a>(<span class="keyword">self</span>);
<a name="l00069"></a>00069 }
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="comment">/*  Functions */</span>
<a name="l00072"></a>00072 
<a name="l00073"></a><a class="code" href="_network_communicator_8h.html#aded9961c1a68b927766a104314c54590">00073</a> <span class="keywordtype">void</span> <a class="code" href="_network_communicator_8c.html#aded9961c1a68b927766a104314c54590" title="Accepts an incomming connection.">acceptNetworkCommunicatorConnection</a>(<span class="keywordtype">void</span> * vself,uint64_t socket){
<a name="l00074"></a>00074         <a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span> = vself;
<a name="l00075"></a>00075         uint64_t connectSocketID;
<a name="l00076"></a>00076         <span class="keywordflow">if</span> (! socketAccept(socket, &amp;connectSocketID))
<a name="l00077"></a>00077                 <span class="keywordflow">return</span>;
<a name="l00078"></a>00078         <span class="comment">/* Connected, add NetworkAddress */</span>
<a name="l00079"></a>00079         <a class="code" href="struct_peer.html" title="Structure for Peer objects.">Peer</a> * peer = <a class="code" href="_peer_8c.html#a9a43832d7e175059540bea094dc86df1" title="Creates a new Peer object.">createNewNodeByTakingNetworkAddress</a>(newNetworkAddress(0, NULL, 0, 0, self-&gt;onErrorReceived));
<a name="l00080"></a>00080         <span class="keywordflow">if</span> (! peer)
<a name="l00081"></a>00081                 <span class="keywordflow">return</span>;
<a name="l00082"></a>00082         peer-&gt;<a class="code" href="struct_peer.html#ab858e455737ef40c2849eb174bb2bdc0">incomming</a> = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00083"></a>00083         peer-&gt;<a class="code" href="struct_peer.html#a647a5a5d74637603d6c684e22f0a69b7">socketID</a> = connectSocketID;
<a name="l00084"></a>00084         peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a6b5d45c74743b18c5191ca991c8424ba">MESSAGE_TYPE_VERSION</a>; <span class="comment">/* The peer connected to us, we want the version from them. */</span>
<a name="l00085"></a>00085         <span class="comment">/* Set up receive event */</span>
<a name="l00086"></a>00086         <span class="keywordflow">if</span> (<a class="code" href="_libev_sockets_8h.html#ad36ca96ed4c6c081ffbd348a5d4c4d07">canReceive</a>(&amp;peer-&gt;<a class="code" href="struct_peer.html#a85ce08843ff1aa2d229844758849e4d0">receiveEvent</a>,self-&gt;eventLoop,peer-&gt;<a class="code" href="struct_peer.html#a647a5a5d74637603d6c684e22f0a69b7">socketID</a>, <a class="code" href="_network_communicator_8h.html#a23b0b97e4bf8b96257a811485ce9d1d2" title="Called when a peer socket is ready for reading.">networkCommunicatorOnCanReceive</a>, peer)) {
<a name="l00087"></a>00087                 <span class="comment">/* The event works*/</span>
<a name="l00088"></a>00088                 <span class="keywordflow">if</span>(SocketAddEvent(peer-&gt;<a class="code" href="struct_peer.html#a85ce08843ff1aa2d229844758849e4d0">receiveEvent</a>, self-&gt;responseTimeOut)){ <span class="comment">/* Begin receive event.*/</span>
<a name="l00089"></a>00089                         <span class="comment">// Success</span>
<a name="l00090"></a>00090                         <span class="keywordflow">if</span> (<a class="code" href="_libev_sockets_8h.html#a808507af219de87eb1dac4c665868b52">canSend</a>(&amp;peer-&gt;<a class="code" href="struct_peer.html#a69ff2e0990f9ab719a6747dcc613ef80">sendEvent</a>,self-&gt;eventLoop, peer-&gt;<a class="code" href="struct_peer.html#a647a5a5d74637603d6c684e22f0a69b7">socketID</a>, <a class="code" href="_network_communicator_8h.html#a958af2548aed14b08f1b64e9ef01a92c" title="Called when a peer socket is ready for writing.">networkCommunicatorOnCanSend</a>, peer)) {
<a name="l00091"></a>00091                                 <span class="comment">// Both onErrorReceived work. Take the peer.</span>
<a name="l00092"></a>00092                                 <span class="keywordflow">if</span> (AddressManagerTakePeer(self-&gt;addresses, peer)){
<a name="l00093"></a>00093                                         <span class="keywordflow">if</span> (self-&gt;addresses-&gt;peersNum == 1 &amp;&amp; self-&gt;flags &amp; <a class="code" href="_constants_8h.html#a6f2291d55f4d124937956e160c5d9792af3482f3aaa575c480963d097692c9ba4">NETWORK_COMMUNICATOR_AUTO_PING</a>)
<a name="l00094"></a>00094                                                 <span class="comment">// Got first peer, start pings</span>
<a name="l00095"></a>00095                                                 <a class="code" href="_network_communicator_8h.html#a3582cbe16e5f8039ef71ed2f8ec2857b" title="Starts the timer event for sending pings (heartbeat).">networkCommunicatorStartPings</a>(<span class="keyword">self</span>);
<a name="l00096"></a>00096                                         peer-&gt;<a class="code" href="struct_peer.html#a18a0713e05085b981e0db8b862af7e3c">connectionWorking</a> = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00097"></a>00097                                         <span class="keyword">self</span>-&gt;attemptingOrWorkingConnections++;
<a name="l00098"></a>00098                                         <span class="keyword">self</span>-&gt;numIncommingConnections++;
<a name="l00099"></a>00099                                         <span class="keywordflow">if</span> (self-&gt;numIncommingConnections == self-&gt;maxIncommingConnections || self-&gt;attemptingOrWorkingConnections == self-&gt;maxConnections) {
<a name="l00100"></a>00100                                                 <span class="comment">/* Reached maximum connections, stop listening. */</span>
<a name="l00101"></a>00101                                                 <a class="code" href="_network_communicator_8h.html#aab6f92b01ec3c352e6d73e5a7ba958ef" title="Stops listening for both IPv6 connections and IPv4 connections.">networkCommunicatorStopListening</a>(<span class="keyword">self</span>);
<a name="l00102"></a>00102                                                 <span class="keyword">self</span>-&gt;stoppedListening = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00103"></a>00103                                         }
<a name="l00104"></a>00104                                         <span class="keywordflow">return</span>;
<a name="l00105"></a>00105                                 }
<a name="l00106"></a>00106                         }
<a name="l00107"></a>00107                 }
<a name="l00108"></a>00108                 <span class="comment">/* Could create receive event but there was a failure afterwards so free it. */</span>
<a name="l00109"></a>00109                 SocketFreeEvent(peer-&gt;<a class="code" href="struct_peer.html#a85ce08843ff1aa2d229844758849e4d0">receiveEvent</a>);
<a name="l00110"></a>00110         }
<a name="l00111"></a>00111         <span class="comment">/*Failure, release peer. */</span>
<a name="l00112"></a>00112         CloseSocket(connectSocketID);
<a name="l00113"></a>00113         <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(peer);
<a name="l00114"></a>00114 }
<a name="l00115"></a><a class="code" href="_network_communicator_8c.html#af58f7467f49c22bab01296912d93c41c">00115</a> <a class="code" href="_constants_8h.html#a54234ee76fe51e3623e3e2b2fb450032">ConnectionReturn</a> <a class="code" href="_network_communicator_8c.html#af58f7467f49c22bab01296912d93c41c">NetworkCommunicatorConnect</a>(<a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span>,<a class="code" href="struct_peer.html" title="Structure for Peer objects.">Peer</a> * peer){
<a name="l00116"></a>00116         <span class="keywordflow">if</span> (! AddressManagerIsReachable(self-&gt;addresses, <a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(peer)-&gt;type))
<a name="l00117"></a>00117                 <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a54234ee76fe51e3623e3e2b2fb450032ad019b3a966ffc44184d51321978831bf">CONNECT_NO_SUPPORT</a>;
<a name="l00118"></a>00118         <span class="keywordtype">boolean</span> isIPv6 = <a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(peer)-&gt;<a class="code" href="struct_network_address.html#a5568ed4dd65aedfed84459bd34350ddb">type</a> &amp; <a class="code" href="_constants_8h.html#aadb1cfb5fcd8adc562a07248be433d45a5c7c7aafd5c7ea542e80fa0367abe957">IP_IPv6</a>;
<a name="l00119"></a>00119         <span class="comment">// Make socket</span>
<a name="l00120"></a>00120         <a class="code" href="_constants_8h.html#aafaa708c6525147dd9cf77b255313148">SocketReturn</a> res = NewSocket(&amp;peer-&gt;<a class="code" href="struct_peer.html#a647a5a5d74637603d6c684e22f0a69b7">socketID</a>, isIPv6);
<a name="l00121"></a>00121         <span class="keywordflow">if</span>(res == <a class="code" href="_constants_8h.html#aafaa708c6525147dd9cf77b255313148ad6212ebe97ac2c0d422e4c3f0294ea77">SOCKET_NO_SUPPORT</a>){
<a name="l00122"></a>00122                 <span class="keywordflow">if</span> (isIPv6) AddressManagerSetReachability(self-&gt;addresses, <a class="code" href="_constants_8h.html#aadb1cfb5fcd8adc562a07248be433d45a5c7c7aafd5c7ea542e80fa0367abe957">IP_IPv6</a>, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l00123"></a>00123                 <span class="keywordflow">else</span> AddressManagerSetReachability(self-&gt;addresses, <a class="code" href="_constants_8h.html#aadb1cfb5fcd8adc562a07248be433d45ada1efeae8e474dedf665973081167ec3">IP_IPv4</a>, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l00124"></a>00124                 <span class="keywordflow">if</span> (! AddressManagerIsReachable(self-&gt;addresses, <a class="code" href="_constants_8h.html#aadb1cfb5fcd8adc562a07248be433d45a5c7c7aafd5c7ea542e80fa0367abe957">IP_IPv6</a> | <a class="code" href="_constants_8h.html#aadb1cfb5fcd8adc562a07248be433d45ada1efeae8e474dedf665973081167ec3">IP_IPv4</a>))
<a name="l00125"></a>00125                         <span class="comment">// IPv6 and IPv4 not reachable.</span>
<a name="l00126"></a>00126                         <span class="keyword">self</span>-&gt;onNetworkError(self-&gt;callbackHandler,<span class="keyword">self</span>);
<a name="l00127"></a>00127                 <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a54234ee76fe51e3623e3e2b2fb450032ad019b3a966ffc44184d51321978831bf">CONNECT_NO_SUPPORT</a>;
<a name="l00128"></a>00128         }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == <a class="code" href="_constants_8h.html#aafaa708c6525147dd9cf77b255313148a9efe0fce4ec7e78984619166b40c4da9">SOCKET_BAD</a>) {
<a name="l00129"></a>00129                 <span class="keywordflow">if</span> (! self-&gt;addresses-&gt;peersNum) {
<a name="l00130"></a>00130                         <span class="keyword">self</span>-&gt;onNetworkError(self-&gt;callbackHandler,<span class="keyword">self</span>);
<a name="l00131"></a>00131                 }
<a name="l00132"></a>00132                 <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a54234ee76fe51e3623e3e2b2fb450032a08463f1cee9a7f800ff2af2fe43f837d">CONNECT_FAIL</a>;
<a name="l00133"></a>00133         }
<a name="l00134"></a>00134         <span class="comment">// Connect</span>
<a name="l00135"></a>00135         <span class="keywordflow">if</span>(SocketConnect(peer-&gt;<a class="code" href="struct_peer.html#a647a5a5d74637603d6c684e22f0a69b7">socketID</a>, ByteArrayGetData(<a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(peer)-&gt;ip), isIPv6, <a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(peer)-&gt;port)){
<a name="l00136"></a>00136                 <span class="comment">// Add event for connection</span>
<a name="l00137"></a>00137                 <span class="keywordflow">if</span> (SocketDidConnectEvent(&amp;peer-&gt;<a class="code" href="struct_peer.html#a8bdddd94977094b311762091fb792af9">connectEvent</a>,self-&gt;eventLoop, peer-&gt;<a class="code" href="struct_peer.html#a647a5a5d74637603d6c684e22f0a69b7">socketID</a>, <a class="code" href="_network_communicator_8c.html#a01b2fbdac7b86ad9f640ab3f02d0845b">NetworkCommunicatorDidConnect</a>, peer)) {
<a name="l00138"></a>00138                         <span class="keywordflow">if</span> (SocketAddEvent(peer-&gt;<a class="code" href="struct_peer.html#a8bdddd94977094b311762091fb792af9">connectEvent</a>, self-&gt;connectionTimeOut)) {
<a name="l00139"></a>00139                                 <span class="comment">// Connection is fine. Retain for waiting for connect.</span>
<a name="l00140"></a>00140                                 RetainObject(peer);
<a name="l00141"></a>00141                                 <span class="keyword">self</span>-&gt;attemptingOrWorkingConnections++;
<a name="l00142"></a>00142                                 <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a54234ee76fe51e3623e3e2b2fb450032a2fd593ba89118192965ebc9d11660330">CONNECT_OK</a>;
<a name="l00143"></a>00143                         }<span class="keywordflow">else</span>
<a name="l00144"></a>00144                                 SocketFreeEvent(peer-&gt;<a class="code" href="struct_peer.html#a8bdddd94977094b311762091fb792af9">connectEvent</a>);
<a name="l00145"></a>00145                 }
<a name="l00146"></a>00146                 CloseSocket(peer-&gt;<a class="code" href="struct_peer.html#a647a5a5d74637603d6c684e22f0a69b7">socketID</a>);
<a name="l00147"></a>00147                 <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a54234ee76fe51e3623e3e2b2fb450032a08463f1cee9a7f800ff2af2fe43f837d">CONNECT_FAIL</a>;
<a name="l00148"></a>00148         }
<a name="l00149"></a>00149         CloseSocket(peer-&gt;<a class="code" href="struct_peer.html#a647a5a5d74637603d6c684e22f0a69b7">socketID</a>);
<a name="l00150"></a>00150         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a54234ee76fe51e3623e3e2b2fb450032adb412025e19414ff840a039ceeb47672">CONNECT_BAD</a>;
<a name="l00151"></a>00151 }
<a name="l00152"></a><a class="code" href="_network_communicator_8c.html#a01b2fbdac7b86ad9f640ab3f02d0845b">00152</a> <span class="keywordtype">void</span> <a class="code" href="_network_communicator_8c.html#a01b2fbdac7b86ad9f640ab3f02d0845b">NetworkCommunicatorDidConnect</a>(<span class="keywordtype">void</span> * vself,<span class="keywordtype">void</span> * vpeer){
<a name="l00153"></a>00153         <a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span> = vself;
<a name="l00154"></a>00154         <a class="code" href="struct_peer.html" title="Structure for Peer objects.">Peer</a> * peer = vpeer;
<a name="l00155"></a>00155         SocketFreeEvent(peer-&gt;<a class="code" href="struct_peer.html#a8bdddd94977094b311762091fb792af9">connectEvent</a>); <span class="comment">// No longer need this event.</span>
<a name="l00156"></a>00156         <span class="comment">// Check to see if in the meantime, that we have not been connected to by the peer. Double connections are bad m&#39;kay.</span>
<a name="l00157"></a>00157         <span class="keywordflow">if</span> (! AddressManagerGotNode(self-&gt;addresses, <a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(peer))){
<a name="l00158"></a>00158                 <span class="comment">// Make receive event</span>
<a name="l00159"></a>00159                 <span class="keywordflow">if</span> (<a class="code" href="_libev_sockets_8h.html#ad36ca96ed4c6c081ffbd348a5d4c4d07">canReceive</a>(&amp;peer-&gt;<a class="code" href="struct_peer.html#a85ce08843ff1aa2d229844758849e4d0">receiveEvent</a>,self-&gt;eventLoop, peer-&gt;<a class="code" href="struct_peer.html#a647a5a5d74637603d6c684e22f0a69b7">socketID</a>, <a class="code" href="_network_communicator_8c.html#a46f71a041685b462e8c1b738e7ed6915">NetworkCommunicatorOnCanReceive</a>, peer)) {
<a name="l00160"></a>00160                         <span class="comment">// Make send event</span>
<a name="l00161"></a>00161                         <span class="keywordflow">if</span> (<a class="code" href="_libev_sockets_8h.html#a808507af219de87eb1dac4c665868b52">canSend</a>(&amp;peer-&gt;<a class="code" href="struct_peer.html#a69ff2e0990f9ab719a6747dcc613ef80">sendEvent</a>,self-&gt;eventLoop, peer-&gt;<a class="code" href="struct_peer.html#a647a5a5d74637603d6c684e22f0a69b7">socketID</a>, <a class="code" href="_network_communicator_8c.html#afb4864bcc2ab71e022d0c89c069163e1">NetworkCommunicatorOnCanSend</a>, peer)) {
<a name="l00162"></a>00162                                 <span class="keywordflow">if</span> (SocketAddEvent(peer-&gt;<a class="code" href="struct_peer.html#a69ff2e0990f9ab719a6747dcc613ef80">sendEvent</a>, self-&gt;sendTimeOut)) {
<a name="l00163"></a>00163                                         <span class="keywordflow">if</span>(AddressManagerTakePeer(self-&gt;addresses, peer)){
<a name="l00164"></a>00164                                                 <span class="keywordflow">if</span> (self-&gt;addresses-&gt;peersNum == 1 &amp;&amp; self-&gt;flags &amp; <a class="code" href="_constants_8h.html#a6f2291d55f4d124937956e160c5d9792af3482f3aaa575c480963d097692c9ba4">NETWORK_COMMUNICATOR_AUTO_PING</a>)
<a name="l00165"></a>00165                                                         <span class="comment">// Got first peer, start pings</span>
<a name="l00166"></a>00166                                                         <a class="code" href="_network_communicator_8c.html#ac474e8dd4fb72e26eaf3cb0b0d716e21">NetworkCommunicatorStartPings</a>(<span class="keyword">self</span>);
<a name="l00167"></a>00167                                                 peer-&gt;<a class="code" href="struct_peer.html#a18a0713e05085b981e0db8b862af7e3c">connectionWorking</a> = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00168"></a>00168                                                 <span class="comment">// Connection OK, so begin handshake if auto handshaking is enabled.</span>
<a name="l00169"></a>00169                                                 <span class="keywordtype">boolean</span> fail = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l00170"></a>00170                                                 <span class="keywordflow">if</span> (self-&gt;flags &amp; <a class="code" href="_constants_8h.html#a6f2291d55f4d124937956e160c5d9792a6405a3fe5f130506115dbb845a516cbf">NETWORK_COMMUNICATOR_AUTO_HANDSHAKE</a>){
<a name="l00171"></a>00171                                                         <a class="code" href="struct_version.html" title="Structure for Version objects.">Version</a> * version = <a class="code" href="_network_communicator_8c.html#ade16d475138752b748b0e6568c1c2cf6">NetworkCommunicatorGetVersion</a>(<span class="keyword">self</span>,<a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(peer));
<a name="l00172"></a>00172                                                         <span class="keywordflow">if</span> (version) {
<a name="l00173"></a>00173                                                                 <a class="code" href="_message_8c.html#a9ab128ae9cafefd9b05e2e0bfa719770" title="getter">getMessage</a>(version)-&gt;<a class="code" href="struct_message.html#accc3616411ea4a5035a7eaf42132d370">expectResponse</a> = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ab04a1ce83c41d3c309a7e88c5e0c6d14">MESSAGE_TYPE_VERACK</a>; <span class="comment">// Expect a response for this message.</span>
<a name="l00174"></a>00174                                                                 <a class="code" href="_message_8c.html#a9ab128ae9cafefd9b05e2e0bfa719770" title="getter">getMessage</a>(version)-&gt;<a class="code" href="struct_message.html#a8a2053c7fb1adf60da2f26c06059539e">type</a> = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a6b5d45c74743b18c5191ca991c8424ba">MESSAGE_TYPE_VERSION</a>;
<a name="l00175"></a>00175                                                                 peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ab04a1ce83c41d3c309a7e88c5e0c6d14">MESSAGE_TYPE_VERACK</a>; <span class="comment">// Accept the acknowledgement.</span>
<a name="l00176"></a>00176                                                                 <a class="code" href="_network_communicator_8c.html#a67b0329d1c08b164bc3b255bd412e355">NetworkCommunicatorSendMessage</a>(<span class="keyword">self</span>, peer, <a class="code" href="_message_8c.html#a9ab128ae9cafefd9b05e2e0bfa719770" title="getter">getMessage</a>(version));
<a name="l00177"></a>00177                                                                 <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(version);
<a name="l00178"></a>00178                                                                 peer-&gt;<a class="code" href="struct_peer.html#ac772b4b3b557f31cbb8ddbbabdcca45a">versionSent</a> = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00179"></a>00179                                                         }<span class="keywordflow">else</span>
<a name="l00180"></a>00180                                                                 fail = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00181"></a>00181                                                 }
<a name="l00182"></a>00182                                                 <span class="keywordflow">if</span> (! fail)
<a name="l00183"></a>00183                                                         <span class="keywordflow">return</span>;
<a name="l00184"></a>00184                                         }
<a name="l00185"></a>00185                                 }
<a name="l00186"></a>00186                                 SocketFreeEvent(peer-&gt;<a class="code" href="struct_peer.html#a69ff2e0990f9ab719a6747dcc613ef80">sendEvent</a>);
<a name="l00187"></a>00187                         }
<a name="l00188"></a>00188                         SocketFreeEvent(peer-&gt;<a class="code" href="struct_peer.html#a85ce08843ff1aa2d229844758849e4d0">receiveEvent</a>);
<a name="l00189"></a>00189                 }
<a name="l00190"></a>00190         }
<a name="l00191"></a>00191         <span class="comment">// Close socket on failure</span>
<a name="l00192"></a>00192         CloseSocket(peer-&gt;<a class="code" href="struct_peer.html#a647a5a5d74637603d6c684e22f0a69b7">socketID</a>);
<a name="l00193"></a>00193         <span class="keyword">self</span>-&gt;attemptingOrWorkingConnections--;
<a name="l00194"></a>00194         <span class="keywordflow">if</span> (! self-&gt;attemptingOrWorkingConnections) {
<a name="l00195"></a>00195                 <span class="keyword">self</span>-&gt;onNetworkError(self-&gt;callbackHandler,<span class="keyword">self</span>);
<a name="l00196"></a>00196         }
<a name="l00197"></a>00197         <span class="keywordflow">if</span> (<a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(peer)-&gt;<span class="keyword">public</span>){
<a name="l00198"></a>00198                 <span class="comment">// No penalty here since it was definitely our fault.</span>
<a name="l00199"></a>00199                 <a class="code" href="struct_network_address.html" title="Structure for NetworkAddress objects.">NetworkAddress</a> * addr = realloc(peer, <span class="keyword">sizeof</span>(<a class="code" href="struct_network_address.html" title="Structure for NetworkAddress objects.">NetworkAddress</a>));
<a name="l00200"></a>00200                 <span class="keywordflow">if</span> (addr)
<a name="l00201"></a>00201                         AddressManagerTakeAddress(self-&gt;addresses, addr);
<a name="l00202"></a>00202         }<span class="keywordflow">else</span>
<a name="l00203"></a>00203                 <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(peer);
<a name="l00204"></a>00204 }
<a name="l00205"></a><a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">00205</a> <span class="keywordtype">void</span> <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span>,<a class="code" href="struct_peer.html" title="Structure for Peer objects.">Peer</a> * peer,uint16_t penalty,<span class="keywordtype">boolean</span> stopping){
<a name="l00206"></a>00206         <span class="comment">// Apply the penalty given</span>
<a name="l00207"></a>00207         <a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(peer)-&gt;<a class="code" href="struct_network_address.html#abe902382ebcf927bbba5c0d47bf53138">score</a> -= penalty;
<a name="l00208"></a>00208         <span class="comment">// Free onErrorReceived if they exist</span>
<a name="l00209"></a>00209         <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#a85ce08843ff1aa2d229844758849e4d0">receiveEvent</a>) SocketFreeEvent(peer-&gt;<a class="code" href="struct_peer.html#a85ce08843ff1aa2d229844758849e4d0">receiveEvent</a>);
<a name="l00210"></a>00210         <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#a69ff2e0990f9ab719a6747dcc613ef80">sendEvent</a>) SocketFreeEvent(peer-&gt;<a class="code" href="struct_peer.html#a69ff2e0990f9ab719a6747dcc613ef80">sendEvent</a>);
<a name="l00211"></a>00211         <span class="comment">// Close the socket</span>
<a name="l00212"></a>00212         CloseSocket(peer-&gt;<a class="code" href="struct_peer.html#a647a5a5d74637603d6c684e22f0a69b7">socketID</a>);
<a name="l00213"></a>00213         <span class="comment">// Release the receiving message object if it exists.</span>
<a name="l00214"></a>00214         <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>) <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>);
<a name="l00215"></a>00215         <span class="comment">// Release all messages in the send queue</span>
<a name="l00216"></a>00216         <span class="keywordflow">for</span> (uint8_t x = 0; x &lt; peer-&gt;<a class="code" href="struct_peer.html#a174a94f3843e505bba89c449f91c278d">sendQueueSize</a>; x++)
<a name="l00217"></a>00217                 <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(peer-&gt;<a class="code" href="struct_peer.html#a9f5dd03f71df9908687cab39f0b3d246">sendQueue</a>[(peer-&gt;<a class="code" href="struct_peer.html#a5de2ec8c298b8207f0b15baea86f67de">sendQueueFront</a> + x) % _SEND_QUEUEMAX_SIZE]);
<a name="l00218"></a>00218         <span class="comment">// If incomming, lower the incomming connections number</span>
<a name="l00219"></a>00219         <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#ab858e455737ef40c2849eb174bb2bdc0">incomming</a>)
<a name="l00220"></a>00220                 <span class="keyword">self</span>-&gt;numIncommingConnections--;
<a name="l00221"></a>00221         <span class="keywordflow">if</span> (self-&gt;stoppedListening &amp;&amp; self-&gt;numIncommingConnections &lt; self-&gt;maxIncommingConnections)
<a name="l00222"></a>00222                 <span class="comment">// Start listening again</span>
<a name="l00223"></a>00223                 <a class="code" href="_network_communicator_8c.html#ae0151ae192e007cb81d3ad7beaf1f5f8">NetworkCommunicatorStartListening</a>(<span class="keyword">self</span>);
<a name="l00224"></a>00224         <span class="comment">// Lower the attempting or working connections number</span>
<a name="l00225"></a>00225         <span class="keyword">self</span>-&gt;attemptingOrWorkingConnections--;
<a name="l00226"></a>00226         <span class="comment">// If this is a working connection, remove from the address manager.</span>
<a name="l00227"></a>00227         <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#a18a0713e05085b981e0db8b862af7e3c">connectionWorking</a>)
<a name="l00228"></a>00228                 AddressManagerRemoveNode(self-&gt;addresses, peer);
<a name="l00229"></a>00229         <span class="keywordflow">else</span>{
<a name="l00230"></a>00230                 <span class="comment">// Else we release the object from control of the NetworkCommunicator</span>
<a name="l00231"></a>00231                 SocketFreeEvent(peer-&gt;<a class="code" href="struct_peer.html#a8bdddd94977094b311762091fb792af9">connectEvent</a>);
<a name="l00232"></a>00232                 <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(peer);
<a name="l00233"></a>00233         }
<a name="l00234"></a>00234         <span class="keywordflow">if</span> (self-&gt;addresses-&gt;peersNum == 0 &amp;&amp; self-&gt;flags &amp; <a class="code" href="_constants_8h.html#a6f2291d55f4d124937956e160c5d9792af3482f3aaa575c480963d097692c9ba4">NETWORK_COMMUNICATOR_AUTO_PING</a>)
<a name="l00235"></a>00235                 <span class="comment">// No more peers so stop pings</span>
<a name="l00236"></a>00236                 <a class="code" href="_network_communicator_8c.html#ae1cb0933af1eb4fd1f53284066eff467">NetworkCommunicatorStopPings</a>(<span class="keyword">self</span>);
<a name="l00237"></a>00237         <span class="keywordflow">if</span> (! self-&gt;attemptingOrWorkingConnections &amp;&amp; ! stopping)
<a name="l00238"></a>00238                 <span class="comment">// No more connections so give a network error</span>
<a name="l00239"></a>00239                 <span class="keyword">self</span>-&gt;onNetworkError(self-&gt;callbackHandler,<span class="keyword">self</span>);
<a name="l00240"></a>00240 }
<a name="l00241"></a><a class="code" href="_network_communicator_8c.html#ade16d475138752b748b0e6568c1c2cf6">00241</a> <a class="code" href="struct_version.html" title="Structure for Version objects.">Version</a> * <a class="code" href="_network_communicator_8c.html#ade16d475138752b748b0e6568c1c2cf6">NetworkCommunicatorGetVersion</a>(<a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span>,<a class="code" href="struct_network_address.html" title="Structure for NetworkAddress objects.">NetworkAddress</a> * addRecv){
<a name="l00242"></a>00242         <a class="code" href="struct_network_address.html" title="Structure for NetworkAddress objects.">NetworkAddress</a> * sourceAddr;
<a name="l00243"></a>00243         <span class="keywordflow">if</span> (addRecv-&gt;<a class="code" href="struct_network_address.html#a5568ed4dd65aedfed84459bd34350ddb">type</a> &amp; <a class="code" href="_constants_8h.html#aadb1cfb5fcd8adc562a07248be433d45a5c7c7aafd5c7ea542e80fa0367abe957">IP_IPv6</a>
<a name="l00244"></a>00244                 &amp;&amp; self-&gt;ourIPv6)
<a name="l00245"></a>00245                 sourceAddr = <span class="keyword">self</span>-&gt;ourIPv6;
<a name="l00246"></a>00246         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (self-&gt;ourIPv4)
<a name="l00247"></a>00247                 sourceAddr = <span class="keyword">self</span>-&gt;ourIPv4;
<a name="l00248"></a>00248         <span class="keyword">self</span>-&gt;nounce = rand();
<a name="l00249"></a>00249         <a class="code" href="struct_version.html" title="Structure for Version objects.">Version</a> * version = NewVersion(self-&gt;version, self-&gt;services, time(NULL), addRecv, sourceAddr, self-&gt;nounce, self-&gt;userAgent, self-&gt;blockHeight, self-&gt;onErrorReceived);
<a name="l00250"></a>00250         <span class="keywordflow">return</span> version;
<a name="l00251"></a>00251 }
<a name="l00252"></a><a class="code" href="_network_communicator_8c.html#ac2d57ca1c8882c561500536901bd2ddd">00252</a> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33">OnMessageReceivedAction</a> <a class="code" href="_network_communicator_8c.html#ac2d57ca1c8882c561500536901bd2ddd">NetworkCommunicatorProcessMessageAutoDiscovery</a>(<a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span>,<a class="code" href="struct_peer.html" title="Structure for Peer objects.">Peer</a> * peer){
<a name="l00253"></a>00253         <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#a8a2053c7fb1adf60da2f26c06059539e">type</a> == <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a1ca0c8f3ae33849b0a2c940aa99b4d19">MESSAGE_TYPE_ADDR</a>) {
<a name="l00254"></a>00254                 <span class="comment">// Received addresses.</span>
<a name="l00255"></a>00255                 <a class="code" href="struct_address_broadcast.html" title="Structure for AddressBroadcast objects.">AddressBroadcast</a> * addrs = GetAddressBroadcast(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>);
<a name="l00256"></a>00256                 <span class="comment">// Only accept no timestaps when we have less than 100 addresses.</span>
<a name="l00257"></a>00257                 <span class="keywordflow">if</span>(peer-&gt;<a class="code" href="struct_peer.html#a3621dcfbd15278c25b8bc1279eab0f61">versionMessage</a>-&gt;<a class="code" href="struct_version.html#a67fae7dd1de9edce3656ed214d20377f">version</a> &lt; _ADDR_TIME_VERSION
<a name="l00258"></a>00258                    &amp;&amp; AddressManagerGetNumberOfAddresses(self-&gt;addresses) &gt; 1000)
<a name="l00259"></a>00259                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a73f6aac48ce0c9115366c60c688b2519">MESSAGE_ACTION_CONTINUE</a>;
<a name="l00260"></a>00260                 <span class="comment">// Store addresses.</span>
<a name="l00261"></a>00261                 uint64_t now = time(NULL) + <span class="keyword">self</span>-&gt;addresses-&gt;networkTimeOffset;
<a name="l00262"></a>00262                 <span class="comment">// Loop through addresses</span>
<a name="l00263"></a>00263                 <span class="keywordtype">boolean</span> didAdd = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>; <span class="comment">// True when we add an address.</span>
<a name="l00264"></a>00264                 <span class="keywordflow">for</span> (uint16_t x = 0; x &lt; addrs-&gt;<a class="code" href="struct_address_broadcast.html#a02583d0b0d5e7c0a314ff9b9493a6644">addrNum</a>; x++) {
<a name="l00265"></a>00265                         <span class="comment">// Check if we have the address as a connected peer</span>
<a name="l00266"></a>00266                         <a class="code" href="struct_peer.html" title="Structure for Peer objects.">Peer</a> * peerB = AddressManagerGotNode(self-&gt;addresses,addrs-&gt;<a class="code" href="struct_address_broadcast.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>[x]);
<a name="l00267"></a>00267                         <span class="keywordflow">if</span>(! peerB){
<a name="l00268"></a>00268                                 <span class="comment">// Do not already have this address as a peer</span>
<a name="l00269"></a>00269                                 <span class="keywordflow">if</span> (addrs-&gt;<a class="code" href="struct_address_broadcast.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>[x]-&gt;<a class="code" href="struct_network_address.html#a5568ed4dd65aedfed84459bd34350ddb">type</a> &amp; _IP_INVALID)
<a name="l00270"></a>00270                                         <span class="comment">// Address broadcasts should not contain invalid addresses.</span>
<a name="l00271"></a>00271                                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a5ae2d7b83bef3af8a31290ab530223f9">MESSAGE_ACTION_DISCONNECT</a>;
<a name="l00272"></a>00272                                 <span class="keywordflow">if</span> (addrs-&gt;<a class="code" href="struct_address_broadcast.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>[x]-&gt;<a class="code" href="struct_network_address.html#a5568ed4dd65aedfed84459bd34350ddb">type</a> &amp; <a class="code" href="_constants_8h.html#aadb1cfb5fcd8adc562a07248be433d45a843ba99ebefa69343b980604fbe93a31">IP_LOCAL</a> &amp;&amp; ! (<a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(peer)-&gt;type &amp; <a class="code" href="_constants_8h.html#aadb1cfb5fcd8adc562a07248be433d45a843ba99ebefa69343b980604fbe93a31">IP_LOCAL</a>))
<a name="l00273"></a>00273                                         <span class="comment">// Do not allow peers to send local addresses to non-local peers.</span>
<a name="l00274"></a>00274                                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a5ae2d7b83bef3af8a31290ab530223f9">MESSAGE_ACTION_DISCONNECT</a>;
<a name="l00275"></a>00275                                 <span class="comment">// Adjust time priority</span>
<a name="l00276"></a>00276                                 <span class="keywordflow">if</span> (addrs-&gt;<a class="code" href="struct_address_broadcast.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>[x]-&gt;<a class="code" href="struct_network_address.html#abe902382ebcf927bbba5c0d47bf53138">score</a> &gt; now + 600)
<a name="l00277"></a>00277                                         <span class="comment">// Address is advertised more than ten minutes from now. Give low priority at 5 days ago</span>
<a name="l00278"></a>00278                                         addrs-&gt;<a class="code" href="struct_address_broadcast.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>[x]-&gt;<a class="code" href="struct_network_address.html#abe902382ebcf927bbba5c0d47bf53138">score</a> = (uint32_t)(now - 432000); <span class="comment">// ??? Needs fixing for integer overflow in the year 2106.</span>
<a name="l00279"></a>00279                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (addrs-&gt;<a class="code" href="struct_address_broadcast.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>[x]-&gt;<a class="code" href="struct_network_address.html#abe902382ebcf927bbba5c0d47bf53138">score</a> &gt; now - 900) <span class="comment">// Sooner than fifteen minutes ago. Give highest priority.</span>
<a name="l00280"></a>00280                                         addrs-&gt;<a class="code" href="struct_address_broadcast.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>[x]-&gt;<a class="code" href="struct_network_address.html#abe902382ebcf927bbba5c0d47bf53138">score</a> = (uint32_t)now;
<a name="l00281"></a>00281                                 <span class="comment">// Else leave the time</span>
<a name="l00282"></a>00282                                 <span class="comment">// Check if we have the address as a stored address</span>
<a name="l00283"></a>00283                                 <a class="code" href="struct_network_address.html" title="Structure for NetworkAddress objects.">NetworkAddress</a> * addr = AddressManagerGotNetworkAddress(self-&gt;addresses,addrs-&gt;<a class="code" href="struct_address_broadcast.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>[x]);
<a name="l00284"></a>00284                                 <span class="keywordflow">if</span>(addr){
<a name="l00285"></a>00285                                         <span class="comment">// Already have the address. Modify the existing object.</span>
<a name="l00286"></a>00286                                         addr-&gt;<a class="code" href="struct_network_address.html#abe902382ebcf927bbba5c0d47bf53138">score</a> = addrs-&gt;<a class="code" href="struct_address_broadcast.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>[x]-&gt;<a class="code" href="struct_network_address.html#abe902382ebcf927bbba5c0d47bf53138">score</a>;
<a name="l00287"></a>00287                                         addr-&gt;<a class="code" href="struct_network_address.html#a8361260b2ca75771b8da0333191db456">services</a> = addrs-&gt;<a class="code" href="struct_address_broadcast.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>[x]-&gt;<a class="code" href="struct_network_address.html#a8361260b2ca75771b8da0333191db456">services</a>;
<a name="l00288"></a>00288                                         addr-&gt;<a class="code" href="struct_network_address.html#a67fae7dd1de9edce3656ed214d20377f">version</a> = addrs-&gt;<a class="code" href="struct_address_broadcast.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>[x]-&gt;<a class="code" href="struct_network_address.html#a67fae7dd1de9edce3656ed214d20377f">version</a>;
<a name="l00289"></a>00289                                 }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (AddressManagerIsReachable(self-&gt;addresses, addrs-&gt;<a class="code" href="struct_address_broadcast.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>[x]-&gt;<a class="code" href="struct_network_address.html#a5568ed4dd65aedfed84459bd34350ddb">type</a>)){
<a name="l00290"></a>00290                                         <span class="comment">// Do not have the address so add it if we believe we can reach it and if it is not us.</span>
<a name="l00291"></a>00291                                         <span class="keywordflow">if</span> ((self-&gt;ourIPv4
<a name="l00292"></a>00292                                                  &amp;&amp; addrs-&gt;<a class="code" href="struct_address_broadcast.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>[x]-&gt;<a class="code" href="struct_network_address.html#a5568ed4dd65aedfed84459bd34350ddb">type</a> &amp; <a class="code" href="_constants_8h.html#aadb1cfb5fcd8adc562a07248be433d45ada1efeae8e474dedf665973081167ec3">IP_IPv4</a>
<a name="l00293"></a>00293                                                  &amp;&amp; NetworkAddressEquals(self-&gt;ourIPv4, addrs-&gt;<a class="code" href="struct_address_broadcast.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>[x]))
<a name="l00294"></a>00294                                                 || (self-&gt;ourIPv6
<a name="l00295"></a>00295                                                         &amp;&amp; addrs-&gt;<a class="code" href="struct_address_broadcast.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>[x]-&gt;<a class="code" href="struct_network_address.html#a5568ed4dd65aedfed84459bd34350ddb">type</a> &amp; <a class="code" href="_constants_8h.html#aadb1cfb5fcd8adc562a07248be433d45a5c7c7aafd5c7ea542e80fa0367abe957">IP_IPv6</a>
<a name="l00296"></a>00296                                                         &amp;&amp; NetworkAddressEquals(self-&gt;ourIPv6, addrs-&gt;<a class="code" href="struct_address_broadcast.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>[x])))
<a name="l00297"></a>00297                                                                 <span class="comment">// Is us</span>
<a name="l00298"></a>00298                                                                 <span class="keywordflow">continue</span>;
<a name="l00299"></a>00299                                         <span class="comment">// Make copy of the address since otherwise we will corrupt the AddressBroadcast when trying the connection.</span>
<a name="l00300"></a>00300                                         <a class="code" href="struct_network_address.html" title="Structure for NetworkAddress objects.">NetworkAddress</a> * copy = NewNetworkAddress(addrs-&gt;<a class="code" href="struct_address_broadcast.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>[x]-&gt;<a class="code" href="struct_network_address.html#abe902382ebcf927bbba5c0d47bf53138">score</a>, addrs-&gt;<a class="code" href="struct_address_broadcast.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>[x]-&gt;<a class="code" href="struct_network_address.html#a4089fdd69054d27e020233b4233eb5a8">ip</a>, addrs-&gt;<a class="code" href="struct_address_broadcast.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>[x]-&gt;<a class="code" href="struct_network_address.html#a8e0798404bf2cf5dabb84c5ba9a4f236">port</a>, addrs-&gt;<a class="code" href="struct_address_broadcast.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>[x]-&gt;<a class="code" href="struct_network_address.html#a8361260b2ca75771b8da0333191db456">services</a>, <a class="code" href="_message_8c.html#a9ab128ae9cafefd9b05e2e0bfa719770" title="getter">getMessage</a>(addrs-&gt;<a class="code" href="struct_address_broadcast.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>[x])-&gt;<a class="code" href="struct_message.html#a3c8af4f580f3041d046b7581f89a9695">onErrorReceived</a>);
<a name="l00301"></a>00301                                         <span class="keywordflow">if</span> (copy){
<a name="l00302"></a>00302                                                 AddressManagerAddAddress(self-&gt;addresses, copy);
<a name="l00303"></a>00303                                                 <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(copy);
<a name="l00304"></a>00304                                                 didAdd = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00305"></a>00305                                         }<span class="keywordflow">else</span> <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a5ae2d7b83bef3af8a31290ab530223f9">MESSAGE_ACTION_DISCONNECT</a>;
<a name="l00306"></a>00306                                 }
<a name="l00307"></a>00307                         }<span class="keywordflow">else</span>
<a name="l00308"></a>00308                                 <span class="comment">// We have an advertised peer. This means it is public and should return to the address store.</span>
<a name="l00309"></a>00309                                 <a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(peerB)-&gt;<a class="code" href="struct_network_address.html#ac2ac3334541a2e6ec83c38297c566321">public</a> = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00310"></a>00310                 }
<a name="l00311"></a>00311                 <span class="keywordflow">if</span> (! peer-&gt;<a class="code" href="struct_peer.html#afa38ec4834747a440bcbdf84be12a6bb">getAddresses</a> &amp;&amp; addrs-&gt;<a class="code" href="struct_address_broadcast.html#a02583d0b0d5e7c0a314ff9b9493a6644">addrNum</a> &lt; 10) {
<a name="l00312"></a>00312                         <span class="comment">// Unsolicited addresses. Less than ten so relay to two random peers. bitcoin-qt does something weird. We wont. Keep it simple... Right ???</span>
<a name="l00313"></a>00313                         <span class="keywordflow">for</span> (uint16_t x = rand() % (self-&gt;addresses-&gt;peersNum - 1),y = 0; x &lt; self-&gt;addresses-&gt;peersNum &amp;&amp; y &lt; 2; x++,y++) {
<a name="l00314"></a>00314                                 <span class="keywordflow">if</span> (self-&gt;addresses-&gt;peers[x] == peer)
<a name="l00315"></a>00315                                         <span class="keywordflow">continue</span>;
<a name="l00316"></a>00316                                 <a class="code" href="_network_communicator_8c.html#a67b0329d1c08b164bc3b255bd412e355">NetworkCommunicatorSendMessage</a>(<span class="keyword">self</span>, self-&gt;addresses-&gt;peers[x], <a class="code" href="_message_8c.html#a9ab128ae9cafefd9b05e2e0bfa719770" title="getter">getMessage</a>(addrs));
<a name="l00317"></a>00317                         }
<a name="l00318"></a>00318                 }
<a name="l00319"></a>00319                 <span class="keywordflow">if</span> (didAdd)
<a name="l00320"></a>00320                         <span class="comment">// We have new address information so try connecting to addresses.</span>
<a name="l00321"></a>00321                         <a class="code" href="_network_communicator_8c.html#a1885c0cdbcfda108d13cf52a71bad42d">NetworkCommunicatorTryConnections</a>(<span class="keyword">self</span>);
<a name="l00322"></a>00322                 <span class="comment">// Got addresses.</span>
<a name="l00323"></a>00323                 peer-&gt;<a class="code" href="struct_peer.html#afa38ec4834747a440bcbdf84be12a6bb">getAddresses</a> = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l00324"></a>00324         }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#a8a2053c7fb1adf60da2f26c06059539e">type</a> == <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ab7a4ea5ef99171707a6cd4b0b8027b41">MESSAGE_TYPE_GETADDR</a>) {
<a name="l00325"></a>00325                 <span class="comment">// Give 33 peers with the highest times with a some randomisation added. Try connected peers first. Do not send empty addr.</span>
<a name="l00326"></a>00326                 <a class="code" href="struct_address_broadcast.html" title="Structure for AddressBroadcast objects.">AddressBroadcast</a> * addrBroadcast = NewAddressBroadcast(self-&gt;version &gt;= _ADDR_TIME_VERSION &amp;&amp; peer-&gt;<a class="code" href="struct_peer.html#a3621dcfbd15278c25b8bc1279eab0f61">versionMessage</a>-&gt;<a class="code" href="struct_version.html#a67fae7dd1de9edce3656ed214d20377f">version</a> &gt;= _ADDR_TIME_VERSION, self-&gt;onErrorReceived);
<a name="l00327"></a>00327                 <span class="keywordflow">if</span> (! addrBroadcast)
<a name="l00328"></a>00328                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a5ae2d7b83bef3af8a31290ab530223f9">MESSAGE_ACTION_DISCONNECT</a>;
<a name="l00329"></a>00329                 <a class="code" href="_message_8c.html#a9ab128ae9cafefd9b05e2e0bfa719770" title="getter">getMessage</a>(addrBroadcast)-&gt;<a class="code" href="struct_message.html#a8a2053c7fb1adf60da2f26c06059539e">type</a> = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a1ca0c8f3ae33849b0a2c940aa99b4d19">MESSAGE_TYPE_ADDR</a>;
<a name="l00330"></a>00330                 <span class="comment">// Try connected peers. Only send peers that are public (private addresses are those which connect to us but haven&#39;t relayed their address).</span>
<a name="l00331"></a>00331                 uint16_t peersSent = 0;
<a name="l00332"></a>00332                 uint16_t y = 0;
<a name="l00333"></a>00333                 <span class="keywordflow">while</span> (peersSent &lt; 28 &amp;&amp; y &lt; self-&gt;addresses-&gt;peersNum) { <span class="comment">// 28 to have room for 5 addresses.</span>
<a name="l00334"></a>00334                         <span class="keywordflow">if</span> (self-&gt;addresses-&gt;peers[y] != peer <span class="comment">// Not the peer we are sending to</span>
<a name="l00335"></a>00335                                 &amp;&amp; <a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(self-&gt;addresses-&gt;peers[y])-&gt;<a class="code" href="struct_network_address.html#ac2ac3334541a2e6ec83c38297c566321">public</a> <span class="comment">// Public</span>
<a name="l00336"></a>00336                                 &amp;&amp; (<a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(self-&gt;addresses-&gt;peers[y])-&gt;<a class="code" href="struct_network_address.html#a5568ed4dd65aedfed84459bd34350ddb">type</a> != <a class="code" href="_constants_8h.html#aadb1cfb5fcd8adc562a07248be433d45a843ba99ebefa69343b980604fbe93a31">IP_LOCAL</a> <span class="comment">// OK if not local</span>
<a name="l00337"></a>00337                                         || <a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(peer)-&gt;type == <a class="code" href="_constants_8h.html#aadb1cfb5fcd8adc562a07248be433d45a843ba99ebefa69343b980604fbe93a31">IP_LOCAL</a>)) { <span class="comment">//               Or if the peer we are sending to is local</span>
<a name="l00338"></a>00338                                                 <span class="keywordflow">if</span>(! AddressBroadcastAddNetworkAddress(addrBroadcast, <a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(self-&gt;addresses-&gt;peers[y]))){
<a name="l00339"></a>00339                                                         <span class="comment">// Memory problem. Free space by disconnecting node.</span>
<a name="l00340"></a>00340                                                         <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(addrBroadcast);
<a name="l00341"></a>00341                                                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a5ae2d7b83bef3af8a31290ab530223f9">MESSAGE_ACTION_DISCONNECT</a>;
<a name="l00342"></a>00342                                                 }
<a name="l00343"></a>00343                                                 peersSent++;
<a name="l00344"></a>00344                         }
<a name="l00345"></a>00345                         y++;
<a name="l00346"></a>00346                 }
<a name="l00347"></a>00347                 <span class="comment">// Now add stored addresses</span>
<a name="l00348"></a>00348                 <a class="code" href="struct_network_address_locator.html" title="Structure for storing a pointer to a NetworkAddress and describing it&#39;s location in the AddressManage...">NetworkAddressLocator</a> * addrs = AddressManagerGetAddresses(self-&gt;addresses, 33 - peersSent);
<a name="l00349"></a>00349                 <span class="keywordflow">for</span> (uint8_t x = 0; (addrs + x)-&gt;addr != NULL; x++){
<a name="l00350"></a>00350                         <span class="keywordflow">if</span> ((addrs + x)-&gt;addr-&gt;type != <a class="code" href="_constants_8h.html#aadb1cfb5fcd8adc562a07248be433d45a843ba99ebefa69343b980604fbe93a31">IP_LOCAL</a>
<a name="l00351"></a>00351                                 || <a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(peer)-&gt;<a class="code" href="struct_network_address.html#a5568ed4dd65aedfed84459bd34350ddb">type</a> == <a class="code" href="_constants_8h.html#aadb1cfb5fcd8adc562a07248be433d45a843ba99ebefa69343b980604fbe93a31">IP_LOCAL</a>)
<a name="l00352"></a>00352                                 <span class="comment">// If the address is not local or if the peer we are sending to is local, the address is acceptable.</span>
<a name="l00353"></a>00353                                 <span class="keywordflow">if</span>(! AddressBroadcastAddNetworkAddress(addrBroadcast, (addrs + x)-&gt;addr)){
<a name="l00354"></a>00354                                         <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(addrBroadcast);
<a name="l00355"></a>00355                                         <span class="keywordflow">for</span> (uint8_t y = x; (addrs + x)-&gt;addr != NULL; y++)
<a name="l00356"></a>00356                                                 <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>((addrs + y)-&gt;addr);
<a name="l00357"></a>00357                                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a5ae2d7b83bef3af8a31290ab530223f9">MESSAGE_ACTION_DISCONNECT</a>;
<a name="l00358"></a>00358                                 }
<a name="l00359"></a>00359                         <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>((addrs + x)-&gt;addr);
<a name="l00360"></a>00360                 }
<a name="l00361"></a>00361                 free(addrs);
<a name="l00362"></a>00362                 <span class="comment">// Send address broadcast, if we have at least one.</span>
<a name="l00363"></a>00363                 <span class="keywordflow">if</span> (addrBroadcast-&gt;<a class="code" href="struct_address_broadcast.html#a02583d0b0d5e7c0a314ff9b9493a6644">addrNum</a>)
<a name="l00364"></a>00364                         <a class="code" href="_network_communicator_8c.html#a67b0329d1c08b164bc3b255bd412e355">NetworkCommunicatorSendMessage</a>(<span class="keyword">self</span>, peer, <a class="code" href="_message_8c.html#a9ab128ae9cafefd9b05e2e0bfa719770" title="getter">getMessage</a>(addrBroadcast));
<a name="l00365"></a>00365                 <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(addrBroadcast);
<a name="l00366"></a>00366         }
<a name="l00367"></a>00367         <span class="comment">// Use opportunity to discover if we should broadcast our own addresses for recieving incoming connections.</span>
<a name="l00368"></a>00368         <span class="keywordflow">if</span> (self-&gt;maxIncommingConnections <span class="comment">// Only share address if we allow for incomming connections.</span>
<a name="l00369"></a>00369                 &amp;&amp; (self-&gt;isListeningIPv4 || self-&gt;isListeningIPv6) <span class="comment">// Share when we are listening for incoming connections.</span>
<a name="l00370"></a>00370                 &amp;&amp; peer-&gt;<a class="code" href="struct_peer.html#a70d2018c7a8eede093fe63926373008d">timeBroadcast</a> &lt; time(NULL) - 86400 <span class="comment">// Every 24 hours</span>
<a name="l00371"></a>00371                 &amp;&amp; peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> &amp; <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a1ca0c8f3ae33849b0a2c940aa99b4d19">MESSAGE_TYPE_ADDR</a>) { <span class="comment">// Only share address if they are allowed.</span>
<a name="l00372"></a>00372                 peer-&gt;<a class="code" href="struct_peer.html#a70d2018c7a8eede093fe63926373008d">timeBroadcast</a> = time(NULL);
<a name="l00373"></a>00373                 <a class="code" href="struct_address_broadcast.html" title="Structure for AddressBroadcast objects.">AddressBroadcast</a> * addrBroadcast = NewAddressBroadcast(self-&gt;version &gt;= <a class="code" href="_constants_8h.html#ae8c17e93ce99a43c7cea0d3372e1bf8a">ADDR_TIME_VERSION</a> &amp;&amp; peer-&gt;<a class="code" href="struct_peer.html#a3621dcfbd15278c25b8bc1279eab0f61">versionMessage</a>-&gt;<a class="code" href="struct_version.html#a67fae7dd1de9edce3656ed214d20377f">version</a> &gt;= _ADDR_TIME_VERSION, self-&gt;onErrorReceived);
<a name="l00374"></a>00374                 <span class="keywordflow">if</span> (! addrBroadcast)
<a name="l00375"></a>00375                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a5ae2d7b83bef3af8a31290ab530223f9">MESSAGE_ACTION_DISCONNECT</a>;
<a name="l00376"></a>00376                 <a class="code" href="_message_8c.html#a9ab128ae9cafefd9b05e2e0bfa719770" title="getter">getMessage</a>(addrBroadcast)-&gt;<a class="code" href="struct_message.html#a8a2053c7fb1adf60da2f26c06059539e">type</a> = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a1ca0c8f3ae33849b0a2c940aa99b4d19">MESSAGE_TYPE_ADDR</a>;
<a name="l00377"></a>00377                 <span class="keywordflow">if</span> (self-&gt;ourIPv6) {
<a name="l00378"></a>00378                         <span class="keyword">self</span>-&gt;ourIPv6-&gt;score = (uint32_t)time(NULL) + <span class="keyword">self</span>-&gt;addresses-&gt;networkTimeOffset;
<a name="l00379"></a>00379                         <span class="keywordflow">if</span>(! AddressBroadcastAddNetworkAddress(addrBroadcast,self-&gt;ourIPv6)){
<a name="l00380"></a>00380                                 <span class="comment">// Memory issue</span>
<a name="l00381"></a>00381                                 <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(addrBroadcast);
<a name="l00382"></a>00382                                 <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a5ae2d7b83bef3af8a31290ab530223f9">MESSAGE_ACTION_DISCONNECT</a>;
<a name="l00383"></a>00383                         }
<a name="l00384"></a>00384                 }
<a name="l00385"></a>00385                 <span class="keywordflow">if</span> (self-&gt;ourIPv4) {
<a name="l00386"></a>00386                         <span class="keyword">self</span>-&gt;ourIPv4-&gt;score = (uint32_t)time(NULL) + <span class="keyword">self</span>-&gt;addresses-&gt;networkTimeOffset;
<a name="l00387"></a>00387                         <span class="keywordflow">if</span>(! AddressBroadcastAddNetworkAddress(addrBroadcast,self-&gt;ourIPv4)){
<a name="l00388"></a>00388                                 <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(addrBroadcast);
<a name="l00389"></a>00389                                 <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a5ae2d7b83bef3af8a31290ab530223f9">MESSAGE_ACTION_DISCONNECT</a>;
<a name="l00390"></a>00390                         }
<a name="l00391"></a>00391                 }
<a name="l00392"></a>00392                 <a class="code" href="_network_communicator_8c.html#a67b0329d1c08b164bc3b255bd412e355">NetworkCommunicatorSendMessage</a>(<span class="keyword">self</span>, peer, <a class="code" href="_message_8c.html#a9ab128ae9cafefd9b05e2e0bfa719770" title="getter">getMessage</a>(addrBroadcast));
<a name="l00393"></a>00393                 <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(addrBroadcast);
<a name="l00394"></a>00394         }
<a name="l00395"></a>00395         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a73f6aac48ce0c9115366c60c688b2519">MESSAGE_ACTION_CONTINUE</a>; <span class="comment">// Do not disconnect.</span>
<a name="l00396"></a>00396 }
<a name="l00397"></a><a class="code" href="_network_communicator_8c.html#a775489ea672f9fc6b191d84a3a937f03">00397</a> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33">OnMessageReceivedAction</a> <a class="code" href="_network_communicator_8c.html#a775489ea672f9fc6b191d84a3a937f03">NetworkCommunicatorProcessMessageAutoHandshake</a>(<a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span>,<a class="code" href="struct_peer.html" title="Structure for Peer objects.">Peer</a> * peer){
<a name="l00398"></a>00398         <span class="keywordtype">boolean</span> endHandshake = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l00399"></a>00399         <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#a8a2053c7fb1adf60da2f26c06059539e">type</a> == <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a6b5d45c74743b18c5191ca991c8424ba">MESSAGE_TYPE_VERSION</a>) {
<a name="l00400"></a>00400                 <span class="comment">// Node sent us their version. How very nice of them.</span>
<a name="l00401"></a>00401                 <span class="comment">// Check version and nounce.</span>
<a name="l00402"></a>00402                 <span class="keywordflow">if</span> (<a class="code" href="_version_8c.html#ae3428387ebd0bed5f378d2d0b5050d79">GetVersion</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>)-&gt;<a class="code" href="struct_version.html#a67fae7dd1de9edce3656ed214d20377f">version</a> &lt; _MIN_PROTO_VERSION
<a name="l00403"></a>00403                         || (<a class="code" href="_version_8c.html#ae3428387ebd0bed5f378d2d0b5050d79">GetVersion</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>)-&gt;<a class="code" href="struct_version.html#a1516425364f8d32e9fde9871bd3d3c41">nounce</a> == self-&gt;nounce &amp;&amp; self-&gt;nounce &gt; 0))
<a name="l00404"></a>00404                         <span class="comment">// Disconnect peer</span>
<a name="l00405"></a>00405                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a5ae2d7b83bef3af8a31290ab530223f9">MESSAGE_ACTION_DISCONNECT</a>;
<a name="l00406"></a>00406                 <span class="keywordflow">else</span>{ <span class="comment">// Version OK</span>
<a name="l00407"></a>00407                         <span class="comment">// Check if we have a connection to this peer already</span>
<a name="l00408"></a>00408                         <a class="code" href="struct_peer.html" title="Structure for Peer objects.">Peer</a> * peerCheck = AddressManagerGotNode(self-&gt;addresses, <a class="code" href="_version_8c.html#ae3428387ebd0bed5f378d2d0b5050d79">GetVersion</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>)-&gt;<a class="code" href="struct_version.html#a617709cf2266e62755258963031f1af0">addSource</a>);
<a name="l00409"></a>00409                         <span class="keywordflow">if</span> (peerCheck &amp;&amp; peerCheck != peer){
<a name="l00410"></a>00410                                 <span class="comment">// One of the connections must now be dropped. The original client does not do this but cbitcoin does. To avoid both connections being closed an arbitrary comparison that can be shared between the nodes is used. The network addresses are compared for this purpose.</span>
<a name="l00411"></a>00411                                 <span class="keywordtype">int</span> cmp;
<a name="l00412"></a>00412                                 <span class="keywordflow">if</span> (<a class="code" href="_version_8c.html#ae3428387ebd0bed5f378d2d0b5050d79">GetVersion</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>)-&gt;<a class="code" href="struct_version.html#a617709cf2266e62755258963031f1af0">addSource</a>-&gt;<a class="code" href="struct_network_address.html#a5568ed4dd65aedfed84459bd34350ddb">type</a> &amp; <a class="code" href="_constants_8h.html#aadb1cfb5fcd8adc562a07248be433d45a5c7c7aafd5c7ea542e80fa0367abe957">IP_IPv6</a>){
<a name="l00413"></a>00413                                         cmp = ByteArrayCompare(<a class="code" href="_version_8c.html#ae3428387ebd0bed5f378d2d0b5050d79">GetVersion</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>)-&gt;<a class="code" href="struct_version.html#a617709cf2266e62755258963031f1af0">addSource</a>-&gt;<a class="code" href="struct_network_address.html#a4089fdd69054d27e020233b4233eb5a8">ip</a>,self-&gt;ourIPv6-&gt;ip);
<a name="l00414"></a>00414                                         <span class="keywordflow">if</span> (! cmp)
<a name="l00415"></a>00415                                                 cmp = (<a class="code" href="_version_8c.html#ae3428387ebd0bed5f378d2d0b5050d79">GetVersion</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>)-&gt;<a class="code" href="struct_version.html#a617709cf2266e62755258963031f1af0">addSource</a>-&gt;<a class="code" href="struct_network_address.html#a8e0798404bf2cf5dabb84c5ba9a4f236">port</a> &gt; <span class="keyword">self</span>-&gt;ourIPv6-&gt;port) ? 1 : -1;
<a name="l00416"></a>00416                                 }<span class="keywordflow">else</span>{
<a name="l00417"></a>00417                                         cmp = memcmp(ByteArrayGetData(<a class="code" href="_version_8c.html#ae3428387ebd0bed5f378d2d0b5050d79">GetVersion</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>)-&gt;<a class="code" href="struct_version.html#a617709cf2266e62755258963031f1af0">addSource</a>-&gt;<a class="code" href="struct_network_address.html#a4089fdd69054d27e020233b4233eb5a8">ip</a>) + 12,ByteArrayGetData(self-&gt;ourIPv4-&gt;ip) + 12,4);
<a name="l00418"></a>00418                                         <span class="keywordflow">if</span> (! cmp)
<a name="l00419"></a>00419                                                 cmp = (<a class="code" href="_version_8c.html#ae3428387ebd0bed5f378d2d0b5050d79">GetVersion</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>)-&gt;<a class="code" href="struct_version.html#a617709cf2266e62755258963031f1af0">addSource</a>-&gt;<a class="code" href="struct_network_address.html#a8e0798404bf2cf5dabb84c5ba9a4f236">port</a> &gt; <span class="keyword">self</span>-&gt;ourIPv4-&gt;port) ? 1 : -1;
<a name="l00420"></a>00420                                 }
<a name="l00421"></a>00421                                 <span class="keywordflow">if</span> (cmp &gt; 0)
<a name="l00422"></a>00422                                         <span class="comment">// Disconnect this connection.</span>
<a name="l00423"></a>00423                                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a5ae2d7b83bef3af8a31290ab530223f9">MESSAGE_ACTION_DISCONNECT</a>;
<a name="l00424"></a>00424                                 <span class="keywordflow">else</span>
<a name="l00425"></a>00425                                         <span class="comment">// Disconnect the other connection.</span>
<a name="l00426"></a>00426                                         <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peerCheck, 0, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l00427"></a>00427                         }
<a name="l00428"></a>00428                         <span class="comment">// Remove the source address from the address manager if it has it. It will be added again if the peer wishes to broadcast their address. Now that the peer is connected, we identify it by the source address and do not want to try connections to the same address.</span>
<a name="l00429"></a>00429                         AddressManagerRemoveAddress(self-&gt;addresses, <a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(<a class="code" href="_version_8c.html#ae3428387ebd0bed5f378d2d0b5050d79">GetVersion</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>)-&gt;<a class="code" href="struct_version.html#a617709cf2266e62755258963031f1af0">addSource</a>));
<a name="l00430"></a>00430                         <span class="comment">// Save version message</span>
<a name="l00431"></a>00431                         peer-&gt;<a class="code" href="struct_peer.html#a3621dcfbd15278c25b8bc1279eab0f61">versionMessage</a> = <a class="code" href="_version_8c.html#ae3428387ebd0bed5f378d2d0b5050d79">GetVersion</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>);
<a name="l00432"></a>00432                         RetainObject(peer-&gt;<a class="code" href="struct_peer.html#a3621dcfbd15278c25b8bc1279eab0f61">versionMessage</a>);
<a name="l00433"></a>00433                         <span class="comment">// Change version 10300 to 300</span>
<a name="l00434"></a>00434                         <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#a3621dcfbd15278c25b8bc1279eab0f61">versionMessage</a>-&gt;<a class="code" href="struct_version.html#a67fae7dd1de9edce3656ed214d20377f">version</a> == 10300)
<a name="l00435"></a>00435                                 peer-&gt;<a class="code" href="struct_peer.html#a3621dcfbd15278c25b8bc1279eab0f61">versionMessage</a>-&gt;<a class="code" href="struct_version.html#a67fae7dd1de9edce3656ed214d20377f">version</a> = 300;
<a name="l00436"></a>00436                         <span class="comment">// Copy over reported version and services for the NetworkAddress.</span>
<a name="l00437"></a>00437                         <a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(peer)-&gt;<a class="code" href="struct_network_address.html#a67fae7dd1de9edce3656ed214d20377f">version</a> = peer-&gt;<a class="code" href="struct_peer.html#a3621dcfbd15278c25b8bc1279eab0f61">versionMessage</a>-&gt;<a class="code" href="struct_version.html#a67fae7dd1de9edce3656ed214d20377f">version</a>;
<a name="l00438"></a>00438                         <a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(peer)-&gt;<a class="code" href="struct_network_address.html#a8361260b2ca75771b8da0333191db456">services</a> = peer-&gt;<a class="code" href="struct_peer.html#a3621dcfbd15278c25b8bc1279eab0f61">versionMessage</a>-&gt;<a class="code" href="struct_version.html#a0f2a3352e2168d655a13756eae9b8417">services</a>;
<a name="l00439"></a>00439                         <a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(peer)-&gt;<a class="code" href="struct_network_address.html#abe902382ebcf927bbba5c0d47bf53138">score</a> = (uint32_t)time(NULL); <span class="comment">// ??? Loss of integer precisibon.</span>
<a name="l00440"></a>00440                         <span class="comment">// Change port and IP number to the port and IP the peer wants us to recognise them with.</span>
<a name="l00441"></a>00441                         <a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(peer)-&gt;<a class="code" href="struct_network_address.html#a8e0798404bf2cf5dabb84c5ba9a4f236">port</a> = peer-&gt;<a class="code" href="struct_peer.html#a3621dcfbd15278c25b8bc1279eab0f61">versionMessage</a>-&gt;<a class="code" href="struct_version.html#a617709cf2266e62755258963031f1af0">addSource</a>-&gt;<a class="code" href="struct_network_address.html#a8e0798404bf2cf5dabb84c5ba9a4f236">port</a>;
<a name="l00442"></a>00442                         <a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(peer)-&gt;<a class="code" href="struct_network_address.html#a4089fdd69054d27e020233b4233eb5a8">ip</a> = peer-&gt;<a class="code" href="struct_peer.html#a3621dcfbd15278c25b8bc1279eab0f61">versionMessage</a>-&gt;<a class="code" href="struct_version.html#a617709cf2266e62755258963031f1af0">addSource</a>-&gt;<a class="code" href="struct_network_address.html#a4089fdd69054d27e020233b4233eb5a8">ip</a>;
<a name="l00443"></a>00443                         <a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(peer)-&gt;<a class="code" href="struct_network_address.html#a5568ed4dd65aedfed84459bd34350ddb">type</a> = GetIPType(ByteArrayGetData(<a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(peer)-&gt;ip));
<a name="l00444"></a>00444                         <span class="comment">// Adjust network time</span>
<a name="l00445"></a>00445                         peer-&gt;<a class="code" href="struct_peer.html#aabc18e106727658ebeed7ad5e7db53ca">timeOffset</a> = peer-&gt;<a class="code" href="struct_peer.html#a3621dcfbd15278c25b8bc1279eab0f61">versionMessage</a>-&gt;<a class="code" href="struct_version.html#aee52de7b225665566aa47246b9d6b8fa">time</a> - time(NULL); <span class="comment">// Set the time offset for this peer.</span>
<a name="l00446"></a>00446                         <span class="comment">// Disallow version from here.</span>
<a name="l00447"></a>00447                         peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> &amp;= ~<a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a6b5d45c74743b18c5191ca991c8424ba">MESSAGE_TYPE_VERSION</a>;
<a name="l00448"></a>00448                         <span class="comment">// Send our acknowledgement</span>
<a name="l00449"></a>00449                         <a class="code" href="struct_message.html" title="Structure for Message objects.">Message</a> * ack = NewMessageByObject(self-&gt;onErrorReceived);
<a name="l00450"></a>00450                         <span class="keywordflow">if</span> (! ack)
<a name="l00451"></a>00451                                 <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a5ae2d7b83bef3af8a31290ab530223f9">MESSAGE_ACTION_DISCONNECT</a>;
<a name="l00452"></a>00452                         ack-&gt;<a class="code" href="struct_message.html#a8a2053c7fb1adf60da2f26c06059539e">type</a> = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ab04a1ce83c41d3c309a7e88c5e0c6d14">MESSAGE_TYPE_VERACK</a>;
<a name="l00453"></a>00453                         <span class="keywordtype">boolean</span> ok = <a class="code" href="_network_communicator_8c.html#a67b0329d1c08b164bc3b255bd412e355">NetworkCommunicatorSendMessage</a>(<span class="keyword">self</span>,peer,ack);
<a name="l00454"></a>00454                         <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(ack);
<a name="l00455"></a>00455                         <span class="keywordflow">if</span> (! ok)
<a name="l00456"></a>00456                                 <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a5ae2d7b83bef3af8a31290ab530223f9">MESSAGE_ACTION_DISCONNECT</a>; <span class="comment">// If we cannot send an acknowledgement, exit.</span>
<a name="l00457"></a>00457                         <span class="comment">// Send version next if we have not already.</span>
<a name="l00458"></a>00458                         <span class="keywordflow">if</span> (! peer-&gt;<a class="code" href="struct_peer.html#ac772b4b3b557f31cbb8ddbbabdcca45a">versionSent</a>) {
<a name="l00459"></a>00459                                 <a class="code" href="struct_version.html" title="Structure for Version objects.">Version</a> * version = <a class="code" href="_network_communicator_8c.html#ade16d475138752b748b0e6568c1c2cf6">NetworkCommunicatorGetVersion</a>(<span class="keyword">self</span>, <a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(peer));
<a name="l00460"></a>00460                                 <span class="keywordflow">if</span> (version) {
<a name="l00461"></a>00461                                         <a class="code" href="_message_8c.html#a9ab128ae9cafefd9b05e2e0bfa719770" title="getter">getMessage</a>(version)-&gt;<a class="code" href="struct_message.html#accc3616411ea4a5035a7eaf42132d370">expectResponse</a> = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ab04a1ce83c41d3c309a7e88c5e0c6d14">MESSAGE_TYPE_VERACK</a>; <span class="comment">// Expect a response for this message.</span>
<a name="l00462"></a>00462                                         peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ab04a1ce83c41d3c309a7e88c5e0c6d14">MESSAGE_TYPE_VERACK</a>; <span class="comment">// Ony allow version acknowledgement from here.</span>
<a name="l00463"></a>00463                                         <a class="code" href="_message_8c.html#a9ab128ae9cafefd9b05e2e0bfa719770" title="getter">getMessage</a>(version)-&gt;<a class="code" href="struct_message.html#a8a2053c7fb1adf60da2f26c06059539e">type</a> = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a6b5d45c74743b18c5191ca991c8424ba">MESSAGE_TYPE_VERSION</a>;
<a name="l00464"></a>00464                                         <span class="keywordtype">boolean</span> ok = <a class="code" href="_network_communicator_8c.html#a67b0329d1c08b164bc3b255bd412e355">NetworkCommunicatorSendMessage</a>(<span class="keyword">self</span>, peer, <a class="code" href="_message_8c.html#a9ab128ae9cafefd9b05e2e0bfa719770" title="getter">getMessage</a>(version));
<a name="l00465"></a>00465                                         <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(version);
<a name="l00466"></a>00466                                         <span class="keywordflow">if</span> (! ok)
<a name="l00467"></a>00467                                                 <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a5ae2d7b83bef3af8a31290ab530223f9">MESSAGE_ACTION_DISCONNECT</a>;
<a name="l00468"></a>00468                                         peer-&gt;<a class="code" href="struct_peer.html#ac772b4b3b557f31cbb8ddbbabdcca45a">versionSent</a> = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00469"></a>00469                                 }<span class="keywordflow">else</span>
<a name="l00470"></a>00470                                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a5ae2d7b83bef3af8a31290ab530223f9">MESSAGE_ACTION_DISCONNECT</a>;
<a name="l00471"></a>00471                         }<span class="keywordflow">else</span>
<a name="l00472"></a>00472                                 <span class="comment">// Sent already. End of handshake</span>
<a name="l00473"></a>00473                                 endHandshake = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00474"></a>00474                 }
<a name="l00475"></a>00475         }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#a8a2053c7fb1adf60da2f26c06059539e">type</a> == <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ab04a1ce83c41d3c309a7e88c5e0c6d14">MESSAGE_TYPE_VERACK</a>) {
<a name="l00476"></a>00476                 peer-&gt;<a class="code" href="struct_peer.html#a0e568c2ca640fccca093a05a53cb8298">versionAck</a> = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00477"></a>00477                 peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> &amp;= ~<a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ab04a1ce83c41d3c309a7e88c5e0c6d14">MESSAGE_TYPE_VERACK</a>; <span class="comment">// Got the version acknowledgement. Do not need it again</span>
<a name="l00478"></a>00478                 <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#a3621dcfbd15278c25b8bc1279eab0f61">versionMessage</a>)
<a name="l00479"></a>00479                         <span class="comment">// We already have their version message. That&#39;s all!</span>
<a name="l00480"></a>00480                         endHandshake = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00481"></a>00481                 <span class="keywordflow">else</span>
<a name="l00482"></a>00482                         <span class="comment">// We need their version.</span>
<a name="l00483"></a>00483                         peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> |= <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a6b5d45c74743b18c5191ca991c8424ba">MESSAGE_TYPE_VERSION</a>;
<a name="l00484"></a>00484         }
<a name="l00485"></a>00485         <span class="keywordflow">if</span> (endHandshake) {
<a name="l00486"></a>00486                 <span class="comment">// The end of the handshake. Allow pings, inventory advertisments, address requests, address broadcasts and alerts.</span>
<a name="l00487"></a>00487                 peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> |= <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a72e87e96bdee95a2bd515e751a711994">MESSAGE_TYPE_PING</a>;
<a name="l00488"></a>00488                 peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> |= <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a68775d2b5fa0faa7e0a1465913f63832">MESSAGE_TYPE_INV</a>;
<a name="l00489"></a>00489                 peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> |= <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ab7a4ea5ef99171707a6cd4b0b8027b41">MESSAGE_TYPE_GETADDR</a>;
<a name="l00490"></a>00490                 peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> |= <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a1ca0c8f3ae33849b0a2c940aa99b4d19">MESSAGE_TYPE_ADDR</a>;
<a name="l00491"></a>00491                 peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> |= <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a3162346b1761cce7cacd667422618e48">MESSAGE_TYPE_ALERT</a>;
<a name="l00492"></a>00492                 <span class="keywordflow">if</span> (self-&gt;flags &amp; _NETWORK_COMMUNICATOR_AUTO_DISCOVERY) {
<a name="l00493"></a>00493                         <span class="comment">// Request addresses</span>
<a name="l00494"></a>00494                         <a class="code" href="struct_message.html" title="Structure for Message objects.">Message</a> * getaddr = NewMessageByObject(self-&gt;onErrorReceived);
<a name="l00495"></a>00495                         <span class="keywordflow">if</span> (! getaddr)
<a name="l00496"></a>00496                                 <span class="keywordflow">return</span>  <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a5ae2d7b83bef3af8a31290ab530223f9">MESSAGE_ACTION_DISCONNECT</a>;
<a name="l00497"></a>00497                         getaddr-&gt;<a class="code" href="struct_message.html#a8a2053c7fb1adf60da2f26c06059539e">type</a> = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ab7a4ea5ef99171707a6cd4b0b8027b41">MESSAGE_TYPE_GETADDR</a>;
<a name="l00498"></a>00498                         <span class="comment">// Send the message without an expected response. We do not expect an &quot;addr&quot; message because the peer may not send us anything if they do not have addresses to give.</span>
<a name="l00499"></a>00499                         <span class="keywordtype">boolean</span> ok = <a class="code" href="_network_communicator_8c.html#a67b0329d1c08b164bc3b255bd412e355">NetworkCommunicatorSendMessage</a>(<span class="keyword">self</span>,peer,getaddr);
<a name="l00500"></a>00500                         <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(getaddr);
<a name="l00501"></a>00501                         <span class="keywordflow">if</span> (! ok)
<a name="l00502"></a>00502                                 <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a5ae2d7b83bef3af8a31290ab530223f9">MESSAGE_ACTION_DISCONNECT</a>;
<a name="l00503"></a>00503                         peer-&gt;<a class="code" href="struct_peer.html#afa38ec4834747a440bcbdf84be12a6bb">getAddresses</a> = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00504"></a>00504                 }
<a name="l00505"></a>00505         }
<a name="l00506"></a>00506         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a73f6aac48ce0c9115366c60c688b2519">MESSAGE_ACTION_CONTINUE</a>;
<a name="l00507"></a>00507 }
<a name="l00508"></a><a class="code" href="_network_communicator_8c.html#a70b80eaf88abbdbd1fe270e254092275">00508</a> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33">OnMessageReceivedAction</a> <a class="code" href="_network_communicator_8c.html#a70b80eaf88abbdbd1fe270e254092275">NetworkCommunicatorProcessMessageAutoPingPong</a>(<a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span>,<a class="code" href="struct_peer.html" title="Structure for Peer objects.">Peer</a> * peer){
<a name="l00509"></a>00509         <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#a8a2053c7fb1adf60da2f26c06059539e">type</a> == <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a72e87e96bdee95a2bd515e751a711994">MESSAGE_TYPE_PING</a>
<a name="l00510"></a>00510                 &amp;&amp; peer-&gt;<a class="code" href="struct_peer.html#a3621dcfbd15278c25b8bc1279eab0f61">versionMessage</a>-&gt;<a class="code" href="struct_version.html#a67fae7dd1de9edce3656ed214d20377f">version</a> &gt;= <a class="code" href="_constants_8h.html#aa4ebef19a712ada26c9e4227a272c89f">PONG_VERSION</a>
<a name="l00511"></a>00511                 &amp;&amp; self-&gt;version &gt;= <a class="code" href="_constants_8h.html#aa4ebef19a712ada26c9e4227a272c89f">PONG_VERSION</a>){
<a name="l00512"></a>00512                 peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#a8a2053c7fb1adf60da2f26c06059539e">type</a> = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013afbac2e84f45320bd443953d336d7f5ae">MESSAGE_TYPE_PONG</a>;
<a name="l00513"></a>00513                 <span class="keywordflow">if</span>(! <a class="code" href="_network_communicator_8c.html#a67b0329d1c08b164bc3b255bd412e355">NetworkCommunicatorSendMessage</a>(<span class="keyword">self</span>, peer, peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>))
<a name="l00514"></a>00514                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a5ae2d7b83bef3af8a31290ab530223f9">MESSAGE_ACTION_DISCONNECT</a>;
<a name="l00515"></a>00515         }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#a8a2053c7fb1adf60da2f26c06059539e">type</a> == <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013afbac2e84f45320bd443953d336d7f5ae">MESSAGE_TYPE_PONG</a>){
<a name="l00516"></a>00516                 <span class="keywordflow">if</span>(self-&gt;version &lt; <a class="code" href="_constants_8h.html#aa4ebef19a712ada26c9e4227a272c89f">PONG_VERSION</a> || peer-&gt;<a class="code" href="struct_peer.html#a3621dcfbd15278c25b8bc1279eab0f61">versionMessage</a>-&gt;<a class="code" href="struct_version.html#a67fae7dd1de9edce3656ed214d20377f">version</a> &lt; <a class="code" href="_constants_8h.html#aa4ebef19a712ada26c9e4227a272c89f">PONG_VERSION</a>)
<a name="l00517"></a>00517                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a5ae2d7b83bef3af8a31290ab530223f9">MESSAGE_ACTION_DISCONNECT</a>; <span class="comment">// This peer should not be sending pong messages.</span>
<a name="l00518"></a>00518                 <span class="comment">// No longer want a pong</span>
<a name="l00519"></a>00519                 peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> &amp;= ~<a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013afbac2e84f45320bd443953d336d7f5ae">MESSAGE_TYPE_PONG</a>;
<a name="l00520"></a>00520         }
<a name="l00521"></a>00521         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a73f6aac48ce0c9115366c60c688b2519">MESSAGE_ACTION_CONTINUE</a>;
<a name="l00522"></a>00522 }
<a name="l00523"></a><a class="code" href="_network_communicator_8c.html#a46f71a041685b462e8c1b738e7ed6915">00523</a> <span class="keywordtype">void</span> <a class="code" href="_network_communicator_8c.html#a46f71a041685b462e8c1b738e7ed6915">NetworkCommunicatorOnCanReceive</a>(<span class="keywordtype">void</span> * vself,<span class="keywordtype">void</span> * vpeer){
<a name="l00524"></a>00524         <a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span> = vself;
<a name="l00525"></a>00525         <a class="code" href="struct_peer.html" title="Structure for Peer objects.">Peer</a> * peer = vpeer;
<a name="l00526"></a>00526         <span class="comment">// Node kindly has some data available in the socket buffer.</span>
<a name="l00527"></a>00527         <span class="keywordflow">if</span> (! peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>) {
<a name="l00528"></a>00528                 <span class="comment">// New message to be received.</span>
<a name="l00529"></a>00529                 peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a> = NewMessageByObject(self-&gt;onErrorReceived);
<a name="l00530"></a>00530                 <span class="keywordflow">if</span> (! peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>) {
<a name="l00531"></a>00531                         <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 0, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l00532"></a>00532                         <span class="keywordflow">return</span>;
<a name="l00533"></a>00533                 }
<a name="l00534"></a>00534                 peer-&gt;<a class="code" href="struct_peer.html#ab6d7934a111f8c73cf69b983f09195e3">headerBuffer</a> = malloc(24); <span class="comment">// Twenty-four bytes for the message header.</span>
<a name="l00535"></a>00535                 <span class="keywordflow">if</span> (! peer-&gt;<a class="code" href="struct_peer.html#ab6d7934a111f8c73cf69b983f09195e3">headerBuffer</a>) {
<a name="l00536"></a>00536                         <span class="comment">// If we run out of memory we want to disconnect as nothing more can be done here.</span>
<a name="l00537"></a>00537                         <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 0, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l00538"></a>00538                         <span class="keywordflow">return</span>;
<a name="l00539"></a>00539                 }
<a name="l00540"></a>00540                 peer-&gt;<a class="code" href="struct_peer.html#a83bb5a7615bbe1744dcadf6b8f7c297f">messageReceived</a> = 0; <span class="comment">// So far received nothing.</span>
<a name="l00541"></a>00541                 SocketAddEvent(peer-&gt;<a class="code" href="struct_peer.html#a85ce08843ff1aa2d229844758849e4d0">receiveEvent</a>, self-&gt;recvTimeOut); <span class="comment">// From now on use timeout for receiving data.</span>
<a name="l00542"></a>00542                 <span class="comment">// Start download timer</span>
<a name="l00543"></a>00543                 peer-&gt;<a class="code" href="struct_peer.html#a599a7c398ad8de49e461e94bececb30c">downloadTimerStart</a> = clock();
<a name="l00544"></a>00544         }
<a name="l00545"></a>00545         <span class="keywordflow">if</span> (! peer-&gt;<a class="code" href="struct_peer.html#ac59131671a3d8f296ffc6f5ba6189def">receivedHeader</a>) { <span class="comment">// Not received the complete message header yet.</span>
<a name="l00546"></a>00546                  int32_t num = SocketReceive(peer-&gt;<a class="code" href="struct_peer.html#a647a5a5d74637603d6c684e22f0a69b7">socketID</a>, peer-&gt;<a class="code" href="struct_peer.html#ab6d7934a111f8c73cf69b983f09195e3">headerBuffer</a> + peer-&gt;<a class="code" href="struct_peer.html#a83bb5a7615bbe1744dcadf6b8f7c297f">messageReceived</a>, 24 - peer-&gt;<a class="code" href="struct_peer.html#a83bb5a7615bbe1744dcadf6b8f7c297f">messageReceived</a>);
<a name="l00547"></a>00547                 <span class="keywordflow">switch</span> (num) {
<a name="l00548"></a>00548                         <span class="keywordflow">case</span> _SOCKETCONNECTION_CLOSE:
<a name="l00549"></a>00549                                 free(peer-&gt;<a class="code" href="struct_peer.html#ab6d7934a111f8c73cf69b983f09195e3">headerBuffer</a>); <span class="comment">// Free the buffer</span>
<a name="l00550"></a>00550                                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 7200, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>); <span class="comment">// Remove with penalty for disconnection</span>
<a name="l00551"></a>00551                                 <span class="keywordflow">return</span>;
<a name="l00552"></a>00552                         <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#a6e91ae3014e3b5615c3945dea5cfcd77">SOCKET_FAILURE</a>:
<a name="l00553"></a>00553                                 <span class="comment">// Failure so remove peer.</span>
<a name="l00554"></a>00554                                 free(peer-&gt;<a class="code" href="struct_peer.html#ab6d7934a111f8c73cf69b983f09195e3">headerBuffer</a>); <span class="comment">// Free the buffer</span>
<a name="l00555"></a>00555                                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 0, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l00556"></a>00556                                 <span class="keywordflow">return</span>;
<a name="l00557"></a>00557                         <span class="keywordflow">default</span>:
<a name="l00558"></a>00558                                 <span class="comment">// Did read some bytes</span>
<a name="l00559"></a>00559                                 peer-&gt;<a class="code" href="struct_peer.html#a83bb5a7615bbe1744dcadf6b8f7c297f">messageReceived</a> += num;
<a name="l00560"></a>00560                                 <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#a83bb5a7615bbe1744dcadf6b8f7c297f">messageReceived</a> == 24)
<a name="l00561"></a>00561                                         <span class="comment">// Hurrah! The header has been received.</span>
<a name="l00562"></a>00562                                         <a class="code" href="_network_communicator_8c.html#a3c2373b9fdccdb79d21f4bdb0421db2a">NetworkCommunicatorOnHeaderRecieved</a>(<span class="keyword">self</span>,peer);
<a name="l00563"></a>00563                                 <span class="keywordflow">return</span>;
<a name="l00564"></a>00564                 }
<a name="l00565"></a>00565         }<span class="keywordflow">else</span>{
<a name="l00566"></a>00566                 <span class="comment">// Means we have payload to fetch as we have the header but not the payload</span>
<a name="l00567"></a>00567                 int32_t num = SocketReceive(peer-&gt;<a class="code" href="struct_peer.html#a647a5a5d74637603d6c684e22f0a69b7">socketID</a>, ByteArrayGetData(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>) + peer-&gt;<a class="code" href="struct_peer.html#a83bb5a7615bbe1744dcadf6b8f7c297f">messageReceived</a>, peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>-&gt;<a class="code" href="struct_byte_array.html#aebb70c2aab3407a9f05334c47131a43b">length</a> - peer-&gt;<a class="code" href="struct_peer.html#a83bb5a7615bbe1744dcadf6b8f7c297f">messageReceived</a>);
<a name="l00568"></a>00568                 <span class="keywordflow">switch</span> (num) {
<a name="l00569"></a>00569                         <span class="keywordflow">case</span> _SOCKETCONNECTION_CLOSE:
<a name="l00570"></a>00570                                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 7200, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>); <span class="comment">// Remove with penalty for disconnection</span>
<a name="l00571"></a>00571                                 <span class="keywordflow">return</span>;
<a name="l00572"></a>00572                         <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#a6e91ae3014e3b5615c3945dea5cfcd77">SOCKET_FAILURE</a>:
<a name="l00573"></a>00573                                 <span class="comment">// Failure so remove peer.</span>
<a name="l00574"></a>00574                                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 0, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l00575"></a>00575                                 <span class="keywordflow">return</span>;
<a name="l00576"></a>00576                         <span class="keywordflow">default</span>:
<a name="l00577"></a>00577                                 <span class="comment">// Did read some bytes</span>
<a name="l00578"></a>00578                                 peer-&gt;<a class="code" href="struct_peer.html#a83bb5a7615bbe1744dcadf6b8f7c297f">messageReceived</a> += num;
<a name="l00579"></a>00579                                 <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#a83bb5a7615bbe1744dcadf6b8f7c297f">messageReceived</a> == peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>-&gt;<a class="code" href="struct_byte_array.html#aebb70c2aab3407a9f05334c47131a43b">length</a>){
<a name="l00580"></a>00580                                         <span class="comment">// We now have the message.</span>
<a name="l00581"></a>00581                                         <a class="code" href="_network_communicator_8c.html#a1e7aeba124b81e6ab5e0661c521a8e78">NetworkCommunicatorOnMessageReceived</a>(<span class="keyword">self</span>,peer);
<a name="l00582"></a>00582                                 }
<a name="l00583"></a>00583                                 <span class="keywordflow">return</span>;
<a name="l00584"></a>00584                 }
<a name="l00585"></a>00585         }
<a name="l00586"></a>00586 }
<a name="l00587"></a><a class="code" href="_network_communicator_8c.html#afb4864bcc2ab71e022d0c89c069163e1">00587</a> <span class="keywordtype">void</span> <a class="code" href="_network_communicator_8c.html#afb4864bcc2ab71e022d0c89c069163e1">NetworkCommunicatorOnCanSend</a>(<span class="keywordtype">void</span> * vself,<span class="keywordtype">void</span> * vpeer){
<a name="l00588"></a>00588         <a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span> = vself;
<a name="l00589"></a>00589         <a class="code" href="struct_peer.html" title="Structure for Peer objects.">Peer</a> * peer = vpeer;
<a name="l00590"></a>00590         <span class="keywordtype">boolean</span> finished = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l00591"></a>00591         <span class="comment">// Can now send data</span>
<a name="l00592"></a>00592         <span class="keywordflow">if</span> (! peer-&gt;<a class="code" href="struct_peer.html#a08a8c76a45368d56ae7a77584b487be3">sentHeader</a>) {
<a name="l00593"></a>00593                 <span class="comment">// Need to send the header</span>
<a name="l00594"></a>00594                 <span class="keywordflow">if</span> (! peer-&gt;<a class="code" href="struct_peer.html#a05e1401beec06fa14ef159e6262f7276">messageSent</a>) {
<a name="l00595"></a>00595                         <span class="comment">// Create header</span>
<a name="l00596"></a>00596                         peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a> = malloc(24);
<a name="l00597"></a>00597                         <span class="keywordflow">if</span> (! peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a>) {
<a name="l00598"></a>00598                                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 0, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l00599"></a>00599                                 <span class="keywordflow">return</span>;
<a name="l00600"></a>00600                         }
<a name="l00601"></a>00601                         peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a>[0] = <span class="keyword">self</span>-&gt;networkID;
<a name="l00602"></a>00602                         peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a>[1] = <span class="keyword">self</span>-&gt;networkID &gt;&gt; 8;
<a name="l00603"></a>00603                         peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a>[2] = <span class="keyword">self</span>-&gt;networkID &gt;&gt; 16;
<a name="l00604"></a>00604                         peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a>[3] = <span class="keyword">self</span>-&gt;networkID &gt;&gt; 24;
<a name="l00605"></a>00605                         <span class="comment">// Get the message we are sending.</span>
<a name="l00606"></a>00606                         <a class="code" href="struct_message.html" title="Structure for Message objects.">Message</a> * toSend = peer-&gt;<a class="code" href="struct_peer.html#a9f5dd03f71df9908687cab39f0b3d246">sendQueue</a>[peer-&gt;<a class="code" href="struct_peer.html#a5de2ec8c298b8207f0b15baea86f67de">sendQueueFront</a>];
<a name="l00607"></a>00607                         <span class="comment">// Message type text</span>
<a name="l00608"></a>00608                         <span class="keywordflow">switch</span> (toSend-&gt;<a class="code" href="struct_message.html#a8a2053c7fb1adf60da2f26c06059539e">type</a>) {
<a name="l00609"></a>00609                                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a6b5d45c74743b18c5191ca991c8424ba">MESSAGE_TYPE_VERSION</a>:
<a name="l00610"></a>00610                                         memcpy(peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a> + 4, <span class="stringliteral">&quot;version\0\0\0\0\0&quot;</span>, 12);
<a name="l00611"></a>00611                                         <span class="keywordflow">break</span>;
<a name="l00612"></a>00612                                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ab04a1ce83c41d3c309a7e88c5e0c6d14">MESSAGE_TYPE_VERACK</a>:
<a name="l00613"></a>00613                                         memcpy(peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a> + 4, <span class="stringliteral">&quot;verack\0\0\0\0\0\0&quot;</span>, 12);
<a name="l00614"></a>00614                                         <span class="keywordflow">break</span>;
<a name="l00615"></a>00615                                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a1ca0c8f3ae33849b0a2c940aa99b4d19">MESSAGE_TYPE_ADDR</a>:
<a name="l00616"></a>00616                                         memcpy(peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a> + 4, <span class="stringliteral">&quot;addr\0\0\0\0\0\0\0\0&quot;</span>, 12);
<a name="l00617"></a>00617                                         <span class="keywordflow">break</span>;
<a name="l00618"></a>00618                                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a68775d2b5fa0faa7e0a1465913f63832">MESSAGE_TYPE_INV</a>:
<a name="l00619"></a>00619                                         memcpy(peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a> + 4, <span class="stringliteral">&quot;inv\0\0\0\0\0\0\0\0\0&quot;</span>, 12);
<a name="l00620"></a>00620                                         <span class="keywordflow">break</span>;
<a name="l00621"></a>00621                                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a60a5f950b28f7fda0cadda008f3dd0fb">MESSAGE_TYPE_GETDATA</a>:
<a name="l00622"></a>00622                                         memcpy(peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a> + 4, <span class="stringliteral">&quot;getdata\0\0\0\0\0&quot;</span>, 12);
<a name="l00623"></a>00623                                         <span class="keywordflow">break</span>;
<a name="l00624"></a>00624                                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a71f1ccf1984513158376b467b8a8fd8f">MESSAGE_TYPE_GETBLOCKS</a>:
<a name="l00625"></a>00625                                         memcpy(peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a> + 4, <span class="stringliteral">&quot;getblocks\0\0\0&quot;</span>, 12);
<a name="l00626"></a>00626                                         <span class="keywordflow">break</span>;
<a name="l00627"></a>00627                                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ad72a28239ffad586624aff5a499db934">MESSAGE_TYPE_GETHEADERS</a>:
<a name="l00628"></a>00628                                         memcpy(peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a> + 4, <span class="stringliteral">&quot;getheaders\0\0&quot;</span>, 12);
<a name="l00629"></a>00629                                         <span class="keywordflow">break</span>;
<a name="l00630"></a>00630                                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ad33de861150e172a4f14ec7ac179d419">MESSAGE_TYPE_TX</a>:
<a name="l00631"></a>00631                                         memcpy(peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a> + 4, <span class="stringliteral">&quot;tx\0\0\0\0\0\0\0\0\0\0&quot;</span>, 12);
<a name="l00632"></a>00632                                         <span class="keywordflow">break</span>;
<a name="l00633"></a>00633                                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013aca5db57e84e42bb3fed6308f2ec8d36e">MESSAGE_TYPE_BLOCK</a>:
<a name="l00634"></a>00634                                         memcpy(peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a> + 4, <span class="stringliteral">&quot;block\0\0\0\0\0\0\0&quot;</span>, 12);
<a name="l00635"></a>00635                                         <span class="keywordflow">break</span>;
<a name="l00636"></a>00636                                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ac17b04d976b7c8f35bcafa762b1e1a22">MESSAGE_TYPE_HEADERS</a>:
<a name="l00637"></a>00637                                         memcpy(peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a> + 4, <span class="stringliteral">&quot;headers\0\0\0\0\0&quot;</span>, 12);
<a name="l00638"></a>00638                                         <span class="keywordflow">break</span>;
<a name="l00639"></a>00639                                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ab7a4ea5ef99171707a6cd4b0b8027b41">MESSAGE_TYPE_GETADDR</a>:
<a name="l00640"></a>00640                                         memcpy(peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a> + 4, <span class="stringliteral">&quot;getaddr\0\0\0\0\0&quot;</span>, 12);
<a name="l00641"></a>00641                                         <span class="keywordflow">break</span>;
<a name="l00642"></a>00642                                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a72e87e96bdee95a2bd515e751a711994">MESSAGE_TYPE_PING</a>:
<a name="l00643"></a>00643                                         memcpy(peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a> + 4, <span class="stringliteral">&quot;ping\0\0\0\0\0\0\0\0&quot;</span>, 12);
<a name="l00644"></a>00644                                         <span class="keywordflow">break</span>;
<a name="l00645"></a>00645                                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013afbac2e84f45320bd443953d336d7f5ae">MESSAGE_TYPE_PONG</a>:
<a name="l00646"></a>00646                                         memcpy(peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a> + 4, <span class="stringliteral">&quot;pong\0\0\0\0\0\0\0\0&quot;</span>, 12);
<a name="l00647"></a>00647                                         <span class="keywordflow">break</span>;
<a name="l00648"></a>00648                                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a3162346b1761cce7cacd667422618e48">MESSAGE_TYPE_ALERT</a>:
<a name="l00649"></a>00649                                         memcpy(peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a> + 4, <span class="stringliteral">&quot;alert\0\0\0\0\0\0\0&quot;</span>, 12);
<a name="l00650"></a>00650                                         <span class="keywordflow">break</span>;
<a name="l00651"></a>00651                                 <span class="keywordflow">default</span>:
<a name="l00652"></a>00652                                         memcpy(peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a> + 4, toSend-&gt;<a class="code" href="struct_message.html#ad4a1b71852a8721ee4be4f6aaacd8566">altText</a>, 12);
<a name="l00653"></a>00653                                         <span class="keywordflow">break</span>;
<a name="l00654"></a>00654                         }
<a name="l00655"></a>00655                         <span class="comment">// Length</span>
<a name="l00656"></a>00656                         <span class="keywordflow">if</span> (toSend-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>){
<a name="l00657"></a>00657                                 peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a>[16] = toSend-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>-&gt;<a class="code" href="struct_byte_array.html#aebb70c2aab3407a9f05334c47131a43b">length</a>;
<a name="l00658"></a>00658                                 peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a>[17] = toSend-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>-&gt;<a class="code" href="struct_byte_array.html#aebb70c2aab3407a9f05334c47131a43b">length</a> &gt;&gt; 8;
<a name="l00659"></a>00659                                 peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a>[18] = toSend-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>-&gt;<a class="code" href="struct_byte_array.html#aebb70c2aab3407a9f05334c47131a43b">length</a> &gt;&gt; 16;
<a name="l00660"></a>00660                                 peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a>[19] = toSend-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>-&gt;<a class="code" href="struct_byte_array.html#aebb70c2aab3407a9f05334c47131a43b">length</a> &gt;&gt; 24;
<a name="l00661"></a>00661                         }<span class="keywordflow">else</span>{
<a name="l00662"></a>00662                                 memset(peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a> + 16, 0, 4);
<a name="l00663"></a>00663                         }
<a name="l00664"></a>00664                         <span class="comment">// Checksum</span>
<a name="l00665"></a>00665                         peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a>[20] = toSend-&gt;<a class="code" href="struct_message.html#a02d93e565ee31bda6e0211dca9b42be5">checksum</a>[0];
<a name="l00666"></a>00666                         peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a>[21] = toSend-&gt;<a class="code" href="struct_message.html#a02d93e565ee31bda6e0211dca9b42be5">checksum</a>[1];
<a name="l00667"></a>00667                         peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a>[22] = toSend-&gt;<a class="code" href="struct_message.html#a02d93e565ee31bda6e0211dca9b42be5">checksum</a>[2];
<a name="l00668"></a>00668                         peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a>[23] = toSend-&gt;<a class="code" href="struct_message.html#a02d93e565ee31bda6e0211dca9b42be5">checksum</a>[3];
<a name="l00669"></a>00669                 }
<a name="l00670"></a>00670                 int32_t len = SocketSend(peer-&gt;<a class="code" href="struct_peer.html#a647a5a5d74637603d6c684e22f0a69b7">socketID</a>, peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a> + peer-&gt;<a class="code" href="struct_peer.html#a05e1401beec06fa14ef159e6262f7276">messageSent</a>, 24 - peer-&gt;<a class="code" href="struct_peer.html#a05e1401beec06fa14ef159e6262f7276">messageSent</a>);
<a name="l00671"></a>00671                 <span class="keywordflow">if</span> (len == <a class="code" href="_constants_8h.html#a6e91ae3014e3b5615c3945dea5cfcd77">SOCKET_FAILURE</a>) {
<a name="l00672"></a>00672                         free(peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a>);
<a name="l00673"></a>00673                         <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 0, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l00674"></a>00674                 }<span class="keywordflow">else</span>{
<a name="l00675"></a>00675                         peer-&gt;<a class="code" href="struct_peer.html#a05e1401beec06fa14ef159e6262f7276">messageSent</a> += len;
<a name="l00676"></a>00676                         <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#a05e1401beec06fa14ef159e6262f7276">messageSent</a> == 24) {
<a name="l00677"></a>00677                                 <span class="comment">// Done header</span>
<a name="l00678"></a>00678                                 free(peer-&gt;<a class="code" href="struct_peer.html#ada8517e18b834536bf58ab0eeb17f144">sendingHeader</a>);
<a name="l00679"></a>00679                                 <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#a9f5dd03f71df9908687cab39f0b3d246">sendQueue</a>[peer-&gt;<a class="code" href="struct_peer.html#a5de2ec8c298b8207f0b15baea86f67de">sendQueueFront</a>]-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>) {
<a name="l00680"></a>00680                                         <span class="comment">// Now send the bytes</span>
<a name="l00681"></a>00681                                         peer-&gt;<a class="code" href="struct_peer.html#a05e1401beec06fa14ef159e6262f7276">messageSent</a> = 0;
<a name="l00682"></a>00682                                         peer-&gt;<a class="code" href="struct_peer.html#a08a8c76a45368d56ae7a77584b487be3">sentHeader</a> = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00683"></a>00683                                 }<span class="keywordflow">else</span>{
<a name="l00684"></a>00684                                         <span class="comment">// Nothing more to send!</span>
<a name="l00685"></a>00685                                         finished = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00686"></a>00686                                 }
<a name="l00687"></a>00687                         }
<a name="l00688"></a>00688                 }
<a name="l00689"></a>00689         }<span class="keywordflow">else</span>{
<a name="l00690"></a>00690                 <span class="comment">// Sent header</span>
<a name="l00691"></a>00691                 int32_t len = SocketSend(peer-&gt;<a class="code" href="struct_peer.html#a647a5a5d74637603d6c684e22f0a69b7">socketID</a>, ByteArrayGetData(peer-&gt;<a class="code" href="struct_peer.html#a9f5dd03f71df9908687cab39f0b3d246">sendQueue</a>[peer-&gt;<a class="code" href="struct_peer.html#a5de2ec8c298b8207f0b15baea86f67de">sendQueueFront</a>]-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>) + peer-&gt;<a class="code" href="struct_peer.html#a05e1401beec06fa14ef159e6262f7276">messageSent</a>, peer-&gt;<a class="code" href="struct_peer.html#a9f5dd03f71df9908687cab39f0b3d246">sendQueue</a>[peer-&gt;<a class="code" href="struct_peer.html#a5de2ec8c298b8207f0b15baea86f67de">sendQueueFront</a>]-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>-&gt;<a class="code" href="struct_byte_array.html#aebb70c2aab3407a9f05334c47131a43b">length</a> - peer-&gt;<a class="code" href="struct_peer.html#a05e1401beec06fa14ef159e6262f7276">messageSent</a>);
<a name="l00692"></a>00692                 <span class="keywordflow">if</span> (len == <a class="code" href="_constants_8h.html#a6e91ae3014e3b5615c3945dea5cfcd77">SOCKET_FAILURE</a>)
<a name="l00693"></a>00693                         <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 0, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l00694"></a>00694                 <span class="keywordflow">else</span>{
<a name="l00695"></a>00695                         peer-&gt;<a class="code" href="struct_peer.html#a05e1401beec06fa14ef159e6262f7276">messageSent</a> += len;
<a name="l00696"></a>00696                         <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#a05e1401beec06fa14ef159e6262f7276">messageSent</a> == peer-&gt;<a class="code" href="struct_peer.html#a9f5dd03f71df9908687cab39f0b3d246">sendQueue</a>[peer-&gt;<a class="code" href="struct_peer.html#a5de2ec8c298b8207f0b15baea86f67de">sendQueueFront</a>]-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>-&gt;<a class="code" href="struct_byte_array.html#aebb70c2aab3407a9f05334c47131a43b">length</a>)
<a name="l00697"></a>00697                                 <span class="comment">// Sent the entire payload. Celebrate with some bonbonbonbons: http://www.youtube.com/watch?v=VWgwJfbeCeU</span>
<a name="l00698"></a>00698                                 finished = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00699"></a>00699                 }
<a name="l00700"></a>00700         }
<a name="l00701"></a>00701         <span class="keywordflow">if</span> (finished) {
<a name="l00702"></a>00702                 <span class="comment">// Reset variables for next send.</span>
<a name="l00703"></a>00703                 peer-&gt;<a class="code" href="struct_peer.html#a05e1401beec06fa14ef159e6262f7276">messageSent</a> = 0;
<a name="l00704"></a>00704                 peer-&gt;<a class="code" href="struct_peer.html#a08a8c76a45368d56ae7a77584b487be3">sentHeader</a> = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l00705"></a>00705                 <span class="comment">// Done sending message.</span>
<a name="l00706"></a>00706                 <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#a9f5dd03f71df9908687cab39f0b3d246">sendQueue</a>[peer-&gt;<a class="code" href="struct_peer.html#a5de2ec8c298b8207f0b15baea86f67de">sendQueueFront</a>]-&gt;<a class="code" href="struct_message.html#accc3616411ea4a5035a7eaf42132d370">expectResponse</a>){
<a name="l00707"></a>00707                         SocketAddEvent(peer-&gt;<a class="code" href="struct_peer.html#a85ce08843ff1aa2d229844758849e4d0">receiveEvent</a>, self-&gt;responseTimeOut); <span class="comment">// Expect response.</span>
<a name="l00708"></a>00708                         <span class="comment">// Add to list of expected responses.</span>
<a name="l00709"></a>00709                         <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#ace34e7aeaf71b71aa83205abf9c43e58">typesExpectedNum</a> == <a class="code" href="_constants_8h.html#a849d03d1deb04c14b698a3acdde1a669">MAX_RESPONSES_EXPECTED</a>) {
<a name="l00710"></a>00710                                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, <a class="code" href="_constants_8h.html#a4994f3036527b434b39b825d8f60061d">_24_HOURS</a>, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l00711"></a>00711                                 <span class="keywordflow">return</span>;
<a name="l00712"></a>00712                         }
<a name="l00713"></a>00713                         peer-&gt;<a class="code" href="struct_peer.html#af5084c560793a36f0b75364955235935">typesExpected</a>[peer-&gt;<a class="code" href="struct_peer.html#ace34e7aeaf71b71aa83205abf9c43e58">typesExpectedNum</a>] = peer-&gt;<a class="code" href="struct_peer.html#a9f5dd03f71df9908687cab39f0b3d246">sendQueue</a>[peer-&gt;<a class="code" href="struct_peer.html#a5de2ec8c298b8207f0b15baea86f67de">sendQueueFront</a>]-&gt;<a class="code" href="struct_message.html#accc3616411ea4a5035a7eaf42132d370">expectResponse</a>;
<a name="l00714"></a>00714                         peer-&gt;<a class="code" href="struct_peer.html#ace34e7aeaf71b71aa83205abf9c43e58">typesExpectedNum</a>++;
<a name="l00715"></a>00715                         <span class="comment">// Start timer for latency measurement, if not already waiting.</span>
<a name="l00716"></a>00716                         <span class="keywordflow">if</span> (! peer-&gt;<a class="code" href="struct_peer.html#ae82e79c24bed68a7cd9947606aa9ff70">latencyTimerStart</a>){
<a name="l00717"></a>00717                                 peer-&gt;<a class="code" href="struct_peer.html#ae82e79c24bed68a7cd9947606aa9ff70">latencyTimerStart</a> = clock();
<a name="l00718"></a>00718                                 peer-&gt;<a class="code" href="struct_peer.html#a0c7b11a94f0a363815fb5953af0cdf41">latencyExpected</a> = peer-&gt;<a class="code" href="struct_peer.html#a9f5dd03f71df9908687cab39f0b3d246">sendQueue</a>[peer-&gt;<a class="code" href="struct_peer.html#a5de2ec8c298b8207f0b15baea86f67de">sendQueueFront</a>]-&gt;<a class="code" href="struct_message.html#accc3616411ea4a5035a7eaf42132d370">expectResponse</a>;
<a name="l00719"></a>00719                         }
<a name="l00720"></a>00720                 }
<a name="l00721"></a>00721                 <span class="comment">// Remove message from queue.</span>
<a name="l00722"></a>00722                 peer-&gt;<a class="code" href="struct_peer.html#a174a94f3843e505bba89c449f91c278d">sendQueueSize</a>--;
<a name="l00723"></a>00723                 <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(peer-&gt;<a class="code" href="struct_peer.html#a9f5dd03f71df9908687cab39f0b3d246">sendQueue</a>[peer-&gt;<a class="code" href="struct_peer.html#a5de2ec8c298b8207f0b15baea86f67de">sendQueueFront</a>]);
<a name="l00724"></a>00724                 <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#a174a94f3843e505bba89c449f91c278d">sendQueueSize</a>) {
<a name="l00725"></a>00725                         peer-&gt;<a class="code" href="struct_peer.html#a5de2ec8c298b8207f0b15baea86f67de">sendQueueFront</a>++;
<a name="l00726"></a>00726                         <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#a5de2ec8c298b8207f0b15baea86f67de">sendQueueFront</a> == SEND_QUEUEMAX_SIZE) {
<a name="l00727"></a>00727                                 peer-&gt;<a class="code" href="struct_peer.html#a5de2ec8c298b8207f0b15baea86f67de">sendQueueFront</a> = 0;
<a name="l00728"></a>00728                         }
<a name="l00729"></a>00729                 }<span class="keywordflow">else</span>{
<a name="l00730"></a>00730                         <span class="comment">// Remove send event as we have nothing left to send</span>
<a name="l00731"></a>00731                         SocketRemoveEvent(peer-&gt;<a class="code" href="struct_peer.html#a69ff2e0990f9ab719a6747dcc613ef80">sendEvent</a>);
<a name="l00732"></a>00732                 }
<a name="l00733"></a>00733         }
<a name="l00734"></a>00734 }
<a name="l00735"></a><a class="code" href="_network_communicator_8c.html#a3c2373b9fdccdb79d21f4bdb0421db2a">00735</a> <span class="keywordtype">void</span> <a class="code" href="_network_communicator_8c.html#a3c2373b9fdccdb79d21f4bdb0421db2a">NetworkCommunicatorOnHeaderRecieved</a>(<a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span>,<a class="code" href="struct_peer.html" title="Structure for Peer objects.">Peer</a> * peer){
<a name="l00736"></a>00736         <span class="comment">// Make a ByteArray. ??? Could be modified not to use a ByteArray, but it is cleaner this way and easier to maintain.</span>
<a name="l00737"></a>00737         <a class="code" href="struct_byte_array.html" title="Structure for ByteArray objects.">ByteArray</a> * header = NewByteArrayWithData(peer-&gt;<a class="code" href="struct_peer.html#ab6d7934a111f8c73cf69b983f09195e3">headerBuffer</a>, 24, self-&gt;onErrorReceived);
<a name="l00738"></a>00738         <span class="keywordflow">if</span> (! header)
<a name="l00739"></a>00739                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 0, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l00740"></a>00740         <span class="keywordflow">if</span> (ByteArrayReadInt32(header, 0) != self-&gt;networkID){
<a name="l00741"></a>00741                 <span class="comment">// The network ID bytes is not what we are looking for. We will have to remove the peer.</span>
<a name="l00742"></a>00742                 <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(header);
<a name="l00743"></a>00743                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, <a class="code" href="_constants_8h.html#a4994f3036527b434b39b825d8f60061d">_24_HOURS</a>, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l00744"></a>00744         }
<a name="l00745"></a>00745         <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013">MessageType</a> type;
<a name="l00746"></a>00746         uint32_t size;
<a name="l00747"></a>00747         <span class="keywordtype">boolean</span> error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l00748"></a>00748         <a class="code" href="struct_byte_array.html" title="Structure for ByteArray objects.">ByteArray</a> * typeBytes = NewByteArraySubReference(header, 4, 12);
<a name="l00749"></a>00749         <span class="keywordflow">if</span> (! typeBytes){
<a name="l00750"></a>00750                 <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(header);
<a name="l00751"></a>00751                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 0, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l00752"></a>00752         }
<a name="l00753"></a>00753         <span class="keywordflow">if</span> (! memcmp(ByteArrayGetData(typeBytes),<span class="stringliteral">&quot;version\0\0\0\0\0&quot;</span>,12)) {
<a name="l00754"></a>00754                 <span class="comment">// Version message</span>
<a name="l00755"></a>00755                 <span class="comment">// Check if we are accepting version messages at the moment.</span>
<a name="l00756"></a>00756                 <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> &amp; <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a6b5d45c74743b18c5191ca991c8424ba">MESSAGE_TYPE_VERSION</a>){
<a name="l00757"></a>00757                         <span class="comment">// Check payload size</span>
<a name="l00758"></a>00758                         size = ByteArrayReadInt32(header, 16);
<a name="l00759"></a>00759                         <span class="keywordflow">if</span> (size &gt; _VERSIONMAX_SIZE) <span class="comment">// Illegal size. cbitcoin will not accept this.</span>
<a name="l00760"></a>00760                                 error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00761"></a>00761                         <span class="keywordflow">else</span>
<a name="l00762"></a>00762                                 type = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a6b5d45c74743b18c5191ca991c8424ba">MESSAGE_TYPE_VERSION</a>;
<a name="l00763"></a>00763                 }<span class="keywordflow">else</span> error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00764"></a>00764         }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (! memcmp(ByteArrayGetData(typeBytes), <span class="stringliteral">&quot;verack\0\0\0\0\0\0&quot;</span>, 12)){
<a name="l00765"></a>00765                 <span class="comment">// Version acknowledgement message</span>
<a name="l00766"></a>00766                 <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> &amp; <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ab04a1ce83c41d3c309a7e88c5e0c6d14">MESSAGE_TYPE_VERACK</a>){
<a name="l00767"></a>00767                         size = ByteArrayReadInt32(header, 16);
<a name="l00768"></a>00768                         <span class="keywordflow">if</span> (size) <span class="comment">// Must contain zero payload.</span>
<a name="l00769"></a>00769                                 error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00770"></a>00770                         <span class="keywordflow">else</span>
<a name="l00771"></a>00771                                 type = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ab04a1ce83c41d3c309a7e88c5e0c6d14">MESSAGE_TYPE_VERACK</a>;
<a name="l00772"></a>00772                 }<span class="keywordflow">else</span> error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00773"></a>00773         }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (! memcmp(ByteArrayGetData(typeBytes), <span class="stringliteral">&quot;addr\0\0\0\0\0\0\0\0&quot;</span>, 12)){
<a name="l00774"></a>00774                 <span class="comment">// Address broadcast message</span>
<a name="l00775"></a>00775                 <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> &amp; <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a1ca0c8f3ae33849b0a2c940aa99b4d19">MESSAGE_TYPE_ADDR</a>){
<a name="l00776"></a>00776                         size = ByteArrayReadInt32(header, 16);
<a name="l00777"></a>00777                         <span class="keywordflow">if</span> (size &gt; _ADDRESS_BROADCASTMAX_SIZE)
<a name="l00778"></a>00778                                 error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00779"></a>00779                         <span class="keywordflow">else</span>
<a name="l00780"></a>00780                                 type = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a1ca0c8f3ae33849b0a2c940aa99b4d19">MESSAGE_TYPE_ADDR</a>;
<a name="l00781"></a>00781                 }<span class="keywordflow">else</span> error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00782"></a>00782         }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (! memcmp(ByteArrayGetData(typeBytes), <span class="stringliteral">&quot;inv\0\0\0\0\0\0\0\0\0&quot;</span>, 12)){
<a name="l00783"></a>00783                 <span class="comment">// Inventory broadcast message</span>
<a name="l00784"></a>00784                 <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> &amp; <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a68775d2b5fa0faa7e0a1465913f63832">MESSAGE_TYPE_INV</a>){
<a name="l00785"></a>00785                         size = ByteArrayReadInt32(header, 16);
<a name="l00786"></a>00786                         <span class="keywordflow">if</span> (size &gt; _INVENTORY_BROADCASTMAX_SIZE)
<a name="l00787"></a>00787                                 error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00788"></a>00788                         <span class="keywordflow">else</span>
<a name="l00789"></a>00789                                 type = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a68775d2b5fa0faa7e0a1465913f63832">MESSAGE_TYPE_INV</a>;
<a name="l00790"></a>00790                 }<span class="keywordflow">else</span> error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00791"></a>00791         }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (! memcmp(ByteArrayGetData(typeBytes), <span class="stringliteral">&quot;getdata\0\0\0\0\0&quot;</span>, 12)){
<a name="l00792"></a>00792                 <span class="comment">// Get data message</span>
<a name="l00793"></a>00793                 <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> &amp; <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a60a5f950b28f7fda0cadda008f3dd0fb">MESSAGE_TYPE_GETDATA</a>){
<a name="l00794"></a>00794                         size = ByteArrayReadInt32(header, 16);
<a name="l00795"></a>00795                         <span class="keywordflow">if</span> (size &gt; _GET_DATAMAX_SIZE)
<a name="l00796"></a>00796                                 error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00797"></a>00797                         <span class="keywordflow">else</span>
<a name="l00798"></a>00798                                 type = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a60a5f950b28f7fda0cadda008f3dd0fb">MESSAGE_TYPE_GETDATA</a>;
<a name="l00799"></a>00799                 }<span class="keywordflow">else</span> error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00800"></a>00800         }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (! memcmp(ByteArrayGetData(typeBytes), <span class="stringliteral">&quot;getblocks\0\0\0&quot;</span>, 12)){
<a name="l00801"></a>00801                 <span class="comment">// Get blocks message</span>
<a name="l00802"></a>00802                 <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> &amp; <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013aca5db57e84e42bb3fed6308f2ec8d36e">MESSAGE_TYPE_BLOCK</a>){
<a name="l00803"></a>00803                         size = ByteArrayReadInt32(header, 16);
<a name="l00804"></a>00804                         <span class="keywordflow">if</span> (size &gt; _GET_BLOCKSMAX_SIZE)
<a name="l00805"></a>00805                                 error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00806"></a>00806                         <span class="keywordflow">else</span>
<a name="l00807"></a>00807                                 type = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a71f1ccf1984513158376b467b8a8fd8f">MESSAGE_TYPE_GETBLOCKS</a>;
<a name="l00808"></a>00808                 }<span class="keywordflow">else</span> error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00809"></a>00809         }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (! memcmp(ByteArrayGetData(typeBytes), <span class="stringliteral">&quot;getheaders\0\0&quot;</span>, 12)){
<a name="l00810"></a>00810                 <span class="comment">// Get headers message</span>
<a name="l00811"></a>00811                 <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> &amp; <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ad72a28239ffad586624aff5a499db934">MESSAGE_TYPE_GETHEADERS</a>){
<a name="l00812"></a>00812                         size = ByteArrayReadInt32(header, 16);
<a name="l00813"></a>00813                         <span class="keywordflow">if</span> (size &gt; _GET_HEADERSMAX_SIZE)
<a name="l00814"></a>00814                                 error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00815"></a>00815                         <span class="keywordflow">else</span>
<a name="l00816"></a>00816                                 type = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ad72a28239ffad586624aff5a499db934">MESSAGE_TYPE_GETHEADERS</a>;
<a name="l00817"></a>00817                 }<span class="keywordflow">else</span> error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00818"></a>00818         }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (! memcmp(ByteArrayGetData(typeBytes), <span class="stringliteral">&quot;tx\0\0\0\0\0\0\0\0\0\0&quot;</span>, 12)){
<a name="l00819"></a>00819                 <span class="comment">// Transaction message</span>
<a name="l00820"></a>00820                 <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> &amp; <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ad33de861150e172a4f14ec7ac179d419">MESSAGE_TYPE_TX</a>){
<a name="l00821"></a>00821                         size = ByteArrayReadInt32(header, 16);
<a name="l00822"></a>00822                         <span class="keywordflow">if</span> (size &gt; TRANSACTIONMAX_SIZE)
<a name="l00823"></a>00823                                 error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00824"></a>00824                         <span class="keywordflow">else</span>
<a name="l00825"></a>00825                                 type = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ad33de861150e172a4f14ec7ac179d419">MESSAGE_TYPE_TX</a>;
<a name="l00826"></a>00826                 }<span class="keywordflow">else</span> error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00827"></a>00827         }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (! memcmp(ByteArrayGetData(typeBytes), <span class="stringliteral">&quot;block\0\0\0\0\0\0\0&quot;</span>, 12)){
<a name="l00828"></a>00828                 <span class="comment">// Block message</span>
<a name="l00829"></a>00829                 <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> &amp; <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013aca5db57e84e42bb3fed6308f2ec8d36e">MESSAGE_TYPE_BLOCK</a>){
<a name="l00830"></a>00830                         size = ByteArrayReadInt32(header, 16);
<a name="l00831"></a>00831                         <span class="keywordflow">if</span> (size &gt; _BLOCKMAX_SIZE + 89) <span class="comment">// Plus 89 for header.</span>
<a name="l00832"></a>00832                                 error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00833"></a>00833                         <span class="keywordflow">else</span>
<a name="l00834"></a>00834                                 type = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013aca5db57e84e42bb3fed6308f2ec8d36e">MESSAGE_TYPE_BLOCK</a>;
<a name="l00835"></a>00835                 }<span class="keywordflow">else</span> error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00836"></a>00836         }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (! memcmp(ByteArrayGetData(typeBytes), <span class="stringliteral">&quot;headers\0\0\0\0\0&quot;</span>, 12)){
<a name="l00837"></a>00837                 <span class="comment">// Block headers message</span>
<a name="l00838"></a>00838                 <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> &amp; <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ac17b04d976b7c8f35bcafa762b1e1a22">MESSAGE_TYPE_HEADERS</a>){
<a name="l00839"></a>00839                         size = ByteArrayReadInt32(header, 16);
<a name="l00840"></a>00840                         <span class="keywordflow">if</span> (size &gt; _BLOCK_HEADERSMAX_SIZE)
<a name="l00841"></a>00841                                 error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00842"></a>00842                         <span class="keywordflow">else</span>
<a name="l00843"></a>00843                                 type = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ac17b04d976b7c8f35bcafa762b1e1a22">MESSAGE_TYPE_HEADERS</a>;
<a name="l00844"></a>00844                 }<span class="keywordflow">else</span> error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00845"></a>00845         }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (! memcmp(ByteArrayGetData(typeBytes), <span class="stringliteral">&quot;getaddr\0\0\0\0\0&quot;</span>, 12)){
<a name="l00846"></a>00846                 <span class="comment">// Get Addresses message</span>
<a name="l00847"></a>00847                 <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> &amp; <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ab7a4ea5ef99171707a6cd4b0b8027b41">MESSAGE_TYPE_GETADDR</a>){
<a name="l00848"></a>00848                         size = ByteArrayReadInt32(header, 16);
<a name="l00849"></a>00849                         <span class="keywordflow">if</span> (size) <span class="comment">// Should be empty</span>
<a name="l00850"></a>00850                                 error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00851"></a>00851                         <span class="keywordflow">else</span>
<a name="l00852"></a>00852                                 type = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ab7a4ea5ef99171707a6cd4b0b8027b41">MESSAGE_TYPE_GETADDR</a>;
<a name="l00853"></a>00853                 }<span class="keywordflow">else</span> error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00854"></a>00854         }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (! memcmp(ByteArrayGetData(typeBytes), <span class="stringliteral">&quot;ping\0\0\0\0\0\0\0\0&quot;</span>, 12)){
<a name="l00855"></a>00855                 <span class="comment">// Ping message</span>
<a name="l00856"></a>00856                 <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> &amp; <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a72e87e96bdee95a2bd515e751a711994">MESSAGE_TYPE_PING</a>){
<a name="l00857"></a>00857                         size = ByteArrayReadInt32(header, 16);
<a name="l00858"></a>00858                         <span class="keywordflow">if</span> (size &gt; 8 || ((peer-&gt;<a class="code" href="struct_peer.html#a3621dcfbd15278c25b8bc1279eab0f61">versionMessage</a>-&gt;<a class="code" href="struct_version.html#a67fae7dd1de9edce3656ed214d20377f">version</a> &lt; <a class="code" href="_constants_8h.html#aa4ebef19a712ada26c9e4227a272c89f">PONG_VERSION</a> || self-&gt;version &lt; <a class="code" href="_constants_8h.html#aa4ebef19a712ada26c9e4227a272c89f">PONG_VERSION</a>) &amp;&amp; size)) <span class="comment">// Should be empty before version 60000 or 8 bytes.</span>
<a name="l00859"></a>00859                                 error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00860"></a>00860                         <span class="keywordflow">else</span>
<a name="l00861"></a>00861                                 type = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a72e87e96bdee95a2bd515e751a711994">MESSAGE_TYPE_PING</a>;
<a name="l00862"></a>00862                 }<span class="keywordflow">else</span> error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00863"></a>00863         }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (! memcmp(ByteArrayGetData(typeBytes), <span class="stringliteral">&quot;pong\0\0\0\0\0\0\0\0&quot;</span>, 12)){
<a name="l00864"></a>00864                 <span class="comment">// Pong message</span>
<a name="l00865"></a>00865                 <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> &amp; <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013afbac2e84f45320bd443953d336d7f5ae">MESSAGE_TYPE_PONG</a>){
<a name="l00866"></a>00866                         size = ByteArrayReadInt32(header, 16);
<a name="l00867"></a>00867                         <span class="keywordflow">if</span> (size &gt; 8)
<a name="l00868"></a>00868                                 error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00869"></a>00869                         <span class="keywordflow">else</span>
<a name="l00870"></a>00870                                 type = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013afbac2e84f45320bd443953d336d7f5ae">MESSAGE_TYPE_PONG</a>;
<a name="l00871"></a>00871                 }<span class="keywordflow">else</span> error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00872"></a>00872         }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (! memcmp(ByteArrayGetData(typeBytes), <span class="stringliteral">&quot;alert\0\0\0\0\0\0\0&quot;</span>, 12)){
<a name="l00873"></a>00873                 <span class="comment">// Alert message</span>
<a name="l00874"></a>00874                 <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#aae6fec01f79ff2871c3f1dca438d6b99">acceptedTypes</a> &amp; <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a3162346b1761cce7cacd667422618e48">MESSAGE_TYPE_ALERT</a>){
<a name="l00875"></a>00875                         size = ByteArrayReadInt32(header, 16);
<a name="l00876"></a>00876                         <span class="keywordflow">if</span> (size &gt; _ALERTMAX_SIZE)
<a name="l00877"></a>00877                                 error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00878"></a>00878                         <span class="keywordflow">else</span>
<a name="l00879"></a>00879                                 type = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a3162346b1761cce7cacd667422618e48">MESSAGE_TYPE_ALERT</a>;
<a name="l00880"></a>00880                 }<span class="keywordflow">else</span> error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00881"></a>00881         }<span class="keywordflow">else</span>{
<a name="l00882"></a>00882                 <span class="comment">// Either alternative or invalid</span>
<a name="l00883"></a>00883                 error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>; <span class="comment">// Default error until OK alternative message found.</span>
<a name="l00884"></a>00884                 <span class="keywordflow">if</span> (self-&gt;alternativeMessages) {
<a name="l00885"></a>00885                         <span class="keywordflow">for</span> (uint16_t x = 0; x &lt; <span class="keyword">self</span>-&gt;alternativeMessages-&gt;length / 12; x++) {
<a name="l00886"></a>00886                                 <span class="comment">// Check this alternative message</span>
<a name="l00887"></a>00887                                 <span class="keywordflow">if</span> (! memcmp(ByteArrayGetData(typeBytes), ByteArrayGetData(self-&gt;alternativeMessages) + 12 * x, 12)){
<a name="l00888"></a>00888                                         <span class="comment">// Alternative message</span>
<a name="l00889"></a>00889                                         type = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013adf95c068ca534fc0ab73fc61d95473b8">MESSAGE_TYPE_ALT</a>;
<a name="l00890"></a>00890                                         <span class="comment">// Check payload size</span>
<a name="l00891"></a>00891                                         size = ByteArrayReadInt32(header, 16);
<a name="l00892"></a>00892                                         uint32_t altSize;
<a name="l00893"></a>00893                                         <span class="keywordflow">if</span> (self-&gt;altMaxSizes)
<a name="l00894"></a>00894                                                 altSize = <span class="keyword">self</span>-&gt;altMaxSizes[x];
<a name="l00895"></a>00895                                         <span class="keywordflow">else</span>
<a name="l00896"></a>00896                                                 altSize = _BLOCKMAX_SIZE;
<a name="l00897"></a>00897                                         <span class="keywordflow">if</span> (size &lt;= altSize) <span class="comment">// Should correspond to the user given value</span>
<a name="l00898"></a>00898                                                 error = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l00899"></a>00899                                         <span class="keywordflow">break</span>;
<a name="l00900"></a>00900                                 }
<a name="l00901"></a>00901                         }
<a name="l00902"></a>00902                 }
<a name="l00903"></a>00903         }
<a name="l00904"></a>00904         <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(typeBytes);
<a name="l00905"></a>00905         <span class="keywordflow">if</span> (error) {
<a name="l00906"></a>00906                 <span class="comment">// Error with the message header type or length</span>
<a name="l00907"></a>00907                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, <a class="code" href="_constants_8h.html#a4994f3036527b434b39b825d8f60061d">_24_HOURS</a>, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l00908"></a>00908                 <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(header);
<a name="l00909"></a>00909         }
<a name="l00910"></a>00910         <span class="comment">// If this is a response we have been waiting for, no longer wait for it</span>
<a name="l00911"></a>00911         <span class="keywordflow">for</span> (uint8_t x = 0; x &lt; peer-&gt;<a class="code" href="struct_peer.html#ace34e7aeaf71b71aa83205abf9c43e58">typesExpectedNum</a>; x++) {
<a name="l00912"></a>00912                 <span class="keywordflow">if</span> (type == peer-&gt;<a class="code" href="struct_peer.html#af5084c560793a36f0b75364955235935">typesExpected</a>[x]) {
<a name="l00913"></a>00913                         <span class="comment">// Record latency</span>
<a name="l00914"></a>00914                         <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#ae82e79c24bed68a7cd9947606aa9ff70">latencyTimerStart</a> &amp;&amp; peer-&gt;<a class="code" href="struct_peer.html#a0c7b11a94f0a363815fb5953af0cdf41">latencyExpected</a> == type) {
<a name="l00915"></a>00915                                 peer-&gt;<a class="code" href="struct_peer.html#a847dca6554901b2ed0a2353f8d780fb2">latencyTime</a> += clock() - peer-&gt;<a class="code" href="struct_peer.html#ae82e79c24bed68a7cd9947606aa9ff70">latencyTimerStart</a>;
<a name="l00916"></a>00916                                 peer-&gt;<a class="code" href="struct_peer.html#a63cfe28fe10e7a2cd516d142787acb71">responses</a>++;
<a name="l00917"></a>00917                                 peer-&gt;<a class="code" href="struct_peer.html#ae82e79c24bed68a7cd9947606aa9ff70">latencyTimerStart</a> = 0;
<a name="l00918"></a>00918                         }
<a name="l00919"></a>00919                         <span class="comment">// Remove</span>
<a name="l00920"></a>00920                         <span class="keywordtype">boolean</span> <span class="keyword">remove</span> = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00921"></a>00921                         <span class="keywordflow">if</span> (self-&gt;flags &amp; <a class="code" href="_constants_8h.html#a6f2291d55f4d124937956e160c5d9792a6405a3fe5f130506115dbb845a516cbf">NETWORK_COMMUNICATOR_AUTO_HANDSHAKE</a>)
<a name="l00922"></a>00922                                 <span class="keywordflow">if</span> (type == <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ab04a1ce83c41d3c309a7e88c5e0c6d14">MESSAGE_TYPE_VERACK</a> &amp;&amp; ! peer-&gt;<a class="code" href="struct_peer.html#a3621dcfbd15278c25b8bc1279eab0f61">versionMessage</a>){
<a name="l00923"></a>00923                                         <span class="comment">// We expect the version</span>
<a name="l00924"></a>00924                                         peer-&gt;<a class="code" href="struct_peer.html#af5084c560793a36f0b75364955235935">typesExpected</a>[x] = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a6b5d45c74743b18c5191ca991c8424ba">MESSAGE_TYPE_VERSION</a>;
<a name="l00925"></a>00925                                         <span class="keyword">remove</span> = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l00926"></a>00926                                 }
<a name="l00927"></a>00927                         <span class="keywordflow">if</span> (<span class="keyword">remove</span>) {
<a name="l00928"></a>00928                                 peer-&gt;<a class="code" href="struct_peer.html#ace34e7aeaf71b71aa83205abf9c43e58">typesExpectedNum</a>--;
<a name="l00929"></a>00929                                 memmove(peer-&gt;<a class="code" href="struct_peer.html#af5084c560793a36f0b75364955235935">typesExpected</a> + x, peer-&gt;<a class="code" href="struct_peer.html#af5084c560793a36f0b75364955235935">typesExpected</a> + x + 1, peer-&gt;<a class="code" href="struct_peer.html#ace34e7aeaf71b71aa83205abf9c43e58">typesExpectedNum</a> - x);
<a name="l00930"></a>00930                         }
<a name="l00931"></a>00931                         <span class="keywordflow">break</span>;
<a name="l00932"></a>00932                 }
<a name="l00933"></a>00933         }
<a name="l00934"></a>00934         <span class="comment">// The type and size is OK, make the messagem</span>
<a name="l00935"></a>00935         peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#a8a2053c7fb1adf60da2f26c06059539e">type</a> = type;
<a name="l00936"></a>00936         <span class="comment">// Get checksum</span>
<a name="l00937"></a>00937         peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#a02d93e565ee31bda6e0211dca9b42be5">checksum</a>[0] = ByteArrayGetByte(header, 20);
<a name="l00938"></a>00938         peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#a02d93e565ee31bda6e0211dca9b42be5">checksum</a>[1] = ByteArrayGetByte(header, 21);
<a name="l00939"></a>00939         peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#a02d93e565ee31bda6e0211dca9b42be5">checksum</a>[2] = ByteArrayGetByte(header, 22);
<a name="l00940"></a>00940         peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#a02d93e565ee31bda6e0211dca9b42be5">checksum</a>[3] = ByteArrayGetByte(header, 23);
<a name="l00941"></a>00941         <span class="comment">// Message is now ready. Free the header.</span>
<a name="l00942"></a>00942         <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(header); <span class="comment">// Took the header buffer which should be freed here.</span>
<a name="l00943"></a>00943         <span class="keywordflow">if</span> (size) {
<a name="l00944"></a>00944                 peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a> = NewByteArrayOfSize(size,self-&gt;onErrorReceived);
<a name="l00945"></a>00945                 <span class="keywordflow">if</span> (! peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>)
<a name="l00946"></a>00946                         <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 0, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l00947"></a>00947                 <span class="comment">// Change variables for receiving the payload.</span>
<a name="l00948"></a>00948                 peer-&gt;<a class="code" href="struct_peer.html#ac59131671a3d8f296ffc6f5ba6189def">receivedHeader</a> = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l00949"></a>00949                 peer-&gt;<a class="code" href="struct_peer.html#a83bb5a7615bbe1744dcadf6b8f7c297f">messageReceived</a> = 0;
<a name="l00950"></a>00950         }<span class="keywordflow">else</span>
<a name="l00951"></a>00951                 <span class="comment">// Got the message</span>
<a name="l00952"></a>00952                 <a class="code" href="_network_communicator_8c.html#a1e7aeba124b81e6ab5e0661c521a8e78">NetworkCommunicatorOnMessageReceived</a>(<span class="keyword">self</span>,peer);
<a name="l00953"></a>00953 }
<a name="l00954"></a><a class="code" href="_network_communicator_8c.html#a6d6b433343dd2c489fbc6167a1174bdc">00954</a> <span class="keywordtype">void</span> <a class="code" href="_network_communicator_8c.html#a6d6b433343dd2c489fbc6167a1174bdc">NetworkCommunicatorOnLoopError</a>(<span class="keywordtype">void</span> * vself){
<a name="l00955"></a>00955         <a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span> = vself;
<a name="l00956"></a>00956         <a class="code" href="_message_8c.html#a9ab128ae9cafefd9b05e2e0bfa719770" title="getter">getMessage</a>(<span class="keyword">self</span>)-&gt;<a class="code" href="struct_message.html#a3c8af4f580f3041d046b7581f89a9695">onErrorReceived</a>(<a class="code" href="_constants_8h.html#a2c3e4bb40f36b262a5214e2da2bca9c5acf62cedb6da67e77c29ffc2281503f1b">ERROR_NETWORK_COMMUNICATOR_LOOP_FAIL</a>,<span class="stringliteral">&quot;The socket event loop failed. Stoping the NetworkCommunicator...&quot;</span>);
<a name="l00957"></a>00957         <span class="keyword">self</span>-&gt;eventLoop = 0;
<a name="l00958"></a>00958         <a class="code" href="_network_communicator_8c.html#a2375f2b638bfd9e11f5366cd54aeef12">NetworkCommunicatorStop</a>(<span class="keyword">self</span>);
<a name="l00959"></a>00959 }
<a name="l00960"></a><a class="code" href="_network_communicator_8c.html#a1e7aeba124b81e6ab5e0661c521a8e78">00960</a> <span class="keywordtype">void</span> <a class="code" href="_network_communicator_8c.html#a1e7aeba124b81e6ab5e0661c521a8e78">NetworkCommunicatorOnMessageReceived</a>(<a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span>,<a class="code" href="struct_peer.html" title="Structure for Peer objects.">Peer</a> * peer){
<a name="l00961"></a>00961         <span class="comment">// Record download time</span>
<a name="l00962"></a>00962         peer-&gt;<a class="code" href="struct_peer.html#a58568557ae8882a2ec88d201cd6a3ce1">downloadTime</a> += clock() - peer-&gt;<a class="code" href="struct_peer.html#a599a7c398ad8de49e461e94bececb30c">downloadTimerStart</a>;
<a name="l00963"></a>00963         peer-&gt;<a class="code" href="struct_peer.html#ad6fa0de2b45f5a421482f478079adca8">downloadAmount</a> += 24 + (peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a> ? peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>-&gt;<a class="code" href="struct_byte_array.html#aebb70c2aab3407a9f05334c47131a43b">length</a> : 0);
<a name="l00964"></a>00964         <span class="comment">// Change timeout of receive event, depending on wether or not we want more responses.</span>
<a name="l00965"></a>00965         SocketAddEvent(peer-&gt;<a class="code" href="struct_peer.html#a85ce08843ff1aa2d229844758849e4d0">receiveEvent</a>,peer-&gt;<a class="code" href="struct_peer.html#ace34e7aeaf71b71aa83205abf9c43e58">typesExpectedNum</a> ? self-&gt;responseTimeOut : self-&gt;timeOut);
<a name="l00966"></a>00966         <span class="comment">// Check checksum</span>
<a name="l00967"></a>00967         uint8_t hash[32];
<a name="l00968"></a>00968         uint8_t hash2[32];
<a name="l00969"></a>00969         <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>) {
<a name="l00970"></a>00970                 <a class="code" href="_crypt_8c.html#a31002de62901cbe9c88a0fd0f5f57770" title="SHA-256 cryptographic hash function.">Sha256</a>(ByteArrayGetData(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>), peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>-&gt;<a class="code" href="struct_byte_array.html#aebb70c2aab3407a9f05334c47131a43b">length</a>, hash);
<a name="l00971"></a>00971                 <a class="code" href="_crypt_8c.html#a31002de62901cbe9c88a0fd0f5f57770" title="SHA-256 cryptographic hash function.">Sha256</a>(hash, 32, hash2);
<a name="l00972"></a>00972         }<span class="keywordflow">else</span>{
<a name="l00973"></a>00973                 hash2[0] = 0x5D;
<a name="l00974"></a>00974                 hash2[1] = 0xF6;
<a name="l00975"></a>00975                 hash2[2] = 0xE0;
<a name="l00976"></a>00976                 hash2[3] = 0xE2;
<a name="l00977"></a>00977         }
<a name="l00978"></a>00978         <span class="keywordflow">if</span> (memcmp(hash2, peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#a02d93e565ee31bda6e0211dca9b42be5">checksum</a>, 4)) {
<a name="l00979"></a>00979                 <span class="comment">// Checksum failure. There is no excuse for this. Drop the peer. Why have checksums anyway???</span>
<a name="l00980"></a>00980                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 24_HOURS, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l00981"></a>00981                 <span class="keywordflow">return</span>;
<a name="l00982"></a>00982         }
<a name="l00983"></a>00983         <span class="comment">// Deserialise and give the onMessageReceived or onAlternativeMessageReceived event</span>
<a name="l00984"></a>00984         uint32_t len;
<a name="l00985"></a>00985         <span class="keywordflow">switch</span> (peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#a8a2053c7fb1adf60da2f26c06059539e">type</a>) {
<a name="l00986"></a>00986                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a6b5d45c74743b18c5191ca991c8424ba">MESSAGE_TYPE_VERSION</a>:
<a name="l00987"></a>00987                         peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a> = realloc(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>, <span class="keyword">sizeof</span>(<a class="code" href="struct_version.html" title="Structure for Version objects.">Version</a>)); <span class="comment">// For storing additional data</span>
<a name="l00988"></a>00988                         <span class="keywordflow">if</span> (! peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>) {
<a name="l00989"></a>00989                                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 0, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l00990"></a>00990                                 <span class="keywordflow">return</span>;
<a name="l00991"></a>00991                         }
<a name="l00992"></a>00992                         <a class="code" href="_object_8c.html#a8460165be167be3b0816d84f498e3733" title="Casts the pointer to the Object; use this to avoid explicitly casting.">getObject</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>)-&gt;<a class="code" href="struct_object.html#aa353725933e843001d4feb03f8268121">destroy</a> = FreeVersion;
<a name="l00993"></a>00993                         len = VersionDeserialise(<a class="code" href="_version_8c.html#ae3428387ebd0bed5f378d2d0b5050d79">GetVersion</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>));
<a name="l00994"></a>00994                         <span class="keywordflow">break</span>;
<a name="l00995"></a>00995                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a1ca0c8f3ae33849b0a2c940aa99b4d19">MESSAGE_TYPE_ADDR</a>:
<a name="l00996"></a>00996                         peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a> = realloc(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>, <span class="keyword">sizeof</span>(<a class="code" href="struct_address_broadcast.html" title="Structure for AddressBroadcast objects.">AddressBroadcast</a>));
<a name="l00997"></a>00997                         <span class="keywordflow">if</span> (! peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>) {
<a name="l00998"></a>00998                                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 0, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l00999"></a>00999                                 <span class="keywordflow">return</span>;
<a name="l01000"></a>01000                         }
<a name="l01001"></a>01001                         <a class="code" href="_object_8c.html#a8460165be167be3b0816d84f498e3733" title="Casts the pointer to the Object; use this to avoid explicitly casting.">getObject</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>)-&gt;<a class="code" href="struct_object.html#aa353725933e843001d4feb03f8268121">destroy</a> = FreeAddressBroadcast;
<a name="l01002"></a>01002                         GetAddressBroadcast(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>)-&gt;timeStamps = peer-&gt;<a class="code" href="struct_peer.html#a3621dcfbd15278c25b8bc1279eab0f61">versionMessage</a>-&gt;<a class="code" href="struct_version.html#a67fae7dd1de9edce3656ed214d20377f">version</a> &gt; 31401; <span class="comment">// Timestamps start version 31402 and up.</span>
<a name="l01003"></a>01003                         len = AddressBroadcastDeserialise(GetAddressBroadcast(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>));
<a name="l01004"></a>01004                         <span class="keywordflow">break</span>;
<a name="l01005"></a>01005                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a68775d2b5fa0faa7e0a1465913f63832">MESSAGE_TYPE_INV</a>:
<a name="l01006"></a>01006                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a60a5f950b28f7fda0cadda008f3dd0fb">MESSAGE_TYPE_GETDATA</a>:
<a name="l01007"></a>01007                         peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a> = realloc(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>, <span class="keyword">sizeof</span>(InventoryBroadcast));
<a name="l01008"></a>01008                         <span class="keywordflow">if</span> (! peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>) {
<a name="l01009"></a>01009                                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 0, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l01010"></a>01010                                 <span class="keywordflow">return</span>;
<a name="l01011"></a>01011                         }
<a name="l01012"></a>01012                         <a class="code" href="_object_8c.html#a8460165be167be3b0816d84f498e3733" title="Casts the pointer to the Object; use this to avoid explicitly casting.">getObject</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>)-&gt;<a class="code" href="struct_object.html#aa353725933e843001d4feb03f8268121">destroy</a> = FreeInventoryBroadcast;
<a name="l01013"></a>01013                         len = InventoryBroadcastDeserialise(GetInventoryBroadcast(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>));
<a name="l01014"></a>01014                         <span class="keywordflow">break</span>;
<a name="l01015"></a>01015                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a71f1ccf1984513158376b467b8a8fd8f">MESSAGE_TYPE_GETBLOCKS</a>:
<a name="l01016"></a>01016                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ad72a28239ffad586624aff5a499db934">MESSAGE_TYPE_GETHEADERS</a>:
<a name="l01017"></a>01017                         peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a> = realloc(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>, <span class="keyword">sizeof</span>(<a class="code" href="struct_get_blocks.html" title="Structure for GetBlocks objects.">GetBlocks</a>));
<a name="l01018"></a>01018                         <span class="keywordflow">if</span> (! peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>) {
<a name="l01019"></a>01019                                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 0, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l01020"></a>01020                                 <span class="keywordflow">return</span>;
<a name="l01021"></a>01021                         }
<a name="l01022"></a>01022                         <a class="code" href="_object_8c.html#a8460165be167be3b0816d84f498e3733" title="Casts the pointer to the Object; use this to avoid explicitly casting.">getObject</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>)-&gt;<a class="code" href="struct_object.html#aa353725933e843001d4feb03f8268121">destroy</a> = FreeGetBlocks;
<a name="l01023"></a>01023                         len = GetBlocksDeserialise(GetGetBlocks(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>));
<a name="l01024"></a>01024                         <span class="keywordflow">break</span>;
<a name="l01025"></a>01025                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ad33de861150e172a4f14ec7ac179d419">MESSAGE_TYPE_TX</a>:
<a name="l01026"></a>01026                         peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a> = realloc(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>, <span class="keyword">sizeof</span>(<a class="code" href="struct_transaction.html">Transaction</a>));
<a name="l01027"></a>01027                         <span class="keywordflow">if</span> (! peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>) {
<a name="l01028"></a>01028                                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 0, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l01029"></a>01029                                 <span class="keywordflow">return</span>;
<a name="l01030"></a>01030                         }
<a name="l01031"></a>01031                         <a class="code" href="_object_8c.html#a8460165be167be3b0816d84f498e3733" title="Casts the pointer to the Object; use this to avoid explicitly casting.">getObject</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>)-&gt;<a class="code" href="struct_object.html#aa353725933e843001d4feb03f8268121">destroy</a> = FreeTransaction;
<a name="l01032"></a>01032                         len = TransactionDeserialise(GetTransaction(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>));
<a name="l01033"></a>01033                         <span class="keywordflow">break</span>;
<a name="l01034"></a>01034                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013aca5db57e84e42bb3fed6308f2ec8d36e">MESSAGE_TYPE_BLOCK</a>:
<a name="l01035"></a>01035                         peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a> = realloc(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>, <span class="keyword">sizeof</span>(<a class="code" href="struct_block.html" title="Base class.">Block</a>));
<a name="l01036"></a>01036                         <span class="keywordflow">if</span> (! peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>) {
<a name="l01037"></a>01037                                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 0, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l01038"></a>01038                                 <span class="keywordflow">return</span>;
<a name="l01039"></a>01039                         }
<a name="l01040"></a>01040                         <a class="code" href="_object_8c.html#a8460165be167be3b0816d84f498e3733" title="Casts the pointer to the Object; use this to avoid explicitly casting.">getObject</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>)-&gt;<a class="code" href="struct_object.html#aa353725933e843001d4feb03f8268121">destroy</a> = FreeBlock;
<a name="l01041"></a>01041                         len = BlockDeserialise(GetBlock(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>),<a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>); <span class="comment">// TRUE -&gt; Including transactions.</span>
<a name="l01042"></a>01042                         <span class="keywordflow">break</span>;
<a name="l01043"></a>01043                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ac17b04d976b7c8f35bcafa762b1e1a22">MESSAGE_TYPE_HEADERS</a>:
<a name="l01044"></a>01044                         peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a> = realloc(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>, <span class="keyword">sizeof</span>(<a class="code" href="struct_block_headers.html" title="Structure for BlockHeaders objects.">BlockHeaders</a>));
<a name="l01045"></a>01045                         <span class="keywordflow">if</span> (! peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>) {
<a name="l01046"></a>01046                                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 0, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l01047"></a>01047                                 <span class="keywordflow">return</span>;
<a name="l01048"></a>01048                         }
<a name="l01049"></a>01049                         <a class="code" href="_object_8c.html#a8460165be167be3b0816d84f498e3733" title="Casts the pointer to the Object; use this to avoid explicitly casting.">getObject</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>)-&gt;<a class="code" href="struct_object.html#aa353725933e843001d4feb03f8268121">destroy</a> = <a class="code" href="_block_headers_8c.html#a98630cb979038b4555bdefb6363af1da" title="Frees a BlockHeaders object.">freeBlockHeaders</a>;
<a name="l01050"></a>01050                         len = BlockHeadersDeserialise(GetBlockHeaders(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>));
<a name="l01051"></a>01051                         <span class="keywordflow">break</span>;
<a name="l01052"></a>01052                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a72e87e96bdee95a2bd515e751a711994">MESSAGE_TYPE_PING</a>:
<a name="l01053"></a>01053                         <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#a3621dcfbd15278c25b8bc1279eab0f61">versionMessage</a>-&gt;<a class="code" href="struct_version.html#a67fae7dd1de9edce3656ed214d20377f">version</a> &gt;= 60000 &amp;&amp; self-&gt;version &gt;= 60000){
<a name="l01054"></a>01054                                 peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a> = realloc(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>, <span class="keyword">sizeof</span>(PingPong));
<a name="l01055"></a>01055                                 <span class="keywordflow">if</span> (! peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>) {
<a name="l01056"></a>01056                                         <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 0, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l01057"></a>01057                                         <span class="keywordflow">return</span>;
<a name="l01058"></a>01058                                 }
<a name="l01059"></a>01059                                 <a class="code" href="_object_8c.html#a8460165be167be3b0816d84f498e3733" title="Casts the pointer to the Object; use this to avoid explicitly casting.">getObject</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>)-&gt;<a class="code" href="struct_object.html#aa353725933e843001d4feb03f8268121">destroy</a> = <a class="code" href="_ping_pong_message_8c.html#af528a86083fc33cb25f40d3390b1ee6d" title="Frees a PingPongMessage object.">destroyPingPongMessage</a>;
<a name="l01060"></a>01060                                 len = <a class="code" href="_ping_pong_message_8c.html#a198cd940373651273997143eab0bcde3" title="Deserialises a PingPongMessage so that it can be used as an object.">deserializePingPongMessage</a>(<a class="code" href="_ping_pong_message_8c.html#a05be54312a74799ff7996459f8f6add9" title="Gets a PingPongMessage from another object. Use this to avoid casts.">getPingPongMessage</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>));
<a name="l01061"></a>01061                         }<span class="keywordflow">else</span> len = 0;
<a name="l01062"></a>01062                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013afbac2e84f45320bd443953d336d7f5ae">MESSAGE_TYPE_PONG</a>:
<a name="l01063"></a>01063                         peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a> = realloc(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>, <span class="keyword">sizeof</span>(PingPong));
<a name="l01064"></a>01064                         <span class="keywordflow">if</span> (! peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>) {
<a name="l01065"></a>01065                                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 0, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l01066"></a>01066                                 <span class="keywordflow">return</span>;
<a name="l01067"></a>01067                         }
<a name="l01068"></a>01068                         <a class="code" href="_object_8c.html#a8460165be167be3b0816d84f498e3733" title="Casts the pointer to the Object; use this to avoid explicitly casting.">getObject</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>)-&gt;<a class="code" href="struct_object.html#aa353725933e843001d4feb03f8268121">destroy</a> = FreePingPong;
<a name="l01069"></a>01069                         len = PingPongDeserialise(<a class="code" href="_ping_pong_message_8c.html#a05be54312a74799ff7996459f8f6add9" title="Gets a PingPongMessage from another object. Use this to avoid casts.">getPingPongMessage</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>));
<a name="l01070"></a>01070                         <span class="keywordflow">break</span>;
<a name="l01071"></a>01071                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a3162346b1761cce7cacd667422618e48">MESSAGE_TYPE_ALERT</a>:
<a name="l01072"></a>01072                         peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a> = realloc(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>, <span class="keyword">sizeof</span>(<a class="code" href="struct_alert.html" title="Structure for Alert objects.">Alert</a>));
<a name="l01073"></a>01073                         <span class="keywordflow">if</span> (! peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>) {
<a name="l01074"></a>01074                                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 0, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l01075"></a>01075                                 <span class="keywordflow">return</span>;
<a name="l01076"></a>01076                         }
<a name="l01077"></a>01077                         <a class="code" href="_object_8c.html#a8460165be167be3b0816d84f498e3733" title="Casts the pointer to the Object; use this to avoid explicitly casting.">getObject</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>)-&gt;<a class="code" href="struct_object.html#aa353725933e843001d4feb03f8268121">destroy</a> = FreeAlert;
<a name="l01078"></a>01078                         len = AlertDeserialise(GetAlert(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>));
<a name="l01079"></a>01079                         <span class="keywordflow">break</span>;
<a name="l01080"></a>01080                 <span class="keywordflow">default</span>:
<a name="l01081"></a>01081                         len = 0; <span class="comment">// Zero default</span>
<a name="l01082"></a>01082                         <span class="keywordflow">break</span>;
<a name="l01083"></a>01083         }
<a name="l01084"></a>01084         <span class="comment">// Check that the deserialised message&#39;s size read matches the message length.</span>
<a name="l01085"></a>01085         <span class="keywordflow">if</span> (! peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>) {
<a name="l01086"></a>01086                 <span class="keywordflow">if</span> (len) {
<a name="l01087"></a>01087                         <span class="comment">// Error</span>
<a name="l01088"></a>01088                         <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 24_HOURS, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l01089"></a>01089                         <span class="keywordflow">return</span>;
<a name="l01090"></a>01090                 }
<a name="l01091"></a>01091         }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (len != peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>-&gt;<a class="code" href="struct_byte_array.html#aebb70c2aab3407a9f05334c47131a43b">length</a>){
<a name="l01092"></a>01092                 <span class="comment">// Error</span>
<a name="l01093"></a>01093                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 24_HOURS, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l01094"></a>01094                 <span class="keywordflow">return</span>;
<a name="l01095"></a>01095         }
<a name="l01096"></a>01096         <span class="comment">// Deserialisation was sucessful.</span>
<a name="l01097"></a>01097         <span class="comment">// Call event callback</span>
<a name="l01098"></a>01098         <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33">OnMessageReceivedAction</a> action = <span class="keyword">self</span>-&gt;onMessageReceived(self-&gt;callbackHandler,<span class="keyword">self</span>,peer);
<a name="l01099"></a>01099         <span class="keywordflow">if</span> (action == <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a73f6aac48ce0c9115366c60c688b2519">MESSAGE_ACTION_CONTINUE</a>) {
<a name="l01100"></a>01100                 <span class="comment">// Automatic responses</span>
<a name="l01101"></a>01101                 <span class="keywordflow">if</span> (self-&gt;flags &amp; <a class="code" href="_constants_8h.html#a6f2291d55f4d124937956e160c5d9792a6405a3fe5f130506115dbb845a516cbf">NETWORK_COMMUNICATOR_AUTO_HANDSHAKE</a>)
<a name="l01102"></a>01102                         <span class="comment">// Auto handshake responses</span>
<a name="l01103"></a>01103                         action = <a class="code" href="_network_communicator_8c.html#a775489ea672f9fc6b191d84a3a937f03">NetworkCommunicatorProcessMessageAutoHandshake</a>(<span class="keyword">self</span>,peer);
<a name="l01104"></a>01104                 <span class="keywordflow">if</span> (self-&gt;flags &amp; <a class="code" href="_constants_8h.html#a6f2291d55f4d124937956e160c5d9792a1d508e7b7906eb125b420b4dc2cee8b0">NETWORK_COMMUNICATOR_AUTO_DISCOVERY</a> &amp;&amp; action == <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a73f6aac48ce0c9115366c60c688b2519">MESSAGE_ACTION_CONTINUE</a>)
<a name="l01105"></a>01105                         <span class="comment">// Auto discovery responses</span>
<a name="l01106"></a>01106                         action = <a class="code" href="_network_communicator_8c.html#ac2d57ca1c8882c561500536901bd2ddd">NetworkCommunicatorProcessMessageAutoDiscovery</a>(<span class="keyword">self</span>,peer);
<a name="l01107"></a>01107                 <span class="keywordflow">if</span> (self-&gt;flags &amp; <a class="code" href="_constants_8h.html#a6f2291d55f4d124937956e160c5d9792af3482f3aaa575c480963d097692c9ba4">NETWORK_COMMUNICATOR_AUTO_PING</a> &amp;&amp; action == <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a73f6aac48ce0c9115366c60c688b2519">MESSAGE_ACTION_CONTINUE</a>)
<a name="l01108"></a>01108                         <span class="comment">// Auto ping response</span>
<a name="l01109"></a>01109                         action = <a class="code" href="_network_communicator_8c.html#a70b80eaf88abbdbd1fe270e254092275">NetworkCommunicatorProcessMessageAutoPingPong</a>(<span class="keyword">self</span>, peer);
<a name="l01110"></a>01110         }
<a name="l01111"></a>01111         <span class="comment">// Release objects and get ready for next message</span>
<a name="l01112"></a>01112         <span class="keywordflow">switch</span> (action) {
<a name="l01113"></a>01113                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a5ae2d7b83bef3af8a31290ab530223f9">MESSAGE_ACTION_DISCONNECT</a>:
<a name="l01114"></a>01114                         <span class="comment">// Node misbehaving. Disconnect.</span>
<a name="l01115"></a>01115                         <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, peer, 24_HOURS, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>);
<a name="l01116"></a>01116                         <span class="keywordflow">break</span>;
<a name="l01117"></a>01117                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a05f82ee410b5bfd548e80df10b225151">MESSAGE_ACTION_STOP</a>:
<a name="l01118"></a>01118                         <a class="code" href="_network_communicator_8c.html#a2375f2b638bfd9e11f5366cd54aeef12">NetworkCommunicatorStop</a>(<span class="keyword">self</span>);
<a name="l01119"></a>01119                         <span class="keywordflow">break</span>;
<a name="l01120"></a>01120                 <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ab81c995dde4e8570f99c0f5d64897c33a73f6aac48ce0c9115366c60c688b2519">MESSAGE_ACTION_CONTINUE</a>:
<a name="l01121"></a>01121                         <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a>);
<a name="l01122"></a>01122                         <span class="comment">// Reset variables for receiving the next message</span>
<a name="l01123"></a>01123                         peer-&gt;<a class="code" href="struct_peer.html#ac59131671a3d8f296ffc6f5ba6189def">receivedHeader</a> = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01124"></a>01124                         peer-&gt;<a class="code" href="struct_peer.html#ac6f1b57f0130723f233ad87ecbfcfb20">receive</a> = NULL;
<a name="l01125"></a>01125                 <span class="keywordflow">default</span>:
<a name="l01126"></a>01126                         <span class="keywordflow">break</span>;
<a name="l01127"></a>01127         }
<a name="l01128"></a>01128 }
<a name="l01129"></a><a class="code" href="_network_communicator_8c.html#a4aa23a88c96f0f3c30f02b711722fa1f">01129</a> <span class="keywordtype">void</span> <a class="code" href="_network_communicator_8c.html#a4aa23a88c96f0f3c30f02b711722fa1f">NetworkCommunicatorOnTimeOut</a>(<span class="keywordtype">void</span> * vself,<span class="keywordtype">void</span> * vpeer,<a class="code" href="_constants_8h.html#aeeecc1ff73a8eb187422a4c379bf64f5">TimeOutType</a> type){
<a name="l01130"></a>01130         <a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span> = vself;
<a name="l01131"></a>01131         <a class="code" href="struct_peer.html" title="Structure for Peer objects.">Peer</a> * peer = vpeer;
<a name="l01132"></a>01132         <span class="keywordflow">if</span> (type == <a class="code" href="_constants_8h.html#aeeecc1ff73a8eb187422a4c379bf64f5af43d196847bb5db46d30f486d9c06d3a">TIMEOUT_RECEIVE</a> &amp;&amp; ! peer-&gt;<a class="code" href="struct_peer.html#a83bb5a7615bbe1744dcadf6b8f7c297f">messageReceived</a> &amp;&amp; ! peer-&gt;<a class="code" href="struct_peer.html#ac59131671a3d8f296ffc6f5ba6189def">receivedHeader</a>) {
<a name="l01133"></a>01133                 <span class="comment">// Not responded</span>
<a name="l01134"></a>01134                 <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#ace34e7aeaf71b71aa83205abf9c43e58">typesExpectedNum</a>)
<a name="l01135"></a>01135                         type = <a class="code" href="_constants_8h.html#aeeecc1ff73a8eb187422a4c379bf64f5a6dbf8f4f4b049fc4081bbd3f44189456">TIMEOUT_RESPONSE</a>;
<a name="l01136"></a>01136                 <span class="keywordflow">else</span>
<a name="l01137"></a>01137                         <span class="comment">// No response expected but peer did not send any information for a long time.</span>
<a name="l01138"></a>01138                         type = <a class="code" href="_constants_8h.html#aeeecc1ff73a8eb187422a4c379bf64f5a7f9cd5cddbee622432f148f81a8a460c">TIMEOUT_NO_DATA</a>;
<a name="l01139"></a>01139         }
<a name="l01140"></a>01140         <span class="keywordflow">if</span> (<a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(peer)-&gt;<span class="keyword">public</span> &amp;&amp; <a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(peer)-&gt;ip){ <span class="comment">// Cannot take peer as address in the case where the IP is NULL</span>
<a name="l01141"></a>01141                 RetainObject(peer); <span class="comment">// Retain peer for returning to addresses list</span>
<a name="l01142"></a>01142                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>,peer, 24_HOURS, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>); <span class="comment">// Remove NetworkAddress. 1 day penalty.</span>
<a name="l01143"></a>01143         }<span class="keywordflow">else</span>
<a name="l01144"></a>01144                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>,peer, 24_HOURS, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>); <span class="comment">// Remove NetworkAddress. 1 day penalty.</span>
<a name="l01145"></a>01145         <span class="comment">// Send event for network timeout. The peer will be NULL if it wasn&#39;t retained elsewhere.</span>
<a name="l01146"></a>01146         <span class="keyword">self</span>-&gt;onTimeOut(self-&gt;callbackHandler,<span class="keyword">self</span>,peer, type);
<a name="l01147"></a>01147 }
<a name="l01148"></a><a class="code" href="_network_communicator_8c.html#a67b0329d1c08b164bc3b255bd412e355">01148</a> <span class="keywordtype">boolean</span> <a class="code" href="_network_communicator_8c.html#a67b0329d1c08b164bc3b255bd412e355">NetworkCommunicatorSendMessage</a>(<a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span>,<a class="code" href="struct_peer.html" title="Structure for Peer objects.">Peer</a> * peer,<a class="code" href="struct_message.html" title="Structure for Message objects.">Message</a> * message){
<a name="l01149"></a>01149         <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#a174a94f3843e505bba89c449f91c278d">sendQueueSize</a> == SEND_QUEUEMAX_SIZE)
<a name="l01150"></a>01150                 <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01151"></a>01151         <span class="comment">// Serialise message if needed.</span>
<a name="l01152"></a>01152         <span class="keywordflow">if</span> (! message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>) {
<a name="l01153"></a>01153                 uint32_t len;
<a name="l01154"></a>01154                 <span class="keywordflow">switch</span> (message-&gt;<a class="code" href="struct_message.html#a8a2053c7fb1adf60da2f26c06059539e">type</a>) {
<a name="l01155"></a>01155                         <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a6b5d45c74743b18c5191ca991c8424ba">MESSAGE_TYPE_VERSION</a>:
<a name="l01156"></a>01156                                 len = VersionCalculateLength(<a class="code" href="_version_8c.html#ae3428387ebd0bed5f378d2d0b5050d79">GetVersion</a>(message));
<a name="l01157"></a>01157                                 <span class="keywordflow">if</span> (! len)
<a name="l01158"></a>01158                                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01159"></a>01159                                 message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a> = NewByteArrayOfSize(len, self-&gt;onErrorReceived);
<a name="l01160"></a>01160                                 <span class="keywordflow">if</span> (! message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>)
<a name="l01161"></a>01161                                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01162"></a>01162                                 len = VersionSerialise(<a class="code" href="_version_8c.html#ae3428387ebd0bed5f378d2d0b5050d79">GetVersion</a>(message));
<a name="l01163"></a>01163                                 <span class="keywordflow">break</span>;
<a name="l01164"></a>01164                         <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a1ca0c8f3ae33849b0a2c940aa99b4d19">MESSAGE_TYPE_ADDR</a>:
<a name="l01165"></a>01165                                 <span class="comment">// &quot;AddressBroadcastCalculateLength&quot; cannot fail.</span>
<a name="l01166"></a>01166                                 message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a> = NewByteArrayOfSize(AddressBroadcastCalculateLength(GetAddressBroadcast(message)), self-&gt;onErrorReceived);
<a name="l01167"></a>01167                                 <span class="keywordflow">if</span> (! message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>)
<a name="l01168"></a>01168                                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01169"></a>01169                                 len = AddressBroadcastSerialise(GetAddressBroadcast(message));
<a name="l01170"></a>01170                                 <span class="keywordflow">break</span>;
<a name="l01171"></a>01171                         <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a68775d2b5fa0faa7e0a1465913f63832">MESSAGE_TYPE_INV</a>:
<a name="l01172"></a>01172                         <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a60a5f950b28f7fda0cadda008f3dd0fb">MESSAGE_TYPE_GETDATA</a>:
<a name="l01173"></a>01173                                 <span class="comment">// &quot;InventoryBroadcastCalculateLength&quot; cannot fail.</span>
<a name="l01174"></a>01174                                 message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a> = NewByteArrayOfSize(InventoryBroadcastCalculateLength(GetInventoryBroadcast(message)), self-&gt;onErrorReceived);
<a name="l01175"></a>01175                                 <span class="keywordflow">if</span> (! message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>)
<a name="l01176"></a>01176                                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01177"></a>01177                                 len = InventoryBroadcastSerialise(GetInventoryBroadcast(message));
<a name="l01178"></a>01178                                 <span class="keywordflow">break</span>;
<a name="l01179"></a>01179                         <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a71f1ccf1984513158376b467b8a8fd8f">MESSAGE_TYPE_GETBLOCKS</a>:
<a name="l01180"></a>01180                         <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ad72a28239ffad586624aff5a499db934">MESSAGE_TYPE_GETHEADERS</a>:
<a name="l01181"></a>01181                                 <span class="comment">// &quot;GetBlocksCalculateLength&quot; cannot fail.</span>
<a name="l01182"></a>01182                                 message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a> = NewByteArrayOfSize(GetBlocksCalculateLength(GetGetBlocks(message)), self-&gt;onErrorReceived);
<a name="l01183"></a>01183                                 <span class="keywordflow">if</span> (! message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>)
<a name="l01184"></a>01184                                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01185"></a>01185                                 len = GetBlocksSerialise(GetGetBlocks(message));
<a name="l01186"></a>01186                                 <span class="keywordflow">break</span>;
<a name="l01187"></a>01187                         <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ad33de861150e172a4f14ec7ac179d419">MESSAGE_TYPE_TX</a>:
<a name="l01188"></a>01188                                 len = TransactionCalculateLength(GetTransaction(message));
<a name="l01189"></a>01189                                 <span class="keywordflow">if</span> (! len)
<a name="l01190"></a>01190                                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01191"></a>01191                                 message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a> = NewByteArrayOfSize(len, self-&gt;onErrorReceived);
<a name="l01192"></a>01192                                 <span class="keywordflow">if</span> (! message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>)
<a name="l01193"></a>01193                                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01194"></a>01194                                 len = TransactionSerialise(GetTransaction(message));
<a name="l01195"></a>01195                                 <span class="keywordflow">break</span>;
<a name="l01196"></a>01196                         <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013aca5db57e84e42bb3fed6308f2ec8d36e">MESSAGE_TYPE_BLOCK</a>:
<a name="l01197"></a>01197                                 len = BlockCalculateLength(GetBlock(message),<a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>);
<a name="l01198"></a>01198                                 <span class="keywordflow">if</span> (! len)
<a name="l01199"></a>01199                                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01200"></a>01200                                 message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a> = NewByteArrayOfSize(len, self-&gt;onErrorReceived);
<a name="l01201"></a>01201                                 <span class="keywordflow">if</span> (! message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>)
<a name="l01202"></a>01202                                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01203"></a>01203                                 len = BlockSerialise(GetBlock(message),<a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>); <span class="comment">// TRUE -&gt; Including transactions.</span>
<a name="l01204"></a>01204                                 <span class="keywordflow">break</span>;
<a name="l01205"></a>01205                         <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013ac17b04d976b7c8f35bcafa762b1e1a22">MESSAGE_TYPE_HEADERS</a>:
<a name="l01206"></a>01206                                 <span class="comment">// &quot;BlockHeadersCalculateLength&quot; cannot fail.</span>
<a name="l01207"></a>01207                                 message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a> = NewByteArrayOfSize(BlockHeadersCalculateLength(GetBlockHeaders(message)), self-&gt;onErrorReceived);
<a name="l01208"></a>01208                                 <span class="keywordflow">if</span> (! message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>)
<a name="l01209"></a>01209                                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01210"></a>01210                                 len = BlockHeadersSerialise(GetBlockHeaders(message));
<a name="l01211"></a>01211                                 <span class="keywordflow">break</span>;
<a name="l01212"></a>01212                         <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a72e87e96bdee95a2bd515e751a711994">MESSAGE_TYPE_PING</a>:
<a name="l01213"></a>01213                                 <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#a3621dcfbd15278c25b8bc1279eab0f61">versionMessage</a>-&gt;<a class="code" href="struct_version.html#a67fae7dd1de9edce3656ed214d20377f">version</a> &gt;= 60000 &amp;&amp; self-&gt;version &gt;= 60000){
<a name="l01214"></a>01214                                         message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a> = NewByteArrayOfSize(8, self-&gt;onErrorReceived);
<a name="l01215"></a>01215                                         <span class="keywordflow">if</span> (! message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>)
<a name="l01216"></a>01216                                                 <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01217"></a>01217                                         len = PingPongSerialise(<a class="code" href="_ping_pong_message_8c.html#a05be54312a74799ff7996459f8f6add9" title="Gets a PingPongMessage from another object. Use this to avoid casts.">getPingPongMessage</a>(message));
<a name="l01218"></a>01218                                 }
<a name="l01219"></a>01219                         <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013afbac2e84f45320bd443953d336d7f5ae">MESSAGE_TYPE_PONG</a>:
<a name="l01220"></a>01220                                 message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a> = NewByteArrayOfSize(8, self-&gt;onErrorReceived);
<a name="l01221"></a>01221                                 <span class="keywordflow">if</span> (! message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>)
<a name="l01222"></a>01222                                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01223"></a>01223                                 len = PingPongSerialise(<a class="code" href="_ping_pong_message_8c.html#a05be54312a74799ff7996459f8f6add9" title="Gets a PingPongMessage from another object. Use this to avoid casts.">getPingPongMessage</a>(message));
<a name="l01224"></a>01224                                 <span class="keywordflow">break</span>;
<a name="l01225"></a>01225                         <span class="keywordflow">case</span> <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a3162346b1761cce7cacd667422618e48">MESSAGE_TYPE_ALERT</a>:
<a name="l01226"></a>01226                                 <span class="comment">// This should have been serialised before!</span>
<a name="l01227"></a>01227                                 <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01228"></a>01228                                 <span class="keywordflow">break</span>;
<a name="l01229"></a>01229                         <span class="keywordflow">default</span>:
<a name="l01230"></a>01230                                 <span class="keywordflow">break</span>;
<a name="l01231"></a>01231                 }
<a name="l01232"></a>01232                 <span class="keywordflow">if</span> (message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>) {
<a name="l01233"></a>01233                         <span class="keywordflow">if</span> (message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>-&gt;<a class="code" href="struct_byte_array.html#aebb70c2aab3407a9f05334c47131a43b">length</a> != len)
<a name="l01234"></a>01234                                 <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01235"></a>01235                 }
<a name="l01236"></a>01236         }
<a name="l01237"></a>01237         <span class="keywordflow">if</span> (message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>) {
<a name="l01238"></a>01238                 <span class="comment">// Make checksum</span>
<a name="l01239"></a>01239                 uint8_t hash[32];
<a name="l01240"></a>01240                 uint8_t hash2[32];
<a name="l01241"></a>01241                 <a class="code" href="_crypt_8c.html#a31002de62901cbe9c88a0fd0f5f57770" title="SHA-256 cryptographic hash function.">Sha256</a>(ByteArrayGetData(message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>), message-&gt;<a class="code" href="struct_message.html#affc357b616afe9b58c190ae4b21caa77">bytes</a>-&gt;<a class="code" href="struct_byte_array.html#aebb70c2aab3407a9f05334c47131a43b">length</a>, hash);
<a name="l01242"></a>01242                 <a class="code" href="_crypt_8c.html#a31002de62901cbe9c88a0fd0f5f57770" title="SHA-256 cryptographic hash function.">Sha256</a>(hash, 32, hash2);
<a name="l01243"></a>01243                 message-&gt;<a class="code" href="struct_message.html#a02d93e565ee31bda6e0211dca9b42be5">checksum</a>[0] = hash2[0];
<a name="l01244"></a>01244                 message-&gt;<a class="code" href="struct_message.html#a02d93e565ee31bda6e0211dca9b42be5">checksum</a>[1] = hash2[1];
<a name="l01245"></a>01245                 message-&gt;<a class="code" href="struct_message.html#a02d93e565ee31bda6e0211dca9b42be5">checksum</a>[2] = hash2[2];
<a name="l01246"></a>01246                 message-&gt;<a class="code" href="struct_message.html#a02d93e565ee31bda6e0211dca9b42be5">checksum</a>[3] = hash2[3];
<a name="l01247"></a>01247         }<span class="keywordflow">else</span>{
<a name="l01248"></a>01248                 <span class="comment">// Empty bytes checksum</span>
<a name="l01249"></a>01249                 message-&gt;<a class="code" href="struct_message.html#a02d93e565ee31bda6e0211dca9b42be5">checksum</a>[0] = 0x5D;
<a name="l01250"></a>01250                 message-&gt;<a class="code" href="struct_message.html#a02d93e565ee31bda6e0211dca9b42be5">checksum</a>[1] = 0xF6;
<a name="l01251"></a>01251                 message-&gt;<a class="code" href="struct_message.html#a02d93e565ee31bda6e0211dca9b42be5">checksum</a>[2] = 0xE0;
<a name="l01252"></a>01252                 message-&gt;<a class="code" href="struct_message.html#a02d93e565ee31bda6e0211dca9b42be5">checksum</a>[3] = 0xE2;
<a name="l01253"></a>01253         }
<a name="l01254"></a>01254         peer-&gt;<a class="code" href="struct_peer.html#a9f5dd03f71df9908687cab39f0b3d246">sendQueue</a>[(peer-&gt;<a class="code" href="struct_peer.html#a5de2ec8c298b8207f0b15baea86f67de">sendQueueFront</a> + peer-&gt;<a class="code" href="struct_peer.html#a174a94f3843e505bba89c449f91c278d">sendQueueSize</a>) % _SEND_QUEUEMAX_SIZE] = message; <span class="comment">// Node will send the message from this.</span>
<a name="l01255"></a>01255         <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="struct_peer.html#a174a94f3843e505bba89c449f91c278d">sendQueueSize</a> == 0){
<a name="l01256"></a>01256                 <span class="keywordtype">boolean</span> ok = SocketAddEvent(peer-&gt;<a class="code" href="struct_peer.html#a69ff2e0990f9ab719a6747dcc613ef80">sendEvent</a>, self-&gt;sendTimeOut);
<a name="l01257"></a>01257                 <span class="keywordflow">if</span> (! ok)
<a name="l01258"></a>01258                         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01259"></a>01259         }
<a name="l01260"></a>01260         peer-&gt;<a class="code" href="struct_peer.html#a174a94f3843e505bba89c449f91c278d">sendQueueSize</a>++;
<a name="l01261"></a>01261         RetainObject(message);
<a name="l01262"></a>01262         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l01263"></a>01263 }
<a name="l01264"></a><a class="code" href="_network_communicator_8c.html#a0287c6ad4ffa61f24b7ea76596f7648e">01264</a> <span class="keywordtype">void</span> <a class="code" href="_network_communicator_8c.html#a0287c6ad4ffa61f24b7ea76596f7648e">NetworkCommunicatorSendPings</a>(<span class="keywordtype">void</span> * vself){
<a name="l01265"></a>01265         <a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span> = vself;
<a name="l01266"></a>01266         <a class="code" href="struct_message.html" title="Structure for Message objects.">Message</a> * ping = NewMessageByObject(self-&gt;onErrorReceived);
<a name="l01267"></a>01267         <span class="keywordflow">if</span> (! ping)
<a name="l01268"></a>01268                 <span class="keywordflow">return</span>;
<a name="l01269"></a>01269         ping-&gt;<a class="code" href="struct_message.html#a8a2053c7fb1adf60da2f26c06059539e">type</a> = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a72e87e96bdee95a2bd515e751a711994">MESSAGE_TYPE_PING</a>;
<a name="l01270"></a>01270         <span class="keywordflow">if</span> (self-&gt;version &gt;= <a class="code" href="_constants_8h.html#aa4ebef19a712ada26c9e4227a272c89f">PONG_VERSION</a>) {
<a name="l01271"></a>01271                 PingPong * pingPong = NewPingPong(rand(), self-&gt;onErrorReceived);
<a name="l01272"></a>01272                 <a class="code" href="_message_8c.html#a9ab128ae9cafefd9b05e2e0bfa719770" title="getter">getMessage</a>(pingPong)-&gt;<a class="code" href="struct_message.html#a8a2053c7fb1adf60da2f26c06059539e">type</a> = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a72e87e96bdee95a2bd515e751a711994">MESSAGE_TYPE_PING</a>;
<a name="l01273"></a>01273                 <span class="keywordflow">for</span> (uint16_t x = 0; x &lt; <span class="keyword">self</span>-&gt;addresses-&gt;peersNum; x++) {
<a name="l01274"></a>01274                         <span class="keywordflow">if</span> (self-&gt;addresses-&gt;peers[x]-&gt;acceptedTypes &amp; <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a72e87e96bdee95a2bd515e751a711994">MESSAGE_TYPE_PING</a>){ <span class="comment">// Only send ping if they can send ping.</span>
<a name="l01275"></a>01275                                 <span class="keywordflow">if</span>(self-&gt;addresses-&gt;peers[x]-&gt;versionMessage-&gt;version &gt;= <a class="code" href="_constants_8h.html#aa4ebef19a712ada26c9e4227a272c89f">PONG_VERSION</a>){
<a name="l01276"></a>01276                                         <a class="code" href="_network_communicator_8c.html#a67b0329d1c08b164bc3b255bd412e355">NetworkCommunicatorSendMessage</a>(<span class="keyword">self</span>, self-&gt;addresses-&gt;peers[x], <a class="code" href="_message_8c.html#a9ab128ae9cafefd9b05e2e0bfa719770" title="getter">getMessage</a>(pingPong));
<a name="l01277"></a>01277                                         <a class="code" href="_message_8c.html#a9ab128ae9cafefd9b05e2e0bfa719770" title="getter">getMessage</a>(pingPong)-&gt;<a class="code" href="struct_message.html#accc3616411ea4a5035a7eaf42132d370">expectResponse</a> = <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013afbac2e84f45320bd443953d336d7f5ae">MESSAGE_TYPE_PONG</a>; <span class="comment">// Expect a pong.</span>
<a name="l01278"></a>01278                                         <span class="keyword">self</span>-&gt;addresses-&gt;peers[x]-&gt;acceptedTypes |= <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013afbac2e84f45320bd443953d336d7f5ae">MESSAGE_TYPE_PONG</a>;
<a name="l01279"></a>01279                                 }<span class="keywordflow">else</span>
<a name="l01280"></a>01280                                         <a class="code" href="_network_communicator_8c.html#a67b0329d1c08b164bc3b255bd412e355">NetworkCommunicatorSendMessage</a>(<span class="keyword">self</span>, self-&gt;addresses-&gt;peers[x], <a class="code" href="_message_8c.html#a9ab128ae9cafefd9b05e2e0bfa719770" title="getter">getMessage</a>(ping));
<a name="l01281"></a>01281                         }
<a name="l01282"></a>01282                 }
<a name="l01283"></a>01283                 <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(pingPong);
<a name="l01284"></a>01284         }<span class="keywordflow">else</span> <span class="keywordflow">for</span> (uint16_t x = 0; x &lt; <span class="keyword">self</span>-&gt;addresses-&gt;peersNum; x++)
<a name="l01285"></a>01285                 <span class="keywordflow">if</span> (self-&gt;addresses-&gt;peers[x]-&gt;acceptedTypes &amp; <a class="code" href="_constants_8h.html#ac6606ebe91c8ac66a2c314c79f5ab013a72e87e96bdee95a2bd515e751a711994">MESSAGE_TYPE_PING</a>) <span class="comment">// Only send ping if they can send ping.</span>
<a name="l01286"></a>01286                         <a class="code" href="_network_communicator_8c.html#a67b0329d1c08b164bc3b255bd412e355">NetworkCommunicatorSendMessage</a>(<span class="keyword">self</span>, self-&gt;addresses-&gt;peers[x], <a class="code" href="_message_8c.html#a9ab128ae9cafefd9b05e2e0bfa719770" title="getter">getMessage</a>(ping));
<a name="l01287"></a>01287         <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(ping);
<a name="l01288"></a>01288 }
<a name="l01289"></a><a class="code" href="_network_communicator_8c.html#a89a5c84e516ff45dcda5c68be1261700">01289</a> <span class="keywordtype">void</span> <a class="code" href="_network_communicator_8c.html#a89a5c84e516ff45dcda5c68be1261700">NetworkCommunicatorSetAddressManager</a>(<a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span>,<a class="code" href="struct_address_manager.html" title="Structure for AddressManager objects.">AddressManager</a> * addrMan){
<a name="l01290"></a>01290         RetainObject(addrMan);
<a name="l01291"></a>01291         <span class="keyword">self</span>-&gt;addresses = addrMan;
<a name="l01292"></a>01292 }
<a name="l01293"></a><a class="code" href="_network_communicator_8c.html#a9fda5199b32f5ef758fe09d1f40ff7fc">01293</a> <span class="keywordtype">void</span> <a class="code" href="_network_communicator_8c.html#a9fda5199b32f5ef758fe09d1f40ff7fc">NetworkCommunicatorSetAlternativeMessages</a>(<a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span>,<a class="code" href="struct_byte_array.html" title="Structure for ByteArray objects.">ByteArray</a> * altMessages,uint32_t * altMaxSizes){
<a name="l01294"></a>01294         <span class="keywordflow">if</span> (altMessages) RetainObject(altMessages);
<a name="l01295"></a>01295         <span class="keyword">self</span>-&gt;alternativeMessages = altMessages;
<a name="l01296"></a>01296         <span class="keyword">self</span>-&gt;altMaxSizes = altMaxSizes;
<a name="l01297"></a>01297 }
<a name="l01298"></a><a class="code" href="_network_communicator_8c.html#a54681a726bd6a2307c1f42578ccdda47">01298</a> <span class="keywordtype">void</span> <a class="code" href="_network_communicator_8c.html#a54681a726bd6a2307c1f42578ccdda47">NetworkCommunicatorSetOurIPv4</a>(<a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span>,<a class="code" href="struct_network_address.html" title="Structure for NetworkAddress objects.">NetworkAddress</a> * <a class="code" href="_network_communicator_8c.html#a7205498c8b149e4383a1abd02320d160">ourIPv4</a>){
<a name="l01299"></a>01299         RetainObject(ourIPv4);
<a name="l01300"></a>01300         <span class="keyword">self</span>-&gt;ourIPv4 = <a class="code" href="_network_communicator_8c.html#a7205498c8b149e4383a1abd02320d160">ourIPv4</a>;
<a name="l01301"></a>01301 }
<a name="l01302"></a><a class="code" href="_network_communicator_8c.html#a02d5d88a9257324842f61cdae3d1031f">01302</a> <span class="keywordtype">void</span> <a class="code" href="_network_communicator_8c.html#a02d5d88a9257324842f61cdae3d1031f">NetworkCommunicatorSetOurIPv6</a>(<a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span>,<a class="code" href="struct_network_address.html" title="Structure for NetworkAddress objects.">NetworkAddress</a> * <a class="code" href="_network_communicator_8c.html#aad277806aa44c401c56f35d707fb5b16">ourIPv6</a>){
<a name="l01303"></a>01303         RetainObject(ourIPv6);
<a name="l01304"></a>01304         <span class="keyword">self</span>-&gt;ourIPv6 = <a class="code" href="_network_communicator_8c.html#aad277806aa44c401c56f35d707fb5b16">ourIPv6</a>;
<a name="l01305"></a>01305 }
<a name="l01306"></a><a class="code" href="_network_communicator_8c.html#a2c1cdfb23e0f32fdce913b1025b36948">01306</a> <span class="keywordtype">void</span> <a class="code" href="_network_communicator_8c.html#a2c1cdfb23e0f32fdce913b1025b36948">NetworkCommunicatorSetUserAgent</a>(<a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span>,<a class="code" href="struct_byte_array.html" title="Structure for ByteArray objects.">ByteArray</a> * userAgent){
<a name="l01307"></a>01307         RetainObject(userAgent);
<a name="l01308"></a>01308         <span class="keyword">self</span>-&gt;userAgent = userAgent;
<a name="l01309"></a>01309 }
<a name="l01310"></a><a class="code" href="_network_communicator_8c.html#ae9c8bf821a71091e9d3488619e30396e">01310</a> <span class="keywordtype">boolean</span> <a class="code" href="_network_communicator_8c.html#ae9c8bf821a71091e9d3488619e30396e">NetworkCommunicatorStart</a>(<a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span>){
<a name="l01311"></a>01311         <span class="comment">// Create the socket event loop</span>
<a name="l01312"></a>01312         <span class="keywordflow">if</span> (! NewEventLoop(&amp;self-&gt;eventLoop,<a class="code" href="_network_communicator_8c.html#a6d6b433343dd2c489fbc6167a1174bdc">NetworkCommunicatorOnLoopError</a>, <a class="code" href="_network_communicator_8c.html#a4aa23a88c96f0f3c30f02b711722fa1f">NetworkCommunicatorOnTimeOut</a>, <span class="keyword">self</span>)){
<a name="l01313"></a>01313                 <span class="comment">// Cannot create event loop</span>
<a name="l01314"></a>01314                 <a class="code" href="_message_8c.html#a9ab128ae9cafefd9b05e2e0bfa719770" title="getter">getMessage</a>(<span class="keyword">self</span>)-&gt;<a class="code" href="struct_message.html#a3c8af4f580f3041d046b7581f89a9695">onErrorReceived</a>(<a class="code" href="_constants_8h.html#a2c3e4bb40f36b262a5214e2da2bca9c5a9e3fa866c434afd77b35c66fae662428">ERROR_NETWORK_COMMUNICATOR_LOOP_CREATE_FAIL</a>,<span class="stringliteral">&quot;The NetworkCommunicator event loop could not be created.&quot;</span>);
<a name="l01315"></a>01315                 <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01316"></a>01316         }
<a name="l01317"></a>01317         <span class="keyword">self</span>-&gt;isStarted = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l01318"></a>01318         <span class="keywordflow">return</span> <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>; <span class="comment">// All OK.</span>
<a name="l01319"></a>01319 }
<a name="l01320"></a><a class="code" href="_network_communicator_8c.html#ae0151ae192e007cb81d3ad7beaf1f5f8">01320</a> <span class="keywordtype">void</span> <a class="code" href="_network_communicator_8c.html#ae0151ae192e007cb81d3ad7beaf1f5f8">NetworkCommunicatorStartListening</a>(<a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span>){
<a name="l01321"></a>01321         <span class="keywordflow">if</span> (AddressManagerIsReachable(self-&gt;addresses,<a class="code" href="_constants_8h.html#aadb1cfb5fcd8adc562a07248be433d45ada1efeae8e474dedf665973081167ec3">IP_IPv4</a>)) {
<a name="l01322"></a>01322                 <span class="comment">// Create new bound IPv4 socket</span>
<a name="l01323"></a>01323                 <span class="keywordflow">if</span> (SocketBind(&amp;self-&gt;listeningSocketIPv4, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>, self-&gt;ourIPv4-&gt;port)){
<a name="l01324"></a>01324                         <span class="comment">// Add event for accepting connection for both sockets</span>
<a name="l01325"></a>01325                         <span class="keywordflow">if</span> (SocketCanAcceptEvent(&amp;self-&gt;acceptEventIPv4,self-&gt;eventLoop, self-&gt;listeningSocketIPv4, NetworkCommunicatorAcceptConnection)) {
<a name="l01326"></a>01326                                 <span class="keywordflow">if</span>(SocketAddEvent(self-&gt;acceptEventIPv4, 0)) <span class="comment">// No timeout for listening for incomming connections.</span>
<a name="l01327"></a>01327                                         <span class="comment">// Start listening on IPv4</span>
<a name="l01328"></a>01328                                         <span class="keywordflow">if</span>(SocketListen(self-&gt;listeningSocketIPv4, self-&gt;maxIncommingConnections)){
<a name="l01329"></a>01329                                                 <span class="comment">// Is listening</span>
<a name="l01330"></a>01330                                                 <span class="keyword">self</span>-&gt;isListeningIPv4 = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l01331"></a>01331                                         }
<a name="l01332"></a>01332                                 <span class="keywordflow">if</span> (! self-&gt;isListeningIPv4)
<a name="l01333"></a>01333                                         <span class="comment">// Failure to add event</span>
<a name="l01334"></a>01334                                         SocketFreeEvent(self-&gt;acceptEventIPv4);
<a name="l01335"></a>01335                         }
<a name="l01336"></a>01336                 }
<a name="l01337"></a>01337                 <span class="keywordflow">if</span> (! self-&gt;isListeningIPv4)
<a name="l01338"></a>01338                         <span class="comment">// Failure to create event</span>
<a name="l01339"></a>01339                         CloseSocket(self-&gt;listeningSocketIPv4);
<a name="l01340"></a>01340         }
<a name="l01341"></a>01341         <span class="comment">// Now for the IPv6</span>
<a name="l01342"></a>01342         <span class="keywordflow">if</span> (AddressManagerIsReachable(self-&gt;addresses,<a class="code" href="_constants_8h.html#aadb1cfb5fcd8adc562a07248be433d45a5c7c7aafd5c7ea542e80fa0367abe957">IP_IPv6</a>)) {
<a name="l01343"></a>01343                 <span class="comment">// Create new bound IPv6 socket</span>
<a name="l01344"></a>01344                 <span class="keywordflow">if</span> (SocketBind(&amp;self-&gt;listeningSocketIPv6, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>, self-&gt;ourIPv6-&gt;port)){
<a name="l01345"></a>01345                         <span class="comment">// Add event for accepting connection for both sockets</span>
<a name="l01346"></a>01346                         <span class="keywordflow">if</span> (SocketCanAcceptEvent(&amp;self-&gt;acceptEventIPv6,self-&gt;eventLoop, self-&gt;listeningSocketIPv6, NetworkCommunicatorAcceptConnection)) {
<a name="l01347"></a>01347                                 <span class="keywordflow">if</span>(SocketAddEvent(self-&gt;acceptEventIPv6, 0)) <span class="comment">// No timeout for listening for incomming connections.</span>
<a name="l01348"></a>01348                                         <span class="comment">// Start listening on IPv6</span>
<a name="l01349"></a>01349                                         <span class="keywordflow">if</span>(SocketListen(self-&gt;listeningSocketIPv6, self-&gt;maxIncommingConnections)){
<a name="l01350"></a>01350                                                 <span class="comment">// Is listening</span>
<a name="l01351"></a>01351                                                 <span class="keyword">self</span>-&gt;isListeningIPv6 = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l01352"></a>01352                                         }
<a name="l01353"></a>01353                                 <span class="keywordflow">if</span> (! self-&gt;isListeningIPv6)
<a name="l01354"></a>01354                                         <span class="comment">// Failure to add event</span>
<a name="l01355"></a>01355                                         SocketFreeEvent(self-&gt;acceptEventIPv6);
<a name="l01356"></a>01356                         }
<a name="l01357"></a>01357                 }
<a name="l01358"></a>01358                 <span class="keywordflow">if</span> (! self-&gt;isListeningIPv6)
<a name="l01359"></a>01359                         <span class="comment">// Failure to create event</span>
<a name="l01360"></a>01360                         CloseSocket(self-&gt;listeningSocketIPv6);
<a name="l01361"></a>01361         }
<a name="l01362"></a>01362 }
<a name="l01363"></a><a class="code" href="_network_communicator_8c.html#ac474e8dd4fb72e26eaf3cb0b0d716e21">01363</a> <span class="keywordtype">void</span> <a class="code" href="_network_communicator_8c.html#ac474e8dd4fb72e26eaf3cb0b0d716e21">NetworkCommunicatorStartPings</a>(<a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span>){
<a name="l01364"></a>01364         StartTimer(self-&gt;eventLoop, &amp;self-&gt;pingTimer, self-&gt;heartBeat, <a class="code" href="_network_communicator_8c.html#a0287c6ad4ffa61f24b7ea76596f7648e">NetworkCommunicatorSendPings</a>, <span class="keyword">self</span>);
<a name="l01365"></a>01365 }
<a name="l01366"></a><a class="code" href="_network_communicator_8c.html#a2375f2b638bfd9e11f5366cd54aeef12">01366</a> <span class="keywordtype">void</span> <a class="code" href="_network_communicator_8c.html#a2375f2b638bfd9e11f5366cd54aeef12">NetworkCommunicatorStop</a>(<a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span>){
<a name="l01367"></a>01367         <span class="keywordflow">if</span> (self-&gt;isListeningIPv4 || self-&gt;isListeningIPv6)
<a name="l01368"></a>01368                 <a class="code" href="_network_communicator_8c.html#a15b1332caae61f21281dc516741d9db4">NetworkCommunicatorStopListening</a>(<span class="keyword">self</span>);
<a name="l01369"></a>01369         <span class="keyword">self</span>-&gt;isStarted = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01370"></a>01370         <span class="comment">// Disconnect all the peers</span>
<a name="l01371"></a>01371         uint16_t removeNum = <span class="keyword">self</span>-&gt;addresses-&gt;peersNum; <span class="comment">// Assign to temporary variable because &quot;self-&gt;addresses-&gt;peersNum&quot; will decrement each iteration.</span>
<a name="l01372"></a>01372         <span class="keywordflow">for</span> (uint16_t x = 0; x &lt; removeNum; x++)
<a name="l01373"></a>01373                 <a class="code" href="_network_communicator_8c.html#a9f4abe6a585a711635ab6cf2aad1081e">NetworkCommunicatorDisconnect</a>(<span class="keyword">self</span>, self-&gt;addresses-&gt;peers[x], 0, <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>); <span class="comment">// &quot;TRUE&quot; we are stopping.</span>
<a name="l01374"></a>01374         <span class="comment">// Stop event loop</span>
<a name="l01375"></a>01375         ExitEventLoop(self-&gt;eventLoop);
<a name="l01376"></a>01376 }
<a name="l01377"></a><a class="code" href="_network_communicator_8c.html#a15b1332caae61f21281dc516741d9db4">01377</a> <span class="keywordtype">void</span> <a class="code" href="_network_communicator_8c.html#a15b1332caae61f21281dc516741d9db4">NetworkCommunicatorStopListening</a>(<a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span>){
<a name="l01378"></a>01378         <span class="keywordflow">if</span> (self-&gt;isListeningIPv4) {
<a name="l01379"></a>01379                 <span class="comment">// Stop listening on IPv4</span>
<a name="l01380"></a>01380                 SocketFreeEvent(self-&gt;acceptEventIPv4);
<a name="l01381"></a>01381                 CloseSocket(self-&gt;listeningSocketIPv4);
<a name="l01382"></a>01382                 <span class="keyword">self</span>-&gt;isListeningIPv4 = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01383"></a>01383         }
<a name="l01384"></a>01384         <span class="keywordflow">if</span> (self-&gt;isListeningIPv6) {
<a name="l01385"></a>01385                 <span class="comment">// Stop listening on IPv6</span>
<a name="l01386"></a>01386                 SocketFreeEvent(self-&gt;acceptEventIPv6);
<a name="l01387"></a>01387                 CloseSocket(self-&gt;listeningSocketIPv6);
<a name="l01388"></a>01388                 <span class="keyword">self</span>-&gt;isListeningIPv6 = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01389"></a>01389         }
<a name="l01390"></a>01390 }
<a name="l01391"></a><a class="code" href="_network_communicator_8c.html#ae1cb0933af1eb4fd1f53284066eff467">01391</a> <span class="keywordtype">void</span> <a class="code" href="_network_communicator_8c.html#ae1cb0933af1eb4fd1f53284066eff467">NetworkCommunicatorStopPings</a>(<a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span>){
<a name="l01392"></a>01392         <span class="keywordflow">if</span> (self-&gt;pingTimer) EndTimer(self-&gt;pingTimer);
<a name="l01393"></a>01393         <span class="keyword">self</span>-&gt;pingTimer = 0;
<a name="l01394"></a>01394 }
<a name="l01395"></a><a class="code" href="_network_communicator_8c.html#a1885c0cdbcfda108d13cf52a71bad42d">01395</a> <span class="keywordtype">void</span> <a class="code" href="_network_communicator_8c.html#a1885c0cdbcfda108d13cf52a71bad42d">NetworkCommunicatorTryConnections</a>(<a class="code" href="struct_network_communicator.html" title="Structure for NetworkCommunicator objects.">NetworkCommunicator</a> * <span class="keyword">self</span>){
<a name="l01396"></a>01396         <span class="keywordflow">if</span> (self-&gt;attemptingOrWorkingConnections &gt;= self-&gt;maxConnections) {
<a name="l01397"></a>01397                 <span class="keywordflow">return</span>; <span class="comment">// Cannot connect to any more peers</span>
<a name="l01398"></a>01398         }
<a name="l01399"></a>01399         uint16_t connectTo = <span class="keyword">self</span>-&gt;maxConnections - <span class="keyword">self</span>-&gt;attemptingOrWorkingConnections;
<a name="l01400"></a>01400         uint64_t addrNum = AddressManagerGetNumberOfAddresses(self-&gt;addresses);
<a name="l01401"></a>01401         <span class="keywordflow">if</span> (addrNum &lt; connectTo) {
<a name="l01402"></a>01402                 connectTo = addrNum; <span class="comment">// Cannot connect to any more than the address we have</span>
<a name="l01403"></a>01403         }
<a name="l01404"></a>01404         <a class="code" href="struct_network_address_locator.html" title="Structure for storing a pointer to a NetworkAddress and describing it&#39;s location in the AddressManage...">NetworkAddressLocator</a> * addrs = AddressManagerGetAddresses(self-&gt;addresses, connectTo);
<a name="l01405"></a>01405         <span class="keywordflow">for</span> (uint64_t x = 0; (addrs + x)-&gt;addr != NULL; x++) {
<a name="l01406"></a>01406                 <a class="code" href="struct_peer.html" title="Structure for Peer objects.">Peer</a> * peer = NewNodeByTakingNetworkAddress((addrs + x)-&gt;addr);
<a name="l01407"></a>01407                 <span class="keywordflow">if</span> (! peer){
<a name="l01408"></a>01408                         free(addrs);
<a name="l01409"></a>01409                         <span class="keywordflow">return</span>;
<a name="l01410"></a>01410                 }
<a name="l01411"></a>01411                 peer-&gt;<a class="code" href="struct_peer.html#ab858e455737ef40c2849eb174bb2bdc0">incomming</a> = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01412"></a>01412                 uint8_t bucketIndex = (addrs + x)-&gt;bucketIndex;
<a name="l01413"></a>01413                 uint16_t addrIndex = (addrs + x)-&gt;addrIndex;
<a name="l01414"></a>01414                 <a class="code" href="_constants_8h.html#a54234ee76fe51e3623e3e2b2fb450032">ConnectionReturn</a> res = <a class="code" href="_network_communicator_8c.html#af58f7467f49c22bab01296912d93c41c">NetworkCommunicatorConnect</a>(<span class="keyword">self</span>, peer);
<a name="l01415"></a>01415                 <span class="keywordtype">boolean</span> <span class="keyword">remove</span> = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01416"></a>01416                 <span class="keywordflow">if</span> ((res == <a class="code" href="_constants_8h.html#a54234ee76fe51e3623e3e2b2fb450032adb412025e19414ff840a039ceeb47672">CONNECT_BAD</a> || res == <a class="code" href="_constants_8h.html#a54234ee76fe51e3623e3e2b2fb450032a08463f1cee9a7f800ff2af2fe43f837d">CONNECT_FAIL</a>) &amp;&amp; <a class="code" href="_network_address_8c.html#a119da10386575374455c45ee98dd5e33" title="Gets a NetworkAddress from another object. Use this to avoid casts.">getNetworkAddress</a>(peer)-&gt;<span class="keyword">public</span>) {
<a name="l01417"></a>01417                         <span class="comment">// Convert back to address and set the pointer in the bucket.</span>
<a name="l01418"></a>01418                         (<span class="keyword">self</span>-&gt;addresses-&gt;buckets + bucketIndex)-&gt;addresses[addrIndex] = realloc(peer, <span class="keyword">sizeof</span>(<a class="code" href="struct_network_address.html" title="Structure for NetworkAddress objects.">NetworkAddress</a>));
<a name="l01419"></a>01419                         <span class="keywordflow">if</span> (! (self-&gt;addresses-&gt;buckets + bucketIndex)-&gt;addresses[addrIndex])
<a name="l01420"></a>01420                                 <span class="keyword">remove</span> = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l01421"></a>01421                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == <a class="code" href="_constants_8h.html#a54234ee76fe51e3623e3e2b2fb450032adb412025e19414ff840a039ceeb47672">CONNECT_BAD</a>)
<a name="l01422"></a>01422                                 <span class="comment">// Add penalty if bad</span>
<a name="l01423"></a>01423                                 (<span class="keyword">self</span>-&gt;addresses-&gt;buckets + bucketIndex)-&gt;addresses[addrIndex]-&gt;score -= 3600;
<a name="l01424"></a>01424                 }<span class="keywordflow">else</span> <span class="keyword">remove</span> = <a class="code" href="_constants_8h.html#a7c6368b321bd9acd0149b030bb8275edaa82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l01425"></a>01425                 <span class="keywordflow">if</span> (<span class="keyword">remove</span>){
<a name="l01426"></a>01426                         <span class="comment">// Remove from addresses becasue the connection was ok, we had a failure and we should not return the address or there is no support for this address.</span>
<a name="l01427"></a>01427                         <a class="code" href="struct_bucket.html" title="Structure for placing IP addresses such that is is difficult to obtain IPs that fall into many bucket...">Bucket</a> * bucket = (<span class="keyword">self</span>-&gt;addresses-&gt;buckets + bucketIndex);
<a name="l01428"></a>01428                         bucket-&gt;<a class="code" href="struct_bucket.html#a0a8306e0ed2f80f8411dc72fd14feb78">addrNum</a>--;
<a name="l01429"></a>01429                         <span class="keywordflow">if</span> (bucket-&gt;<a class="code" href="struct_bucket.html#a0a8306e0ed2f80f8411dc72fd14feb78">addrNum</a>) {
<a name="l01430"></a>01430                                 <span class="comment">// Move memory down.</span>
<a name="l01431"></a>01431                                 <span class="keywordflow">if</span> (bucket-&gt;<a class="code" href="struct_bucket.html#a0a8306e0ed2f80f8411dc72fd14feb78">addrNum</a> - addrIndex)
<a name="l01432"></a>01432                                         memmove(bucket-&gt;<a class="code" href="struct_bucket.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a> + addrIndex, bucket-&gt;<a class="code" href="struct_bucket.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a> + addrIndex + 1, (bucket-&gt;<a class="code" href="struct_bucket.html#a0a8306e0ed2f80f8411dc72fd14feb78">addrNum</a> - addrIndex) * <span class="keyword">sizeof</span>(*bucket-&gt;<a class="code" href="struct_bucket.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>));
<a name="l01433"></a>01433                                 <span class="comment">// Reallocate memory.</span>
<a name="l01434"></a>01434                                 <a class="code" href="struct_network_address.html" title="Structure for NetworkAddress objects.">NetworkAddress</a> ** temp = realloc(bucket-&gt;<a class="code" href="struct_bucket.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>, <span class="keyword">sizeof</span>(*bucket-&gt;<a class="code" href="struct_bucket.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a>) * bucket-&gt;<a class="code" href="struct_bucket.html#a0a8306e0ed2f80f8411dc72fd14feb78">addrNum</a>);
<a name="l01435"></a>01435                                 <span class="keywordflow">if</span> (temp)
<a name="l01436"></a>01436                                         bucket-&gt;<a class="code" href="struct_bucket.html#a144733453f7bf74cc6cdedb9e14755d6">addresses</a> = temp;
<a name="l01437"></a>01437                         }
<a name="l01438"></a>01438                         <span class="comment">// Release from addresses.</span>
<a name="l01439"></a>01439                         <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(peer);
<a name="l01440"></a>01440                 }
<a name="l01441"></a>01441                 <a class="code" href="_object_8c.html#a0407d34294cdc667982ffa9bd6f18cc9" title="Decrease the number in the reference counter. (It keeps track of how many objects have been created)...">decrementReferenceCount</a>(peer);
<a name="l01442"></a>01442         }
<a name="l01443"></a>01443         free(addrs);
<a name="l01444"></a>01444 }
<a name="l01445"></a>01445 =======
<a name="l01446"></a>01446 &gt;&gt;&gt;&gt;&gt;&gt;&gt; .r254
<a name="l01447"></a>01447 =======
<a name="l01448"></a>01448 &gt;&gt;&gt;&gt;&gt;&gt;&gt; .r277
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="_network_communicator_8c.html">NetworkCommunicator.c</a>      </li>
      <li class="footer">Generated on Wed Nov 14 2012 18:36:10 for Bitcoin by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


</body>
</html>
